<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSooq API Tester</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        /* Header - Modern SaaS Style */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .logo-container {
            background: white;
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            z-index: 1;
        }

        .logo {
            height: 40px;
            display: block;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 1;
        }

        .header h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-subtitle {
            color: rgba(255,255,255,0.85);
            font-size: 0.8rem;
            font-weight: 400;
        }

        .header-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 1;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #3498db;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        /* Main Content */
        .main-content {
            padding: 20px 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Saved APIs Tab */
        .saved-apis-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }

        /* Sections Panel */
        .sections-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1rem;
            color: #2c3e50;
        }

        .sections-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .section-item {
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .section-item:hover {
            background: #f8f9fa;
        }

        .section-item.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .section-item.dragging {
            opacity: 0.5;
        }

        .section-name {
            font-weight: 500;
            flex: 1;
        }

        .section-count {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }

        .section-actions {
            display: none;
            gap: 5px;
        }

        .section-item:hover .section-actions {
            display: flex;
        }

        .section-item:hover .section-count {
            display: none;
        }

        /* APIs Panel */
        .apis-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .apis-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .apis-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .apis-header h3 {
            font-size: 1rem;
            color: #2c3e50;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .apis-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .api-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .api-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .api-item.dragging {
            opacity: 0.5;
        }

        .api-checkbox {
            margin-right: 15px;
        }

        .api-info {
            flex: 1;
        }

        .api-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .api-curl {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 500px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .status-code {
            font-size: 12px;
            color: #7f8c8d;
        }

        .api-actions {
            display: flex;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-allure {
            background: linear-gradient(135deg, #f05b5b, #eb3d3d);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-allure:hover {
            background: linear-gradient(135deg, #eb3d3d, #d32f2f);
        }

        .allure-icon {
            background: white;
            color: #eb3d3d;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #d5dbdb;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 5px 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #7f8c8d;
            border-radius: 4px;
        }

        .btn-icon:hover {
            background: #f0f0f0;
            color: #2c3e50;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Run Bar */
        .run-bar {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .selected-count {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.modal-wide {
            max-width: 900px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Execution Logs */
        .execution-logs-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }

        .execution-logs {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 4px 0;
        }

        .log-entry.running {
            color: #3498db;
        }

        .log-entry.pass {
            color: #27ae60;
        }

        .log-entry.fail {
            color: #e74c3c;
        }

        .log-icon {
            flex-shrink: 0;
            width: 18px;
            text-align: center;
        }

        .log-entry.running .log-icon::before {
            content: "▶";
        }

        .log-entry.pass .log-icon::before {
            content: "✓";
        }

        .log-entry.fail .log-icon::before {
            content: "✗";
        }

        .log-text {
            flex: 1;
        }

        .log-time {
            color: #7f8c8d;
            font-size: 11px;
            flex-shrink: 0;
        }

        .log-reason {
            color: #95a5a6;
            font-size: 11px;
            margin-left: 28px;
            display: block;
        }

        .execution-summary {
            margin-top: 16px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #2c3e50;
        }

        .execution-summary .summary-stats {
            display: flex;
            gap: 20px;
        }

        .execution-summary .stat-passed {
            color: #27ae60;
            font-weight: 600;
        }

        .execution-summary .stat-failed {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
        }

        /* Test Result in Modal */
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .test-result h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        /* Reports Tab */
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            color: #7f8c8d;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .report-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .report-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .report-header:hover {
            background: #f8f9fa;
        }

        .report-info h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .report-meta {
            font-size: 13px;
            color: #7f8c8d;
        }

        .report-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.pass {
            color: #27ae60;
        }

        .stat-value.fail {
            color: #e74c3c;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .report-details {
            display: none;
            border-top: 1px solid #eee;
        }

        .report-details.expanded {
            display: block;
        }

        /* Module-based Reports */
        .module-group {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .module-header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .module-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .module-stats {
            display: flex;
            gap: 15px;
        }

        .module-stat {
            font-size: 0.85rem;
        }

        .module-stat.pass { color: #4ade80; }
        .module-stat.fail { color: #f87171; }

        .module-apis {
            display: none;
        }

        .module-apis.expanded {
            display: block;
        }

        .api-report-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .api-report-item:last-child {
            border-bottom: none;
        }

        .api-report-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .api-report-header:hover {
            background: #f8f9fa;
        }

        .api-report-info h5 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .api-report-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .api-report-badges {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-report-details {
            display: none;
            padding: 0 20px 20px;
            background: #f8f9fa;
        }

        .api-report-details.expanded {
            display: block;
        }

        /* Rule Logs */
        .rule-logs {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .rule-log-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 80px;
            gap: 15px;
            align-items: center;
        }

        .rule-log-item:last-child {
            border-bottom: none;
        }

        .rule-log-item.header {
            background: #ecf0f1;
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
        }

        .rule-log-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .rule-log-type {
            font-size: 11px;
            color: #7f8c8d;
        }

        .log-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #333;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-word;
        }

        .log-value.expected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .log-value.actual {
            background: #fff3e0;
            color: #e65100;
        }

        .log-value.actual.fail {
            background: #ffebee;
            color: #c62828;
        }

        .report-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Test Cases */
        .test-count.pass { color: #27ae60; font-weight: 600; }
        .test-count.fail { color: #e74c3c; font-weight: 600; }

        .test-cases-title {
            margin: 0 0 10px 0;
            padding: 10px 15px;
            background: #ecf0f1;
            font-size: 13px;
            color: #2c3e50;
            border-radius: 6px 6px 0 0;
        }

        .test-cases-list {
            background: white;
            border-radius: 0 0 6px 6px;
        }

        .test-case-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            border-left: 4px solid #27ae60;
        }

        .test-case-item:last-child {
            border-bottom: none;
        }

        .test-case-item.fail {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .test-case-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .test-case-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .test-case-item.pass .test-case-icon { color: #27ae60; }
        .test-case-item.fail .test-case-icon { color: #e74c3c; }

        .test-case-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .test-case-type {
            font-size: 11px;
            color: white;
            background: #7f8c8d;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .test-case-details {
            margin-left: 26px;
        }

        .test-case-row {
            display: flex;
            gap: 10px;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .test-case-row .label {
            color: #7f8c8d;
            min-width: 70px;
        }

        .test-case-row .value {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #2c3e50;
        }

        .test-case-row .value.expected {
            color: #27ae60;
        }

        .test-case-row .value.actual.fail {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Rules Builder */
        .rules-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .rules-section.hidden {
            display: none;
        }

        .response-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .response-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .response-meta span {
            padding: 4px 10px;
            background: #ecf0f1;
            border-radius: 4px;
        }

        .response-meta .status-ok { background: #d4edda; color: #155724; }
        .response-meta .status-error { background: #f8d7da; color: #721c24; }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rules-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rule-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .rule-card.invalid {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .rule-card.valid {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .rule-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rule-card-header .rule-number {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
        }

        .rule-card-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .rule-card-row.single {
            grid-template-columns: 1fr;
        }

        .rule-card-row label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .rule-card-row select,
        .rule-card-row input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .rule-validation-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .rule-validation-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .rule-validation-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .rules-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .empty-rules {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Create API Full Page Layout */
        .create-api-layout {
            display: grid;
            grid-template-columns: 250px 1fr 350px;
            gap: 0;
            height: calc(100vh - 180px);
            background: #f5f5f5;
        }

        .create-api-header {
            background: white;
            padding: 15px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -20px -30px 20px -30px;
        }

        .create-api-header h2 {
            font-size: 1.3rem;
            color: #2c3e50;
        }

        .create-api-header .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Left Panel */
        .left-panel {
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .left-panel h4 {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        .left-panel h4:first-child {
            margin-top: 0;
        }

        .left-panel .form-group {
            margin-bottom: 15px;
        }

        .left-panel .form-group label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .left-panel .form-group input,
        .left-panel .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-action-btn {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .quick-action-btn .icon {
            width: 20px;
            text-align: center;
        }

        .field-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }

        .field-item {
            padding: 8px 12px;
            font-size: 12px;
            font-family: monospace;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .field-item:last-child {
            border-bottom: none;
        }

        .field-item:hover {
            background: #e3f2fd;
        }

        /* Center Panel */
        .center-panel {
            padding: 20px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .curl-editor-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .curl-editor-section h4 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1rem;
        }

        .curl-editor {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            resize: vertical;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .curl-editor-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }

        .rules-section-full {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .rules-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rules-section-header h4 {
            color: #2c3e50;
            font-size: 1rem;
        }

        .rules-list-full {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rule-card-full {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            transition: all 0.2s;
        }

        .rule-card-full.valid {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .rule-card-full.invalid {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .rule-card-full .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rule-card-full .rule-header .rule-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rule-card-full .rule-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .rule-card-full .rule-fields label {
            display: block;
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .rule-card-full .rule-fields select,
        .rule-card-full .rule-fields input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .rule-card-full .validation-result {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .rule-card-full .validation-result.pass {
            background: #d4edda;
            color: #155724;
        }

        .rule-card-full .validation-result.fail {
            background: #f8d7da;
            color: #721c24;
        }

        /* Right Panel */
        .right-panel {
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .right-panel-header h4 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .response-meta-full {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .response-meta-full .meta-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .response-meta-full .meta-badge.status-ok {
            background: #d4edda;
            color: #155724;
        }

        .response-meta-full .meta-badge.status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .response-meta-full .meta-badge.neutral {
            background: #e9ecef;
            color: #495057;
        }

        .response-json {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #1e1e1e;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #d4d4d4;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .response-json.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            background: #f5f5f5;
        }

        .fields-section {
            border-top: 1px solid #eee;
            padding: 15px 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .fields-section h5 {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        /* Status Bar */
        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 10px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin: 20px -30px -20px -30px;
        }

        .status-bar .status-left {
            display: flex;
            gap: 20px;
        }

        .status-bar .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-bar .status-item.pass {
            color: #2ecc71;
        }

        .status-bar .status-item.fail {
            color: #e74c3c;
        }

        .empty-rules-full {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #e0e0e0;
        }

        .empty-rules-full p {
            margin-bottom: 15px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #27ae60;
        }

        .toast.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drag handle */
        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: #bdc3c7;
            margin-right: 10px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* ============================================= */
        /* Dashboard Styles */
        /* ============================================= */
        .dashboard-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .dashboard-title h2 {
            font-size: 1.75rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .dashboard-title p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .dashboard-actions {
            display: flex;
            gap: 12px;
        }

        .dashboard-actions .btn {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #e0e0e0;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-card-icon {
            font-size: 28px;
            margin-bottom: 12px;
            display: block;
        }

        .stat-card-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .stat-card-value {
            font-size: 36px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
        }

        /* Card Color Variants */
        .stat-card.blue::before { background: linear-gradient(180deg, #3498db, #2980b9); }
        .stat-card.blue { background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); }
        .stat-card.blue .stat-card-value { color: #2980b9; }

        .stat-card.purple::before { background: linear-gradient(180deg, #9b59b6, #8e44ad); }
        .stat-card.purple { background: linear-gradient(135deg, #ffffff 0%, #f8f0ff 100%); }
        .stat-card.purple .stat-card-value { color: #8e44ad; }

        .stat-card.orange::before { background: linear-gradient(180deg, #e67e22, #d35400); }
        .stat-card.orange { background: linear-gradient(135deg, #ffffff 0%, #fff8f0 100%); }
        .stat-card.orange .stat-card-value { color: #d35400; }

        .stat-card.green::before { background: linear-gradient(180deg, #27ae60, #1e8449); }
        .stat-card.green { background: linear-gradient(135deg, #ffffff 0%, #f0fff5 100%); }
        .stat-card.green .stat-card-value { color: #1e8449; }

        .stat-card.red::before { background: linear-gradient(180deg, #e74c3c, #c0392b); }
        .stat-card.red { background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%); }
        .stat-card.red .stat-card-value { color: #c0392b; }

        .stat-card-value.success {
            color: #27ae60;
        }

        .stat-card-value.danger {
            color: #e74c3c;
        }

        /* Dashboard Card */
        .dashboard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .dashboard-card-header {
            padding: 20px 28px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
        }

        .dashboard-card-header h3 {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-card-body {
            padding: 28px;
        }

        /* Execution Stats Row */
        .execution-stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .exec-stat-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #eee;
            transition: all 0.2s;
        }

        .exec-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .exec-stat-card.passed {
            background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
            border-color: #c8e6c9;
        }

        .exec-stat-card.failed {
            background: linear-gradient(135deg, #fff5f5 0%, #ffebee 100%);
            border-color: #ffcdd2;
        }

        .exec-stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .exec-stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
            margin-bottom: 4px;
        }

        .exec-stat-card.passed .exec-stat-value {
            color: #27ae60;
        }

        .exec-stat-card.failed .exec-stat-value {
            color: #e74c3c;
        }

        .exec-stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Run Summary Chart */
        .run-summary-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-container {
            position: relative;
        }

        .donut-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .donut-hole {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-percent {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .donut-label {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .legend-color.passed {
            background: #27ae60;
        }

        .legend-color.failed {
            background: #e74c3c;
        }

        .legend-label {
            font-size: 13px;
            color: #7f8c8d;
            min-width: 50px;
        }

        .legend-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Recent Activity Table */
        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .activity-table td {
            padding: 14px 16px;
            font-size: 14px;
            color: #2c3e50;
            border-bottom: 1px solid #f5f5f5;
        }

        .activity-table tr:last-child td {
            border-bottom: none;
        }

        .activity-table tr:hover td {
            background: #f8f9fa;
        }

        .activity-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .activity-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .activity-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .activity-time {
            color: #7f8c8d;
            font-size: 13px;
        }

        .activity-duration {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Dashboard Responsive */
        @media (max-width: 1200px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .execution-stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .execution-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .execution-stats-row {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
            }

            .dashboard-actions {
                width: 100%;
            }

            .dashboard-actions .btn {
                flex: 1;
            }

            .failed-api-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .failed-api-action {
                align-self: flex-end;
            }
        }

        /* Runtime Variables System Styles */

        /* Save Variable Modal */
        .save-var-form .form-group {
            margin-bottom: 20px;
        }

        .save-var-form label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 13px;
        }

        .field-path-display {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #7f8c8d;
            border: 1px solid #e0e0e0;
        }

        .value-preview-container {
            position: relative;
        }

        .value-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .value-type-badge.type-string { background: #27ae60; color: white; }
        .value-type-badge.type-number { background: #3498db; color: white; }
        .value-type-badge.type-boolean { background: #9b59b6; color: white; }
        .value-type-badge.type-array { background: #e67e22; color: white; }
        .value-type-badge.type-object { background: #1abc9c; color: white; }
        .value-type-badge.type-null { background: #95a5a6; color: white; }

        .value-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .var-name-input-container {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 0 12px;
            transition: border-color 0.2s;
        }

        .var-name-input-container:focus-within {
            border-color: #667eea;
        }

        .var-prefix, .var-suffix {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        .var-name-input-container input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            outline: none;
        }

        .form-hint {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            color: #7f8c8d;
        }

        /* Response Actions */
        .response-actions {
            display: flex;
            gap: 4px;
            margin-left: auto;
            margin-right: 10px;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .btn-icon:hover {
            background: #f0f0f0;
            border-color: #bbb;
            color: #333;
        }

        /* JSON Tree View Styles - Light Theme like JSON Editor Online */
        .response-json {
            background: #fff !important;
            color: #333;
        }

        .response-json.interactive {
            font-family: 'Consolas', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre;
            overflow-x: auto;
            padding: 16px;
            background: #fff;
        }

        .response-json.empty {
            background: #f5f5f5 !important;
        }

        .json-key {
            color: #881391;
            font-weight: normal;
        }

        .json-colon {
            color: #333;
        }

        .json-bracket {
            color: #333;
            font-weight: normal;
        }

        .json-comma {
            color: #333;
        }

        .json-toggle {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-size: 8px;
            margin-right: 2px;
            user-select: none;
            transition: all 0.15s;
        }

        .json-toggle:hover {
            color: #333;
        }

        .json-collapsible {
            display: inline;
        }

        .json-collapsible.collapsed {
            display: none;
        }

        .json-collapsed-placeholder {
            color: #999;
            cursor: pointer;
        }

        .json-collapsed-placeholder:hover {
            color: #666;
        }

        .json-value {
            cursor: pointer;
            padding: 0 2px;
            border-radius: 2px;
            transition: background 0.15s;
        }

        .json-value:hover {
            background: rgba(136, 19, 145, 0.1);
        }

        .json-value.json-string { color: #0b7500; }
        .json-value.json-number { color: #1a01cc; }
        .json-value.json-boolean { color: #1a01cc; }
        .json-value.json-null { color: #1a01cc; }

        /* Variables Panel */
        .variables-section {
            margin-top: 15px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .variables-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .variables-header h5 {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .var-count-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .variables-header-actions {
            display: flex;
            gap: 5px;
        }

        .var-header-btn {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .var-header-btn:hover {
            background: #f8f9fa;
            color: #e74c3c;
        }

        .variables-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .no-variables {
            color: #7f8c8d;
            font-size: 11px;
            font-style: italic;
            padding: 10px 0;
        }

        .variable-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .variable-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
        }

        .variable-type {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .variable-type.type-string { background: #e8f8f0; color: #27ae60; }
        .variable-type.type-number { background: #e8f4fd; color: #3498db; }
        .variable-type.type-boolean { background: #f3e8fd; color: #9b59b6; }
        .variable-type.type-array { background: #fdf2e8; color: #e67e22; }
        .variable-type.type-object { background: #e8fdf8; color: #1abc9c; }
        .variable-type.type-null { background: #f0f0f0; color: #95a5a6; }

        .variable-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #2c3e50;
            padding: 4px 6px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .variable-source {
            font-size: 10px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .variable-actions {
            display: flex;
            gap: 5px;
        }

        .var-action-btn {
            background: #e8f4fd;
            border: none;
            color: #3498db;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .var-action-btn:hover {
            background: #3498db;
            color: white;
        }

        .var-action-btn.delete {
            background: #fde8e8;
            color: #e74c3c;
        }

        .var-action-btn.delete:hover {
            background: #e74c3c;
            color: white;
        }

        /* cURL Variable Indicator */
        .curl-variable-indicator {
            font-size: 11px;
            padding: 6px 10px;
            margin-top: 8px;
            border-radius: 4px;
            min-height: 20px;
        }

        .curl-variable-indicator.valid {
            background: #e8f8f0;
            border: 1px solid #27ae60;
        }

        .curl-variable-indicator.has-errors {
            background: #fde8e8;
            border: 1px solid #e74c3c;
        }

        .var-indicator-found {
            color: #27ae60;
            margin-right: 15px;
        }

        .var-indicator-missing {
            color: #e74c3c;
        }

        /* Insert Variable Dropdown */
        .curl-editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .insert-variable-dropdown {
            position: relative;
        }

        #insert-variable-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        #insert-variable-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .variable-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            margin-top: 4px;
        }

        .variable-dropdown-menu.show {
            display: block;
        }

        .dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-var-name {
            display: block;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 3px;
        }

        .dropdown-var-preview {
            display: block;
            font-size: 11px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Variables Tab Styles */
        .variables-page {
            padding: 20px 30px;
        }

        .variables-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .variables-page-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .variables-description {
            flex: 1 1 100%;
            margin: 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .variables-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .variables-table {
            width: 100%;
            border-collapse: collapse;
        }

        .variables-table th,
        .variables-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .variables-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .variables-table td {
            font-size: 13px;
        }

        .variables-table .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }

        .var-value-cell {
            font-family: 'Monaco', 'Menlo', monospace;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: #f8f9fa;
            padding: 4px 8px !important;
            border-radius: 4px;
        }

        .var-name-code {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #667eea;
            font-weight: 600;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background: #f0f0f0;
        }

        /* Structured Request Editor Styles */
        .request-editor-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .request-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .request-editor-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 14px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        #import-curl-input {
            width: 100%;
            min-height: 150px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
        }

        .modal-hint {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .request-url-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .method-select {
            width: 110px;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            background: white;
            cursor: pointer;
            color: #2c3e50;
        }

        .method-select:focus {
            border-color: #667eea;
            outline: none;
        }

        .url-input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .url-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .url-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .insert-var-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .insert-var-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .insert-var-btn.small {
            padding: 6px 10px;
            font-size: 12px;
        }

        .request-section {
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .section-header h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 13px;
        }

        .section-header select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .headers-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-key,
        .header-value {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .header-key {
            max-width: 200px;
        }

        .header-key:focus,
        .header-value:focus {
            border-color: #667eea;
            outline: none;
        }

        /* Body Table (Form Data key-value pairs) */
        .body-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .body-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .body-key,
        .body-value {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .body-key {
            max-width: 200px;
        }

        .body-key:focus,
        .body-value:focus {
            border-color: #667eea;
            outline: none;
        }

        .remove-row-btn {
            background: #fee;
            color: #e74c3c;
            border: 1px solid #fcc;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-row-btn:hover {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .body-editor {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            resize: vertical;
            line-height: 1.5;
        }

        .body-editor:focus {
            border-color: #667eea;
            outline: none;
        }

        .request-variable-indicator {
            font-size: 12px;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 4px;
            min-height: 20px;
        }

        .request-variable-indicator.valid {
            background: #e8f8f0;
            border: 1px solid #27ae60;
        }

        .request-variable-indicator.has-errors {
            background: #fde8e8;
            border: 1px solid #e74c3c;
        }

        .request-variable-indicator .var-found {
            color: #27ae60;
            margin-right: 15px;
        }

        .request-variable-indicator .var-missing {
            color: #e74c3c;
        }

        .request-actions {
            margin-top: 15px;
        }

        /* Variable Picker Dropdown */
        .var-picker-dropdown {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 280px;
            max-height: 300px;
            overflow: hidden;
        }

        .var-picker-dropdown.show {
            display: block;
        }

        .var-picker-search {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .var-picker-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .var-picker-search input:focus {
            border-color: #667eea;
            outline: none;
        }

        .var-picker-list {
            max-height: 240px;
            overflow-y: auto;
        }

        .var-picker-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 13px;
        }

        .var-picker-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        .var-picker-item:last-child {
            border-bottom: none;
        }

        .var-picker-item:hover {
            background: #f8f9fa;
        }

        .var-picker-item-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            display: block;
            margin-bottom: 3px;
        }

        .var-picker-item-preview {
            font-size: 11px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
{% raw %}
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <img src="https://opensooqui2.os-cdn.com/prod/public/images/osLogo/osLogo.svg" alt="OpenSooq Logo" class="logo">
        </div>
        <div class="header-text">
            <h1>OpenSooq API Tester</h1>
            <span class="header-subtitle">Automated API Testing & Validation Platform</span>
        </div>
        <span class="header-badge">v1.0</span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="saved-apis">Saved APIs</div>
        <div class="tab" data-tab="create-api">Create API</div>
        <div class="tab" data-tab="reports">Reports</div>
        <div class="tab" data-tab="variables">Variables</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-content">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <h2>Dashboard</h2>
                        <p>Overview of your API testing activity</p>
                    </div>
                    <div class="dashboard-actions">
                        <button type="button" class="btn btn-primary" onclick="openCreateApiPage(); return false;">+ Create API</button>
                        <button type="button" class="btn btn-secondary" onclick="runAllApis(); return false;">Run All APIs</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="stat-card blue">
                        <span class="stat-card-icon">📦</span>
                        <div class="stat-card-label">Total Modules</div>
                        <div class="stat-card-value" id="dash-total-modules">0</div>
                    </div>
                    <div class="stat-card purple">
                        <span class="stat-card-icon">🔌</span>
                        <div class="stat-card-label">Total APIs</div>
                        <div class="stat-card-value" id="dash-total-apis">0</div>
                    </div>
                    <div class="stat-card orange">
                        <span class="stat-card-icon">📋</span>
                        <div class="stat-card-label">Test Cases</div>
                        <div class="stat-card-value" id="dash-total-rules">0</div>
                    </div>
                    <div class="stat-card" id="dash-status-card">
                        <span class="stat-card-icon">📊</span>
                        <div class="stat-card-label">Last Run Status</div>
                        <div class="stat-card-value" id="dash-last-status">--</div>
                    </div>
                </div>

                <!-- Last Execution Card (Full Width) -->
                <div class="dashboard-card execution-card">
                    <div class="dashboard-card-header">
                        <h3>Last Execution</h3>
                        <button type="button" class="btn btn-primary" id="view-report-btn" onclick="viewLatestReport(); return false;" style="display: none;">
                            View Full Report →
                        </button>
                    </div>
                    <div class="dashboard-card-body" id="dash-last-execution">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-text">No test runs yet. Run your APIs to see results here.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved APIs Tab -->
        <div id="saved-apis" class="tab-content">
            <div class="saved-apis-layout">
                <!-- Modules Panel -->
                <div class="sections-panel">
                    <div class="panel-header">
                        <h3>Modules</h3>
                        <button class="btn btn-primary btn-sm" onclick="openAddSectionModal()">+ Add</button>
                    </div>
                    <div class="sections-list" id="sections-list">
                        <!-- Modules loaded dynamically -->
                    </div>
                </div>

                <!-- APIs Panel -->
                <div class="apis-panel">
                    <div class="apis-header">
                        <div class="apis-header-left">
                            <h3 id="current-section-name">All APIs</h3>
                            <div class="select-all-container">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                <label for="select-all">Select All</label>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="openCreateApiPage()">+ Add API</button>
                    </div>
                    <div class="apis-list" id="apis-list">
                        <!-- APIs loaded dynamically -->
                    </div>
                    <div class="run-bar">
                        <span class="selected-count"><span id="selected-count">0</span> APIs selected</span>
                        <button class="btn btn-primary" id="run-btn" onclick="runSelectedApis()" disabled>Run Selected</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create API Tab -->
        <div id="create-api" class="tab-content">
            <div class="create-api-header">
                <h2 id="create-api-title">Create New API</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="cancelCreateApi()">Cancel</button>
                    <button class="btn btn-success" id="page-save-btn" onclick="saveApiFromPage()" disabled>Save API</button>
                </div>
            </div>

            <div class="create-api-layout">
                <!-- Left Panel -->
                <div class="left-panel">
                    <h4>API Details</h4>
                    <div class="form-group">
                        <label>Module <span style="color: #e74c3c;">*</span></label>
                        <div style="display: flex; gap: 8px;">
                            <select id="page-api-section" style="flex: 1;">
                                <!-- Populated dynamically -->
                            </select>
                            <button class="btn btn-sm" onclick="openAddModuleInline()" title="Add New Module" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
                        </div>
                        <div id="inline-add-module" style="display: none; margin-top: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="inline-module-name" placeholder="New module name..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="btn btn-sm btn-success" onclick="saveInlineModule()" style="padding: 8px 12px;">Save</button>
                                <button class="btn btn-sm" onclick="cancelInlineModule()" style="padding: 8px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>API Name <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="page-api-name" placeholder="e.g., Get User Profile" required>
                    </div>

                    <h4>Quick Add Rules</h4>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickAddRule('status_code')">
                            <span class="icon">📊</span> Status Code Check
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('response_time')">
                            <span class="icon">⏱️</span> Response Time Check
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('field_exists')">
                            <span class="icon">🔍</span> Field Exists
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('field_type')">
                            <span class="icon">🏷️</span> Field Type Check
                        </button>
                    </div>

                    <h4>Response Fields</h4>
                    <input type="text" id="page-field-search" placeholder="Search fields..." oninput="filterPageFields()" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <div class="field-list" id="page-field-list">
                        <div class="field-item" style="color: #7f8c8d; cursor: default;">Execute cURL to see fields</div>
                    </div>
                </div>

                <!-- Center Panel -->
                <div class="center-panel">
                    <!-- Structured Request Editor -->
                    <div class="request-editor-section">
                        <div class="request-editor-header">
                            <h4>Request Configuration <span style="color: #e74c3c; font-size: 12px;">*</span></h4>
                            <button class="btn btn-secondary" onclick="openImportCurlModal()">Import cURL</button>
                        </div>

                        <!-- Method & URL Row -->
                        <div class="request-url-row">
                            <select id="request-method" class="method-select">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                                <option value="HEAD">HEAD</option>
                                <option value="OPTIONS">OPTIONS</option>
                            </select>
                            <div class="url-input-wrapper">
                                <input type="text" id="request-url" placeholder="https://api.example.com/endpoint" class="url-input" oninput="updateRequestVariableIndicator()">
                                <button type="button" class="insert-var-btn" onclick="openVarPicker('request-url')" title="Insert Variable">{{</button>
                            </div>
                        </div>

                        <!-- Headers Section -->
                        <div class="request-section">
                            <div class="section-header">
                                <h5>Headers</h5>
                                <button type="button" class="btn btn-sm" onclick="addHeaderRow()">+ Add Header</button>
                            </div>
                            <div class="headers-table" id="headers-table">
                                <div class="header-row">
                                    <input type="text" placeholder="Key" class="header-key" value="Content-Type">
                                    <input type="text" placeholder="Value" class="header-value" value="application/json" oninput="updateRequestVariableIndicator()">
                                    <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                                    <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
                                </div>
                            </div>
                        </div>

                        <!-- Body Section -->
                        <div class="request-section" id="body-section" style="display: none;">
                            <div class="section-header">
                                <h5>Body</h5>
                                <select id="body-type" onchange="onBodyTypeChange()">
                                    <option value="none" selected>None</option>
                                    <option value="json">JSON</option>
                                    <option value="form">Form Data</option>
                                    <option value="raw">Raw</option>
                                </select>
                                <button type="button" class="btn btn-sm" id="add-body-row-btn" onclick="addBodyRow()" style="display: none;">+ Add Field</button>
                                <button type="button" class="insert-var-btn" id="body-var-btn" onclick="openVarPicker('request-body')" title="Insert Variable" style="display: none;">{{</button>
                            </div>
                            <!-- Form Data Key-Value Table -->
                            <div class="body-table" id="body-table" style="display: none;">
                                <div class="body-row">
                                    <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                                    <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                                    <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                                    <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                                </div>
                            </div>
                            <!-- JSON/Raw Textarea -->
                            <textarea id="request-body" class="body-editor" placeholder='{"key": "value"}' oninput="updateRequestVariableIndicator()" style="display: none;"></textarea>
                        </div>

                        <!-- Variable Indicator -->
                        <div class="request-variable-indicator" id="request-variable-indicator"></div>

                        <!-- Execute Button -->
                        <div class="request-actions">
                            <button class="btn btn-primary" onclick="executeRequest()" id="execute-request-btn">
                                Execute & Parse Response
                            </button>
                        </div>
                    </div>

                    <!-- Variable Picker Dropdown (reusable) -->
                    <div class="var-picker-dropdown" id="var-picker-dropdown">
                        <div class="var-picker-search">
                            <input type="text" id="var-picker-search-input" placeholder="Search variables..." oninput="filterVarPicker(this.value)">
                        </div>
                        <div class="var-picker-list" id="var-picker-list">
                            <div class="var-picker-empty">No variables saved yet</div>
                        </div>
                    </div>

                    <div class="rules-section-full" id="page-rules-section">
                        <!-- New Rule Builder -->
                        <div class="new-rule-builder" id="new-rule-builder" style="background: #e8f4fd; border: 2px dashed #2196f3; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: #1976d2;">Create New Test Rule <span style="color: #e74c3c; font-size: 12px;">*</span></h4>
                            <div class="rule-fields" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                                <div style="min-width: 220px; flex: 1;">
                                    <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">Rule Type</label>
                                    <select id="new-rule-type" onchange="onNewRuleTypeChange()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Select Rule Type --</option>
                                    </select>
                                </div>
                                <div id="new-rule-field-container" style="min-width: 220px; flex: 1; position: relative;">
                                    <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">Field (type to search)</label>
                                    <input type="text" id="new-rule-field-search" placeholder="Search or select field..."
                                        oninput="filterNewRuleFields()"
                                        onfocus="showFieldDropdown()"
                                        onblur="hideFieldDropdown()"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <input type="hidden" id="new-rule-field" value="">
                                    <div id="new-rule-field-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100;">
                                        <!-- Field options populated dynamically -->
                                    </div>
                                </div>
                                <div id="new-rule-config-container" style="display: flex; gap: 15px; flex-wrap: wrap; flex: 1;">
                                    <!-- Config fields populated dynamically -->
                                </div>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="testNewRule()" id="test-new-rule-btn">Test Rule</button>
                                <button class="btn btn-success" onclick="addTestedRule()" id="add-rule-btn" disabled>+ Add Rule</button>
                                <span id="new-rule-test-result" style="font-size: 13px;"></span>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #7f8c8d;">Rules must be tested and pass before they can be added.</p>
                        </div>

                        <!-- Saved Rules List -->
                        <div class="rules-section-header">
                            <h4>Saved Test Rules <span id="page-rules-count">(0)</span></h4>
                        </div>
                        <div class="rules-list-full" id="page-rules-list">
                            <div class="empty-rules-full">
                                <p>No test rules yet</p>
                                <span>Create a rule above, test it, then add it to your test cases</span>
                            </div>
                        </div>

                        <!-- Extraction Rules Section for Flow Context -->
                        <div class="extraction-rules-section" id="extraction-rules-section" style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                            <div class="extraction-rules-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0; font-size: 14px; color: #2c3e50;">Variable Extraction Rules</h4>
                                    <p style="margin: 5px 0 0; font-size: 11px; color: #7f8c8d;">Extract values from response to use in subsequent API calls (Flow execution)</p>
                                </div>
                                <button type="button" class="btn btn-sm" onclick="addExtractionRule()" style="background: #9b59b6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">+ Add Extraction</button>
                            </div>
                            <div class="extraction-rules-list" id="extraction-rules-list">
                                <div class="no-extraction-rules" style="text-align: center; padding: 20px; color: #7f8c8d; font-size: 12px; background: #f8f9fa; border-radius: 4px;">
                                    No extraction rules. Add rules to capture response values as variables for use in subsequent API calls.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="right-panel">
                    <div class="right-panel-header">
                        <h4>Response Preview</h4>
                        <div class="response-actions">
                            <button type="button" class="btn-icon" onclick="copyResponseJson()" title="Copy JSON">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button type="button" class="btn-icon" onclick="toggleAllJsonNodes(true)" title="Expand All">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <polyline points="9 21 3 21 3 15"></polyline>
                                    <line x1="21" y1="3" x2="14" y2="10"></line>
                                    <line x1="3" y1="21" x2="10" y2="14"></line>
                                </svg>
                            </button>
                            <button type="button" class="btn-icon" onclick="toggleAllJsonNodes(false)" title="Collapse All">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="4 14 10 14 10 20"></polyline>
                                    <polyline points="20 10 14 10 14 4"></polyline>
                                    <line x1="14" y1="10" x2="21" y2="3"></line>
                                    <line x1="3" y1="21" x2="10" y2="14"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="response-meta-full" id="page-response-meta">
                            <span class="meta-badge neutral">No response yet</span>
                        </div>
                    </div>
                    <div class="response-json empty" id="page-response-json">
                        <span class="empty-hint">Execute request to see response</span>
                    </div>
                    <div class="fields-section">
                        <h5>Available Fields (<span id="page-fields-count">0</span>)</h5>
                        <input type="text" id="page-field-search-right" placeholder="Search..." oninput="filterPageFieldsRight()" style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                        <div id="page-fields-list-right">
                            <span style="color: #7f8c8d; font-size: 12px;">No fields extracted yet</span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="status-bar" id="page-status-bar">
                <div class="status-left">
                    <div class="status-item" id="page-status-rules">
                        <span>Rules: 0</span>
                    </div>
                    <div class="status-item" id="page-status-validated">
                        <span>Not validated</span>
                    </div>
                </div>
                <div class="status-right">
                    <span id="page-status-message">Enter cURL command and execute to start</span>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="reports-header">
                <h2>Test Reports</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label>Module:</label>
                        <select id="filter-section" onchange="loadReports()">
                            <option value="">All Modules</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Result:</label>
                        <select id="filter-result" onchange="loadReports()">
                            <option value="">All Results</option>
                            <option value="PASS">Pass Only</option>
                            <option value="FAIL">Fail Only</option>
                        </select>
                    </div>
                    <button class="btn btn-allure" onclick="openAllureReport()">
                        <span class="allure-icon">A</span> View Allure Report
                    </button>
                </div>
            </div>
            <div class="reports-list" id="reports-list">
                <!-- Reports loaded dynamically -->
            </div>
        </div>

        <!-- Variables Tab -->
        <div id="variables" class="tab-content">
            <div class="variables-page">
                <div class="variables-page-header">
                    <h2>Saved Variables</h2>
                    <p class="variables-description">Manage persistent variables that can be used in API requests with {{variableName}} syntax.</p>
                    <button class="btn btn-primary" onclick="openAddVariableModal()">+ Add Variable</button>
                </div>

                <div class="variables-table-container">
                    <table class="variables-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Value</th>
                                <th>Type</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="variables-table-body">
                            <tr>
                                <td colspan="5" class="empty-state">No variables saved yet. Click "+ Add Variable" to create one.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Variable Modal -->
    <div class="modal-overlay" id="add-variable-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="add-variable-modal-title">Add Variable</h2>
                <button class="modal-close" onclick="closeAddVariableModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-var-name">Variable Name <span style="color: #e74c3c;">*</span></label>
                    <div class="var-name-input-container">
                        <span class="var-prefix">{{</span>
                        <input type="text" id="add-var-name" placeholder="e.g., authToken">
                        <span class="var-suffix">}}</span>
                    </div>
                    <small class="form-hint">Use letters, numbers, and underscores. Must start with a letter or underscore.</small>
                </div>
                <div class="form-group">
                    <label for="add-var-value">Value <span style="color: #e74c3c;">*</span></label>
                    <textarea id="add-var-value" rows="3" placeholder="Enter the value"></textarea>
                </div>
                <div class="form-group">
                    <label for="add-var-type">Type</label>
                    <select id="add-var-type">
                        <option value="string">String</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="object">Object/Array</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add-var-description">Description</label>
                    <input type="text" id="add-var-description" placeholder="Optional description for this variable">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddVariableModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewVariable()">Save Variable</button>
            </div>
        </div>
    </div>

    <!-- Import cURL Modal -->
    <div class="modal-overlay" id="import-curl-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Import cURL Command</h2>
                <button class="modal-close" onclick="closeImportCurlModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-hint">Paste your cURL command below. It will auto-fill the request fields so you can edit them and add variables.</p>
                <textarea id="import-curl-input" placeholder="curl -X POST 'https://api.example.com/endpoint' \
  -H 'Authorization: Bearer token' \
  -H 'Content-Type: application/json' \
  -d '{&quot;key&quot;: &quot;value&quot;}'"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeImportCurlModal()">Cancel</button>
                <button class="btn btn-primary" onclick="importCurlCommand()">Import & Fill Fields</button>
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="modal-overlay" id="section-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="section-modal-title">Add Module</h2>
                <button class="modal-close" onclick="closeSectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="section-name">Module Name</label>
                    <input type="text" id="section-name" placeholder="e.g., User APIs, Payment APIs">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSection()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit API Modal -->
    <div class="modal-overlay" id="api-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2 id="api-modal-title">Add API</h2>
                <button class="modal-close" onclick="closeApiModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="api-section">Module</label>
                    <select id="api-section">
                        <!-- Modules loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-name">API Name</label>
                    <input type="text" id="api-name" placeholder="e.g., Get User Profile">
                </div>
                <div class="form-group">
                    <label for="api-curl">cURL Command</label>
                    <textarea id="api-curl" placeholder="curl https://api.example.com/endpoint -H 'Content-Type: application/json'"></textarea>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-primary" onclick="executeAndParseCurl()" id="execute-curl-btn">Execute & Parse Response</button>
                    <button class="btn btn-secondary" onclick="copyCurlWithVariables()" title="Copy cURL with variables replaced">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy cURL
                    </button>
                </div>

                <!-- Rules Builder Section -->
                <div class="rules-section hidden" id="rules-section">
                    <div class="response-meta" id="response-meta"></div>
                    <details>
                        <summary style="cursor: pointer; margin-bottom: 10px; color: #7f8c8d;">View Response JSON</summary>
                        <div class="response-preview" id="response-preview"></div>
                    </details>

                    <div class="rules-header">
                        <h4>Test Rules</h4>
                        <button class="btn btn-sm btn-success" onclick="addRule()">+ Add Rule</button>
                    </div>

                    <div class="rules-list" id="rules-list">
                        <div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>
                    </div>

                    <div class="rules-actions">
                        <button class="btn btn-secondary" onclick="validateRules()" id="validate-rules-btn">Validate Rules</button>
                        <span id="validation-status" style="font-size: 13px; color: #7f8c8d;"></span>
                    </div>
                </div>

                <!-- Legacy test result (hidden, for backward compatibility) -->
                <div class="test-result" id="modal-test-result" style="display: none;">
                    <h4>Test Results</h4>
                    <div id="modal-rules-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApiModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveApi()" id="save-api-btn" disabled>Save API</button>
            </div>
        </div>
    </div>

    <!-- Running Modal -->
    <div class="modal-overlay" id="running-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <span id="running-status">Running tests...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Logs Modal -->
    <div class="modal-overlay" id="execution-logs-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Execution Logs</h2>
                <button class="modal-close" onclick="closeExecutionLogs()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="execution-logs-container">
                    <div class="execution-logs" id="execution-logs"></div>
                </div>
                <div class="execution-summary" id="execution-summary"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeExecutionLogs()">Close</button>
            </div>
        </div>
    </div>

    <!-- Save Variable Modal -->
    <div class="modal-overlay" id="save-variable-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Save as Variable</h2>
                <button class="modal-close" onclick="closeSaveVariableModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="save-var-form">
                    <div class="form-group">
                        <label>Field Path</label>
                        <div class="field-path-display" id="save-var-field-path">data.id</div>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <div class="value-preview-container">
                            <span class="value-type-badge" id="save-var-type-badge">string</span>
                            <pre class="value-preview" id="save-var-value-preview">"example"</pre>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="save-var-name">Variable Name <span style="color: #e74c3c;">*</span></label>
                        <div class="var-name-input-container">
                            <span class="var-prefix">{{</span>
                            <input type="text" id="save-var-name" placeholder="variableName" onkeyup="if(event.key === 'Enter') saveVariable()">
                            <span class="var-suffix">}}</span>
                        </div>
                        <small class="form-hint">Use letters, numbers, and underscores. Must start with a letter or underscore.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeSaveVariableModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveVariable()">Save Variable</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let sections = [];
        let currentSectionId = null;
        let selectedApis = new Set();
        let editingApiId = null;
        let editingSectionId = null;

        // Rules Builder State
        let ruleTypes = {};
        let customRules = [];
        let availableFields = [];
        let lastResponse = null;
        let rulesValidated = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupTabs();
            loadRuleTypes();
            await loadSections();
            await loadVariables();
            loadDashboard();
        });

        // Load rule types from backend
        async function loadRuleTypes() {
            try {
                const response = await fetch('/api/rule-types');
                const data = await response.json();
                if (data.success) {
                    ruleTypes = data.ruleTypes;
                }
            } catch (error) {
                console.error('Failed to load rule types:', error);
            }
        }

        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');

                    if (tab.dataset.tab === 'dashboard') {
                        loadDashboard();
                    } else if (tab.dataset.tab === 'reports') {
                        loadReports();
                    } else if (tab.dataset.tab === 'create-api') {
                        // Reset Create API page to default state
                        resetCreateApiPage();
                    } else if (tab.dataset.tab === 'variables') {
                        // Refresh variables when entering the tab
                        loadVariables();
                    }
                });
            });
        }

        // Reset Create API page to default empty state
        function resetCreateApiPage() {
            // Close any open modals
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            closeVarPicker();

            pageEditingApiId = null;
            pageCustomRules = [];
            pageExtractionRules = [];
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            const title = document.getElementById('create-api-title');
            const nameInput = document.getElementById('page-api-name');
            const saveBtn = document.getElementById('page-save-btn');
            const responseMeta = document.getElementById('page-response-meta');
            const responseJson = document.getElementById('page-response-json');
            const fieldsCount = document.getElementById('page-fields-count');
            const fieldsListRight = document.getElementById('page-fields-list-right');
            const fieldList = document.getElementById('page-field-list');
            const fieldSearch = document.getElementById('page-field-search');
            const fieldSearchRight = document.getElementById('page-field-search-right');

            if (title) title.textContent = 'Create New API';
            if (nameInput) nameInput.value = '';
            if (saveBtn) saveBtn.disabled = true;

            // Reset Structured Request Editor
            const methodSelect = document.getElementById('request-method');
            const urlInput = document.getElementById('request-url');
            const bodyType = document.getElementById('body-type');
            const bodyTextarea = document.getElementById('request-body');
            const headersTable = document.getElementById('headers-table');
            const bodySection = document.getElementById('body-section');
            const bodyTable = document.getElementById('body-table');
            const addBodyRowBtn = document.getElementById('add-body-row-btn');
            const bodyVarBtn = document.getElementById('body-var-btn');

            if (methodSelect) methodSelect.value = 'GET';
            if (urlInput) urlInput.value = '';
            if (bodyType) bodyType.value = 'none';
            if (bodyTextarea) {
                bodyTextarea.value = '';
                bodyTextarea.style.display = 'none';
            }
            if (bodySection) bodySection.style.display = 'none';
            if (bodyTable) bodyTable.style.display = 'none';
            if (addBodyRowBtn) addBodyRowBtn.style.display = 'none';
            if (bodyVarBtn) bodyVarBtn.style.display = 'none';

            // Reset headers table to single empty row
            if (headersTable) {
                headersTable.innerHTML = `
                    <div class="header-row">
                        <input type="text" placeholder="Key" class="header-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="header-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
                    </div>
                `;
            }

            // Reset body table to single empty row
            if (bodyTable) {
                bodyTable.innerHTML = `
                    <div class="body-row">
                        <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                    </div>
                `;
            }

            if (responseMeta) responseMeta.innerHTML = '<span class="meta-badge neutral">No response yet</span>';
            if (responseJson) {
                responseJson.textContent = 'Execute request to see response';
                responseJson.classList.add('empty');
            }
            if (fieldsCount) fieldsCount.textContent = '0';
            if (fieldsListRight) fieldsListRight.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields extracted yet</span>';
            if (fieldList) fieldList.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">Execute request to see fields</div>';
            if (fieldSearch) fieldSearch.value = '';
            if (fieldSearchRight) fieldSearchRight.value = '';

            // Hide inline module form if open
            const inlineModule = document.getElementById('inline-add-module');
            if (inlineModule) inlineModule.style.display = 'none';

            // Clear interactive JSON class
            if (responseJson) {
                responseJson.classList.remove('interactive');
            }

            renderPageRules();
            renderExtractionRules();
            updatePageStatus();
            populatePageSectionDropdown();
            initNewRuleBuilder();

            // Update variables panel and indicator
            renderVariablesPanel();
            updateRequestVariableIndicator();
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================================================
        // Sections
        // =============================================================================
        async function loadSections() {
            try {
                const response = await fetch('/api/sections');
                const data = await response.json();

                if (data.success) {
                    sections = data.sections;
                    renderSections();
                    populateSectionDropdowns();

                    if (sections.length > 0 && !currentSectionId) {
                        selectSection(sections[0].id);
                    } else if (currentSectionId) {
                        renderApis();
                    }
                }
            } catch (error) {
                showToast('Failed to load modules', 'error');
            }
        }

        function renderSections() {
            const container = document.getElementById('sections-list');

            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No modules yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sections.map(section => `
                <div class="section-item ${currentSectionId === section.id ? 'active' : ''}"
                     data-id="${section.id}"
                     draggable="true"
                     onclick="selectSection('${section.id}')">
                    <span class="drag-handle">⋮⋮</span>
                    <span class="section-name">${escapeHtml(section.name)}</span>
                    <span class="section-count">${section.apis.length}</span>
                    <div class="section-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); editSection('${section.id}')" title="Edit">✏️</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteSection('${section.id}')" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');

            setupSectionDragDrop();
        }

        function selectSection(sectionId) {
            currentSectionId = sectionId;
            renderSections();
            renderApis();

            const section = sections.find(s => s.id === sectionId);
            document.getElementById('current-section-name').textContent = section ? section.name : 'All APIs';
        }

        function openAddSectionModal() {
            editingSectionId = null;
            document.getElementById('section-modal-title').textContent = 'Add Module';
            document.getElementById('section-name').value = '';
            document.getElementById('section-modal').classList.add('active');
        }

        function editSection(sectionId) {
            editingSectionId = sectionId;
            const section = sections.find(s => s.id === sectionId);
            document.getElementById('section-modal-title').textContent = 'Edit Module';
            document.getElementById('section-name').value = section.name;
            document.getElementById('section-modal').classList.add('active');
        }

        function closeSectionModal() {
            document.getElementById('section-modal').classList.remove('active');
        }

        async function saveSection() {
            const name = document.getElementById('section-name').value.trim();

            if (!name) {
                showToast('Module name is required', 'error');
                return;
            }

            try {
                let response;
                if (editingSectionId) {
                    response = await fetch(`/api/sections/${editingSectionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                } else {
                    response = await fetch('/api/sections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(editingSectionId ? 'Module updated' : 'Module created');
                    closeSectionModal();
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save module', 'error');
            }
        }

        async function deleteSection(sectionId) {
            // Find the section name and API count for confirmation message
            const section = sections.find(s => s.id === sectionId);
            const sectionName = section ? section.name : 'this module';
            const apiCount = section ? section.apis.length : 0;

            const message = apiCount > 0
                ? `Are you sure you want to delete "${sectionName}"?\n\nThis will also delete ${apiCount} API(s) in this module.\n\nThis action cannot be undone.`
                : `Are you sure you want to delete "${sectionName}"?\n\nThis action cannot be undone.`;

            if (!confirm(message)) return;

            try {
                const response = await fetch(`/api/sections/${sectionId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast(`Module "${sectionName}" deleted successfully`);
                    if (currentSectionId === sectionId) {
                        currentSectionId = sections[0]?.id || null;
                    }
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete module', 'error');
            }
        }

        function setupSectionDragDrop() {
            const items = document.querySelectorAll('.section-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.section-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            item.parentNode.insertBefore(dragging, item);
                        } else {
                            item.parentNode.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                item.addEventListener('drop', async () => {
                    const newOrder = Array.from(document.querySelectorAll('.section-item'))
                        .map(el => el.dataset.id);

                    try {
                        await fetch('/api/sections/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sectionIds: newOrder })
                        });
                        loadSections();
                    } catch (error) {
                        showToast('Failed to reorder', 'error');
                    }
                });
            });
        }

        // =============================================================================
        // APIs
        // =============================================================================
        function renderApis() {
            const container = document.getElementById('apis-list');
            const section = sections.find(s => s.id === currentSectionId);
            const apis = section ? section.apis : [];

            if (apis.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No APIs in this section</h3>
                        <p>Click "+ Add API" or use the "Create API" tab</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = apis.map(api => {
                const rulesCount = (api.customRules || []).length;
                const hasRules = rulesCount > 0;
                return `
                <div class="api-item" data-id="${api.id}" draggable="true">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" class="api-checkbox"
                           ${selectedApis.has(api.id) ? 'checked' : ''}
                           onchange="toggleApiSelection('${api.id}')">
                    <div class="api-info">
                        <div class="api-name">
                            ${escapeHtml(api.name)}
                            ${hasRules ? `<span style="font-size: 11px; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">${rulesCount} rules</span>` : ''}
                        </div>
                        <div class="api-curl">${escapeHtml(api.curl)}</div>
                    </div>
                    <div class="api-actions">
                        <button class="btn-icon" onclick="openEditApiPage('${api.id}')" title="Edit">✏️</button>
                        <button class="btn-icon" onclick="deleteApi('${api.id}')" title="Delete">🗑️</button>
                    </div>
                </div>
            `}).join('');

            setupApiDragDrop();
            updateSelectedCount();
        }

        function toggleApiSelection(apiId) {
            if (selectedApis.has(apiId)) {
                selectedApis.delete(apiId);
            } else {
                selectedApis.add(apiId);
            }
            updateSelectedCount();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const section = sections.find(s => s.id === currentSectionId);
            const apis = section ? section.apis : [];

            if (selectAllCheckbox.checked) {
                apis.forEach(api => selectedApis.add(api.id));
            } else {
                apis.forEach(api => selectedApis.delete(api.id));
            }

            renderApis();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedApis.size;
            document.getElementById('run-btn').disabled = selectedApis.size === 0;
        }

        function populateSectionDropdowns() {
            const apiSectionSelect = document.getElementById('api-section');
            const filterSectionSelect = document.getElementById('filter-section');

            const options = sections.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');

            apiSectionSelect.innerHTML = options;
            filterSectionSelect.innerHTML = '<option value="">All Modules</option>' +
                sections.map(s => `<option value="${s.name}">${escapeHtml(s.name)}</option>`).join('');

            if (currentSectionId) {
                apiSectionSelect.value = currentSectionId;
            }
        }

        function openAddApiModal() {
            editingApiId = null;
            document.getElementById('api-modal-title').textContent = 'Add API';
            document.getElementById('api-section').value = currentSectionId || sections[0]?.id;
            document.getElementById('api-name').value = '';
            document.getElementById('api-curl').value = '';
            document.getElementById('modal-test-result').style.display = 'none';
            document.getElementById('save-api-btn').disabled = true;

            // Reset rules builder state
            customRules = [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;
            document.getElementById('rules-section').classList.add('hidden');
            document.getElementById('rules-list').innerHTML = '<div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>';
            document.getElementById('validation-status').textContent = '';

            document.getElementById('api-modal').classList.add('active');
        }

        function editApi(apiId) {
            editingApiId = apiId;
            let api, sectionId;

            for (const section of sections) {
                const found = section.apis.find(a => a.id === apiId);
                if (found) {
                    api = found;
                    sectionId = section.id;
                    break;
                }
            }

            if (!api) return;

            document.getElementById('api-modal-title').textContent = 'Edit API';
            document.getElementById('api-section').value = sectionId;
            document.getElementById('api-name').value = api.name;
            document.getElementById('api-curl').value = api.curl;
            document.getElementById('modal-test-result').style.display = 'none';
            document.getElementById('save-api-btn').disabled = false;

            // Load existing custom rules if any
            customRules = api.customRules ? JSON.parse(JSON.stringify(api.customRules)) : [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;

            // Hide rules section initially - user needs to execute curl to see it
            document.getElementById('rules-section').classList.add('hidden');
            document.getElementById('validation-status').textContent = '';

            // If there are existing rules, show a hint
            if (customRules.length > 0) {
                document.getElementById('rules-section').classList.remove('hidden');
                document.getElementById('response-meta').innerHTML = '<span>Click "Execute & Parse Response" to refresh fields and validate rules</span>';
                document.getElementById('response-preview').textContent = 'Execute cURL to see response';
                document.getElementById('validation-status').textContent = 'Re-validate rules to enable save';
                document.getElementById('validation-status').style.color = '#7f8c8d';
                document.getElementById('save-api-btn').disabled = true;
                renderRules();
            }

            document.getElementById('api-modal').classList.add('active');
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.remove('active');
            // Reset rules builder state
            customRules = [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;
        }

        async function testApiInModal() {
            // Legacy function - kept for backward compatibility
            const curl = document.getElementById('api-curl').value.trim();

            if (!curl) {
                showToast('Please enter a cURL command', 'error');
                return;
            }

            const testBtn = document.getElementById('test-api-btn');
            if (testBtn) {
                testBtn.disabled = true;
                testBtn.textContent = 'Testing...';
            }

            try {
                const response = await fetch('/api/run-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    const resultDiv = document.getElementById('modal-test-result');
                    const rulesList = document.getElementById('modal-rules-list');

                    rulesList.innerHTML = data.result.rule_results.map(rule => `
                        <div class="rule-item">
                            <span>${escapeHtml(rule.rule_name)}</span>
                            <span class="status-badge ${rule.result.toLowerCase()}">${rule.result}</span>
                        </div>
                    `).join('');

                    resultDiv.style.display = 'block';
                    document.getElementById('save-api-btn').disabled = false;
                }
            } catch (error) {
                showToast('Test failed: ' + error.message, 'error');
            }

            if (testBtn) {
                testBtn.disabled = false;
                testBtn.textContent = 'Test API';
            }
        }

        // =============================================================================
        // Rules Builder Functions
        // =============================================================================

        function copyCurlWithVariables() {
            const curl = document.getElementById('api-curl').value.trim();

            if (!curl) {
                showToast('No cURL command to copy', 'error');
                return;
            }

            // Replace variables with their values
            let processedCurl = curl;
            const varPattern = /\{\{([a-zA-Z_][a-zA-Z0-9_]*)\}\}/g;
            let match;
            let missingVars = [];

            while ((match = varPattern.exec(curl)) !== null) {
                const varName = match[1];
                if (runtimeVariables[varName]) {
                    const value = runtimeVariables[varName].value;
                    processedCurl = processedCurl.replace(new RegExp(`\\{\\{${varName}\\}\\}`, 'g'), value);
                } else {
                    missingVars.push(varName);
                }
            }

            if (missingVars.length > 0) {
                showToast(`Warning: Missing variables: ${missingVars.join(', ')}`, 'error');
            }

            navigator.clipboard.writeText(processedCurl).then(() => {
                showToast('cURL copied to clipboard' + (missingVars.length > 0 ? ' (with some variables unresolved)' : ''));
            }).catch(err => {
                showToast('Failed to copy: ' + err.message, 'error');
            });
        }

        async function executeAndParseCurl() {
            const curl = document.getElementById('api-curl').value.trim();

            if (!curl) {
                showToast('Please enter a cURL command', 'error');
                return;
            }

            const btn = document.getElementById('execute-curl-btn');
            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                const response = await fetch('/api/execute-curl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    lastResponse = data.response;
                    availableFields = data.fields || [];

                    // Show response metadata
                    const metaDiv = document.getElementById('response-meta');
                    const statusClass = data.status_code >= 200 && data.status_code < 300 ? 'status-ok' : 'status-error';
                    metaDiv.innerHTML = `
                        <span class="${statusClass}">Status: ${data.status_code}</span>
                        <span>Response Time: ${data.response_time_ms}ms</span>
                        <span>Fields Found: ${availableFields.length}</span>
                    `;

                    // Show response preview
                    const previewDiv = document.getElementById('response-preview');
                    if (data.response) {
                        previewDiv.textContent = JSON.stringify(data.response, null, 2);
                    } else {
                        previewDiv.textContent = data.response_text || 'No JSON response';
                    }

                    // Show rules section
                    document.getElementById('rules-section').classList.remove('hidden');

                    // If no custom rules exist, add a default status_code rule
                    if (customRules.length === 0) {
                        addRule('status_code');
                    } else {
                        renderRules();
                    }

                    // Save button remains disabled until rules are validated
                    document.getElementById('save-api-btn').disabled = true;
                    rulesValidated = false;
                    document.getElementById('validation-status').textContent = 'Click "Validate Rules" to enable save';
                    document.getElementById('validation-status').style.color = '#7f8c8d';

                    showToast('Response parsed successfully - validate rules to save');
                } else {
                    showToast(data.error || 'Failed to execute cURL', 'error');
                }
            } catch (error) {
                showToast('Failed to execute cURL: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Execute & Parse Response';
        }

        function generateRuleId() {
            return 'rule-' + Math.random().toString(36).substr(2, 9);
        }

        function addRule(defaultType = 'field_exists') {
            const rule = {
                id: generateRuleId(),
                type: defaultType,
                field: availableFields[0] || '',
                config: {},
                enabled: true
            };

            // Set default config values
            const typeConfig = ruleTypes[defaultType];
            if (typeConfig && typeConfig.configFields) {
                typeConfig.configFields.forEach(cf => {
                    if (cf.default !== undefined) {
                        rule.config[cf.name] = cf.default;
                    }
                });
            }

            customRules.push(rule);
            rulesValidated = false;
            renderRules();
        }

        function removeRule(ruleId) {
            customRules = customRules.filter(r => r.id !== ruleId);
            rulesValidated = false;
            renderRules();
        }

        function updateRule(ruleId, field, value) {
            const rule = customRules.find(r => r.id === ruleId);
            if (!rule) return;

            if (field === 'type') {
                rule.type = value;
                // Reset config to defaults for new type
                rule.config = {};
                const typeConfig = ruleTypes[value];
                if (typeConfig && typeConfig.configFields) {
                    typeConfig.configFields.forEach(cf => {
                        if (cf.default !== undefined) {
                            rule.config[cf.name] = cf.default;
                        }
                    });
                }
                // Clear field if not required
                if (typeConfig && !typeConfig.requiresField) {
                    rule.field = '';
                } else if (!rule.field && availableFields.length > 0) {
                    rule.field = availableFields[0];
                }
            } else if (field === 'field') {
                rule.field = value;
            } else {
                // Config field
                rule.config[field] = value;
            }

            rulesValidated = false;
            renderRules();
        }

        function renderRules() {
            const container = document.getElementById('rules-list');

            if (customRules.length === 0) {
                container.innerHTML = '<div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>';
                document.getElementById('validation-status').textContent = '';
                return;
            }

            container.innerHTML = customRules.map((rule, index) => {
                const typeConfig = ruleTypes[rule.type] || {};
                const requiresField = typeConfig.requiresField !== false;

                return `
                    <div class="rule-card" id="rule-card-${rule.id}">
                        <div class="rule-card-header">
                            <span class="rule-number">Rule ${index + 1}</span>
                            <button class="btn-icon" onclick="removeRule('${rule.id}')" title="Remove">🗑️</button>
                        </div>
                        <div class="rule-card-row">
                            <div>
                                <label>Rule Type</label>
                                <select onchange="updateRule('${rule.id}', 'type', this.value)">
                                    ${Object.entries(ruleTypes).map(([key, config]) =>
                                        `<option value="${key}" ${rule.type === key ? 'selected' : ''}>${config.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ${requiresField ? `
                            <div>
                                <label>Field</label>
                                <select onchange="updateRule('${rule.id}', 'field', this.value)">
                                    ${availableFields.map(f =>
                                        `<option value="${f}" ${rule.field === f ? 'selected' : ''}>${f}</option>`
                                    ).join('')}
                                    ${rule.field && !availableFields.includes(rule.field) ?
                                        `<option value="${rule.field}" selected>${rule.field}</option>` : ''}
                                </select>
                            </div>
                            ` : '<div></div>'}
                        </div>
                        ${renderConfigFields(rule)}
                    </div>
                `;
            }).join('');

            // Update validation status
            if (!rulesValidated) {
                document.getElementById('validation-status').textContent = 'Rules not validated yet';
            }
        }

        function renderConfigFields(rule) {
            const typeConfig = ruleTypes[rule.type];
            if (!typeConfig || !typeConfig.configFields || typeConfig.configFields.length === 0) {
                return '';
            }

            const fields = typeConfig.configFields.map(cf => {
                const value = rule.config[cf.name] !== undefined ? rule.config[cf.name] : cf.default;

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updateRule('${rule.id}', '${cf.name}', this.value)">
                                ${cf.options.map(opt =>
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updateRule('${rule.id}', '${cf.name}', this.value === 'true')">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="number" value="${value}"
                                   onchange="updateRule('${rule.id}', '${cf.name}', parseInt(this.value) || 0)">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="text" value="${escapeHtml(value || '')}"
                                   onchange="updateRule('${rule.id}', '${cf.name}', this.value)">
                        </div>
                    `;
                }
            });

            return `<div class="rule-card-row ${fields.length === 1 ? 'single' : ''}">${fields.join('')}</div>`;
        }

        async function validateRules() {
            if (customRules.length === 0) {
                showToast('Add at least one rule first', 'error');
                return;
            }

            const btn = document.getElementById('validate-rules-btn');
            btn.disabled = true;
            btn.textContent = 'Validating...';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: document.getElementById('api-curl').value.trim(),
                        rules: customRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update rule cards with validation results
                    data.results.forEach(result => {
                        const card = document.getElementById(`rule-card-${result.rule_id}`);
                        if (card) {
                            card.classList.remove('valid', 'invalid');
                            card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                            // Add or update status badge
                            let statusBadge = card.querySelector('.rule-validation-status');
                            if (!statusBadge) {
                                statusBadge = document.createElement('span');
                                statusBadge.className = 'rule-validation-status';
                                card.querySelector('.rule-card-header').appendChild(statusBadge);
                            }
                            statusBadge.className = `rule-validation-status ${result.result.toLowerCase()}`;
                            statusBadge.textContent = result.result === 'PASS' ?
                                `✓ ${result.actual || 'PASS'}` :
                                `✗ ${result.reason || 'FAIL'}`;
                        }
                    });

                    const allPassed = data.results.every(r => r.result === 'PASS');
                    rulesValidated = allPassed;

                    document.getElementById('validation-status').textContent =
                        allPassed ?
                        `✓ All ${data.results.length} rules passed` :
                        `${data.results.filter(r => r.result === 'PASS').length}/${data.results.length} rules passed`;
                    document.getElementById('validation-status').style.color = allPassed ? '#27ae60' : '#e74c3c';

                    // Only enable save button if all rules pass
                    document.getElementById('save-api-btn').disabled = !allPassed;

                    showToast(allPassed ? 'All rules validated successfully!' : 'Some rules failed - fix them to save');
                } else {
                    showToast(data.error || 'Validation failed', 'error');
                }
            } catch (error) {
                showToast('Validation failed: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Validate Rules';
        }

        async function saveApi() {
            const sectionId = document.getElementById('api-section').value;
            const name = document.getElementById('api-name').value.trim();
            const curl = document.getElementById('api-curl').value.trim();

            if (!name) {
                showToast('API name is required', 'error');
                return;
            }
            if (!curl) {
                showToast('cURL command is required', 'error');
                return;
            }

            // Prepare API data with custom rules
            const apiData = {
                name,
                curl,
                customRules: customRules.length > 0 ? customRules : []
            };

            try {
                let response;
                if (editingApiId) {
                    response = await fetch(`/api/apis/${editingApiId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });

                    // Check if section changed
                    let currentSection;
                    for (const section of sections) {
                        if (section.apis.find(a => a.id === editingApiId)) {
                            currentSection = section.id;
                            break;
                        }
                    }

                    if (currentSection !== sectionId) {
                        await fetch(`/api/apis/${editingApiId}/move`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetSectionId: sectionId })
                        });
                    }
                } else {
                    response = await fetch(`/api/sections/${sectionId}/apis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    const rulesCount = customRules.length;
                    showToast(editingApiId ?
                        `API updated with ${rulesCount} rule(s)` :
                        `API created with ${rulesCount} rule(s)`);
                    closeApiModal();
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save API', 'error');
            }
        }

        async function deleteApi(apiId) {
            // Find the API name for confirmation message
            let apiName = 'this API';
            for (const section of sections) {
                const api = section.apis.find(a => a.id === apiId);
                if (api) {
                    apiName = api.name;
                    break;
                }
            }

            if (!confirm(`Are you sure you want to delete "${apiName}"?\n\nThis action cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/apis/${apiId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast(`API "${apiName}" deleted successfully`);
                    selectedApis.delete(apiId);
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete API', 'error');
            }
        }

        function setupApiDragDrop() {
            const items = document.querySelectorAll('.api-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.api-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            item.parentNode.insertBefore(dragging, item);
                        } else {
                            item.parentNode.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                item.addEventListener('drop', async () => {
                    const newOrder = Array.from(document.querySelectorAll('.api-item'))
                        .map(el => el.dataset.id);

                    try {
                        await fetch(`/api/sections/${currentSectionId}/apis/reorder`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ apiIds: newOrder })
                        });
                        loadSections();
                    } catch (error) {
                        showToast('Failed to reorder', 'error');
                    }
                });
            });
        }

        // =============================================================================
        // Run APIs
        // =============================================================================
        async function runSelectedApis() {
            if (selectedApis.size === 0) return;

            document.getElementById('running-modal').classList.add('active');
            document.getElementById('running-status').textContent = `Running ${selectedApis.size} API(s)...`;

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiIds: Array.from(selectedApis) })
                });

                const data = await response.json();

                document.getElementById('running-modal').classList.remove('active');

                if (data.success) {
                    const passed = data.report.passed;
                    const failed = data.report.failed;
                    showToast(`Tests complete: ${passed} passed, ${failed} failed`);

                    selectedApis.clear();
                    loadSections();

                    // Switch to reports tab
                    document.querySelector('.tab[data-tab="reports"]').click();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                document.getElementById('running-modal').classList.remove('active');
                showToast('Failed to run tests: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // Reports
        // =============================================================================

        async function openAllureReport() {
            try {
                // First, try to generate the Allure report
                const response = await fetch('/api/allure/generate', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    // Open the Allure report in a new tab
                    window.open(data.reportUrl, '_blank');
                } else {
                    showToast(data.error || 'Failed to generate Allure report', 'error');
                }
            } catch (error) {
                showToast('Failed to open Allure report: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // Create API Page Functions
        // =============================================================================

        let pageEditingApiId = null;
        let pageCustomRules = [];
        let pageExtractionRules = [];  // For flow context variable extraction
        let pageAvailableFields = [];
        let pageLastResponse = null;
        let pageRulesValidated = false;

        // Runtime Variables System
        let runtimeVariables = {};  // { varName: { value, type, source: { apiName, fieldPath, timestamp } } }
        let savedVariables = [];    // Variables loaded from backend
        let editingVariableId = null;  // For edit mode
        let varPickerTargetInput = null;  // For variable picker

        // =============================================================================
        // Variables Tab Functions
        // =============================================================================

        async function loadVariables() {
            try {
                const response = await fetch('/api/variables');
                const data = await response.json();
                if (data.success) {
                    savedVariables = data.variables || [];
                    // Sync to runtimeVariables for use in requests
                    runtimeVariables = {};
                    savedVariables.forEach(v => {
                        runtimeVariables[v.name] = {
                            value: v.value,
                            type: v.type,
                            source: v.source
                        };
                    });
                    renderVariablesTable();
                }
            } catch (error) {
                console.error('Failed to load variables:', error);
            }
        }

        function renderVariablesTable() {
            const tbody = document.getElementById('variables-table-body');
            if (!tbody) return;

            if (savedVariables.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No variables saved yet. Click "+ Add Variable" to create one.</td></tr>';
                return;
            }

            tbody.innerHTML = savedVariables.map(v => {
                const displayValue = truncateValue(v.value, 40);
                const sourceName = v.source ? (v.source.apiName || 'Manual') : 'Manual';
                return `
                    <tr>
                        <td><span class="var-name-code">{{${escapeHtml(v.name)}}}</span></td>
                        <td><span class="var-value-cell">${escapeHtml(displayValue)}</span></td>
                        <td><span class="type-badge type-${v.type}">${v.type}</span></td>
                        <td>${escapeHtml(sourceName)}</td>
                        <td>
                            <button class="btn-icon" onclick="editVariableInModal('${v.id}')" title="Edit">✏️</button>
                            <button class="btn-icon" onclick="deleteVariableFromBackend('${v.id}')" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function truncateValue(value, maxLen = 50) {
            const str = typeof value === 'object' ? JSON.stringify(value) : String(value);
            return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
        }

        function openAddVariableModal() {
            editingVariableId = null;
            document.getElementById('add-variable-modal-title').textContent = 'Add Variable';
            document.getElementById('add-var-name').value = '';
            document.getElementById('add-var-value').value = '';
            document.getElementById('add-var-type').value = 'string';
            document.getElementById('add-var-description').value = '';
            document.getElementById('add-variable-modal').classList.add('active');
            document.getElementById('add-var-name').focus();
        }

        function closeAddVariableModal() {
            document.getElementById('add-variable-modal').classList.remove('active');
            editingVariableId = null;
        }

        function editVariableInModal(varId) {
            const variable = savedVariables.find(v => v.id === varId);
            if (!variable) return;

            editingVariableId = varId;
            document.getElementById('add-variable-modal-title').textContent = 'Edit Variable';
            document.getElementById('add-var-name').value = variable.name;
            document.getElementById('add-var-value').value = typeof variable.value === 'object' ? JSON.stringify(variable.value, null, 2) : variable.value;
            document.getElementById('add-var-type').value = variable.type || 'string';
            document.getElementById('add-var-description').value = variable.description || '';
            document.getElementById('add-variable-modal').classList.add('active');
            document.getElementById('add-var-name').focus();
        }

        async function saveNewVariable() {
            const name = document.getElementById('add-var-name').value.trim();
            let value = document.getElementById('add-var-value').value;
            const type = document.getElementById('add-var-type').value;
            const description = document.getElementById('add-var-description').value.trim();

            if (!name) {
                showToast('Variable name is required', 'error');
                return;
            }

            if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(name)) {
                showToast('Invalid variable name. Use only letters, numbers, and underscores.', 'error');
                return;
            }

            // Parse value based on type
            if (type === 'number') {
                value = parseFloat(value);
                if (isNaN(value)) {
                    showToast('Invalid number value', 'error');
                    return;
                }
            } else if (type === 'boolean') {
                value = value.toLowerCase() === 'true';
            } else if (type === 'object') {
                try {
                    value = JSON.parse(value);
                } catch (e) {
                    showToast('Invalid JSON for object type', 'error');
                    return;
                }
            }

            try {
                const url = editingVariableId ? `/api/variables/${editingVariableId}` : '/api/variables';
                const method = editingVariableId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, value, type, description })
                });

                const data = await response.json();

                if (data.success) {
                    closeAddVariableModal();
                    await loadVariables();
                    showToast(editingVariableId ? 'Variable updated' : 'Variable saved');
                } else {
                    showToast(data.error || 'Failed to save variable', 'error');
                }
            } catch (error) {
                showToast('Failed to save variable: ' + error.message, 'error');
            }
        }

        async function deleteVariableFromBackend(varId) {
            if (!confirm('Delete this variable?')) return;

            try {
                const response = await fetch(`/api/variables/${varId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    await loadVariables();
                    showToast('Variable deleted');
                } else {
                    showToast(data.error || 'Failed to delete variable', 'error');
                }
            } catch (error) {
                showToast('Failed to delete variable: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // Structured Request Editor Functions
        // =============================================================================

        function addHeaderRow() {
            const table = document.getElementById('headers-table');
            const row = document.createElement('div');
            row.className = 'header-row';
            row.innerHTML = `
                <input type="text" placeholder="Key" class="header-key">
                <input type="text" placeholder="Value" class="header-value" oninput="updateRequestVariableIndicator()">
                <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
            `;
            table.appendChild(row);
        }

        function removeHeaderRow(btn) {
            const row = btn.closest('.header-row');
            const table = document.getElementById('headers-table');
            if (table.querySelectorAll('.header-row').length > 1) {
                row.remove();
            } else {
                row.querySelector('.header-key').value = '';
                row.querySelector('.header-value').value = '';
            }
            updateRequestVariableIndicator();
        }

        function getHeadersFromTable() {
            const rows = document.querySelectorAll('#headers-table .header-row');
            const headers = {};
            rows.forEach(row => {
                const key = row.querySelector('.header-key').value.trim();
                const value = row.querySelector('.header-value').value.trim();
                if (key) headers[key] = value;
            });
            return headers;
        }

        // Body Row Functions (for Form Data key-value pairs)
        function addBodyRow() {
            const table = document.getElementById('body-table');
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
            `;
            table.appendChild(row);
        }

        function removeBodyRow(btn) {
            const row = btn.closest('.body-row');
            const table = document.getElementById('body-table');
            if (table.querySelectorAll('.body-row').length > 1) {
                row.remove();
            } else {
                row.querySelector('.body-key').value = '';
                row.querySelector('.body-value').value = '';
            }
            updateRequestVariableIndicator();
        }

        function getBodyFromTable() {
            const rows = document.querySelectorAll('#body-table .body-row');
            const parts = [];
            rows.forEach((row) => {
                const key = row.querySelector('.body-key').value.trim();
                const value = row.querySelector('.body-value').value.trim();
                // Don't encode here - variables like {{Draft_id}} need to be replaced first
                if (key) parts.push(`${key}=${value}`);
            });
            return parts.join('&');
        }

        function populateBodyTable(body) {
            const table = document.getElementById('body-table');
            const pairs = body.split('&').map(pair => {
                const [key, ...valueParts] = pair.split('=');
                return {
                    key: decodeURIComponent(key || '').trim(),
                    value: decodeURIComponent(valueParts.join('=') || '').trim()
                };
            }).filter(p => p.key);

            if (pairs.length > 0) {
                table.innerHTML = pairs.map(({key, value}) => `
                    <div class="body-row">
                        <input type="text" placeholder="Key" class="body-key" value="${escapeHtml(key)}" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="body-value" value="${escapeHtml(value)}" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                    </div>
                `).join('');
            } else {
                table.innerHTML = `
                    <div class="body-row">
                        <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                    </div>
                `;
            }
        }

        // Import cURL Modal Functions
        function openImportCurlModal() {
            document.getElementById('import-curl-modal').classList.add('active');
            document.getElementById('import-curl-input').value = '';
            setTimeout(() => {
                document.getElementById('import-curl-input').focus();
            }, 100);
        }

        function closeImportCurlModal() {
            document.getElementById('import-curl-modal').classList.remove('active');
        }

        function importCurlCommand() {
            const curlInput = document.getElementById('import-curl-input').value.trim();
            if (!curlInput) {
                showToast('Please paste a cURL command', 'error');
                return;
            }

            // Validate it looks like a cURL command
            if (!curlInput.toLowerCase().startsWith('curl')) {
                showToast('Invalid cURL command. Must start with "curl"', 'error');
                return;
            }

            // Use existing parser function
            parseCurlToEditor(curlInput);
            closeImportCurlModal();
            showToast('cURL imported! You can now edit fields and insert variables.');
        }

        // Parse a cURL command and populate the Structured Request Editor (Postman-like)
        function parseCurlToEditor(curlCommand) {
            if (!curlCommand) return;

            // Clear previous response data when importing new cURL
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            // Reset response display
            const responseMeta = document.getElementById('page-response-meta');
            const responseJson = document.getElementById('page-response-json');
            const fieldsCount = document.getElementById('page-fields-count');

            if (responseMeta) {
                responseMeta.innerHTML = '';
            }
            if (responseJson) {
                responseJson.classList.add('empty');
                responseJson.classList.remove('interactive');
                responseJson.innerHTML = '<span class="empty-hint">Execute request to see response</span>';
            }
            if (fieldsCount) {
                fieldsCount.textContent = '0';
            }

            // Refresh field lists to show empty state
            renderPageFieldsList();

            // Normalize the cURL command (handle line continuations)
            let curl = curlCommand
                .replace(/\\\r?\n/g, ' ')   // Handle backslash line continuations
                .replace(/\s+/g, ' ')        // Normalize whitespace
                .trim();

            // Default values
            let method = 'GET';
            let url = '';
            const headers = {};
            let body = '';

            // 1. Parse Method (-X or --request)
            const methodMatch = curl.match(/-X\s+['"]?(\w+)['"]?/i) ||
                                curl.match(/--request\s+['"]?(\w+)['"]?/i);
            if (methodMatch) {
                method = methodMatch[1].toUpperCase();
            }

            // 2. Parse URL (various formats)
            const urlPatterns = [
                /curl\s+['"]?(https?:\/\/[^'"<>\s]+)['"]?/i,      // curl 'url' or curl url
                /['"]?(https?:\/\/[^'"<>\s]+)['"]?/i,             // url anywhere
                /--url\s+['"]?(https?:\/\/[^'"<>\s]+)['"]?/i,     // --url 'url'
            ];

            for (const pattern of urlPatterns) {
                const match = curl.match(pattern);
                if (match) {
                    url = match[1];
                    break;
                }
            }

            // 3. Parse Headers (-H or --header) - improved regex
            const headerPatterns = [
                /-H\s+'([^:]+):\s*([^']+)'/g,           // -H 'Key: Value'
                /-H\s+"([^:]+):\s*([^"]+)"/g,           // -H "Key: Value"
                /--header\s+'([^:]+):\s*([^']+)'/g,     // --header 'Key: Value'
                /--header\s+"([^:]+):\s*([^"]+)"/g,     // --header "Key: Value"
            ];

            for (const pattern of headerPatterns) {
                let match;
                // Reset lastIndex for global regex
                pattern.lastIndex = 0;
                while ((match = pattern.exec(curl)) !== null) {
                    const key = match[1].trim();
                    const value = match[2].trim();
                    if (key && !headers[key]) {
                        headers[key] = value;
                    }
                }
            }

            // 4. Parse Body Data (-d, --data, --data-raw, --data-binary, --data-urlencode)
            // First, collect all --data-urlencode entries
            const urlencodePattern = /--data-urlencode\s+['"]?([^'"]+)['"]?/g;
            const urlencodeParts = [];
            let urlencodeMatch;
            while ((urlencodeMatch = urlencodePattern.exec(curl)) !== null) {
                urlencodeParts.push(urlencodeMatch[1]);
            }
            if (urlencodeParts.length > 0) {
                body = urlencodeParts.join('&');
            }

            // Then check for regular -d/--data (only if no --data-urlencode found)
            if (!body) {
                // Use global patterns to find ALL -d entries (some cURLs have multiple)
                const allDataPattern = /(?:-d|--data|--data-raw)\s+['"]([^'"]+)['"]/g;
                const dataParts = [];
                let dataMatch;
                while ((dataMatch = allDataPattern.exec(curl)) !== null) {
                    let data = dataMatch[1]
                        .replace(/\\'/g, "'")
                        .replace(/\\"/g, '"')
                        .replace(/\\\\/g, '\\');
                    dataParts.push(data);
                }

                if (dataParts.length > 0) {
                    // If it looks like JSON, take the first one
                    if (dataParts[0].trim().startsWith('{') || dataParts[0].trim().startsWith('[')) {
                        body = dataParts[0];
                    } else {
                        // Otherwise combine as form data
                        body = dataParts.join('&');
                    }
                }
            }

            // 5. Parse Form Data (--form or -F) - multipart form data
            if (!body) {
                const formMap = new Map(); // Use Map to prevent duplicate keys

                // Single comprehensive pattern for --form and -F
                const formPattern = /(?:--form|-F)\s+['"]?([^=\s'"]+)=["']?([^'"}\s]*)["']?['"]?/g;
                let match;
                while ((match = formPattern.exec(curl)) !== null) {
                    const key = match[1].trim();
                    let value = match[2].trim();
                    // Remove surrounding quotes if present
                    value = value.replace(/^["']|["']$/g, '');
                    formMap.set(key, value); // Map prevents duplicates automatically
                }

                if (formMap.size > 0) {
                    body = Array.from(formMap.entries()).map(([k, v]) => `${k}=${v}`).join('&');
                }
            }

            // If body exists and no explicit method, default to POST
            if (body && method === 'GET') {
                method = 'POST';
            }

            // --- Populate the Editor ---

            // Method
            document.getElementById('request-method').value = method;

            // URL
            document.getElementById('request-url').value = url;

            // Headers Table
            const headersTable = document.getElementById('headers-table');
            const headerEntries = Object.entries(headers);

            if (headerEntries.length > 0) {
                headersTable.innerHTML = headerEntries.map(([key, value]) => `
                    <div class="header-row">
                        <input type="text" placeholder="Key" class="header-key" value="${escapeHtml(key)}" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="header-value" value="${escapeHtml(value)}" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
                    </div>
                `).join('');
            } else {
                headersTable.innerHTML = `
                    <div class="header-row">
                        <input type="text" placeholder="Key" class="header-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="header-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
                    </div>
                `;
            }

            // Body
            const bodySection = document.getElementById('body-section');
            const bodyTypeSelect = document.getElementById('body-type');
            const bodyTextarea = document.getElementById('request-body');
            const bodyTable = document.getElementById('body-table');
            const addBodyRowBtn = document.getElementById('add-body-row-btn');
            const bodyVarBtn = document.getElementById('body-var-btn');

            if (body) {
                // Detect body type
                let bodyType = 'raw';
                try {
                    JSON.parse(body);
                    bodyType = 'json';
                } catch {
                    if (body.includes('=') && !body.includes('{') && !body.includes('[')) {
                        bodyType = 'form';
                    }
                }

                bodyTypeSelect.value = bodyType;
                bodySection.style.display = 'block';

                if (bodyType === 'form') {
                    // Populate body table with key-value pairs
                    populateBodyTable(body);
                    bodyTable.style.display = 'block';
                    bodyTextarea.style.display = 'none';
                    bodyTextarea.value = '';  // Clear textarea to prevent duplicate
                    addBodyRowBtn.style.display = 'inline-block';
                    bodyVarBtn.style.display = 'none';
                } else {
                    // JSON or Raw - use textarea
                    bodyTextarea.value = body;
                    bodyTextarea.style.display = 'block';
                    bodyTable.style.display = 'none';
                    // Clear body table to prevent duplicate
                    bodyTable.innerHTML = `
                        <div class="body-row">
                            <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                            <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                            <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                            <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                        </div>
                    `;
                    addBodyRowBtn.style.display = 'none';
                    bodyVarBtn.style.display = 'inline-block';
                }
            } else {
                bodyTypeSelect.value = 'none';
                bodyTextarea.value = '';
                bodyTextarea.style.display = 'none';
                bodyTable.style.display = 'none';
                // Reset body table
                bodyTable.innerHTML = `
                    <div class="body-row">
                        <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                    </div>
                `;
                addBodyRowBtn.style.display = 'none';
                bodyVarBtn.style.display = 'none';
                bodySection.style.display = 'none';
            }

            updateRequestVariableIndicator();
        }

        function onBodyTypeChange() {
            const bodyType = document.getElementById('body-type').value;
            const bodyTextarea = document.getElementById('request-body');
            const bodyTable = document.getElementById('body-table');
            const addBodyRowBtn = document.getElementById('add-body-row-btn');
            const bodyVarBtn = document.getElementById('body-var-btn');
            const bodySection = document.getElementById('body-section');

            if (bodyType === 'none') {
                bodyTextarea.style.display = 'none';
                bodyTable.style.display = 'none';
                addBodyRowBtn.style.display = 'none';
                bodyVarBtn.style.display = 'none';
                bodySection.style.display = 'none';
            } else if (bodyType === 'form') {
                // Show key-value table for Form Data
                bodyTextarea.style.display = 'none';
                bodyTable.style.display = 'block';
                addBodyRowBtn.style.display = 'inline-block';
                bodyVarBtn.style.display = 'none';
                bodySection.style.display = 'block';
            } else {
                // Show textarea for JSON/Raw
                bodyTextarea.style.display = 'block';
                bodyTable.style.display = 'none';
                addBodyRowBtn.style.display = 'none';
                bodyVarBtn.style.display = 'inline-block';
                bodySection.style.display = 'block';
                if (bodyType === 'json') {
                    bodyTextarea.placeholder = '{"key": "value"}';
                } else {
                    bodyTextarea.placeholder = 'Raw body content';
                }
            }
            updateRequestVariableIndicator();
        }

        function buildCurlCommand(method, url, headers, body, bodyType) {
            let curl = `curl -X ${method} '${url}'`;

            // Check if Content-Type header exists (case-insensitive)
            const hasContentType = Object.keys(headers).some(k => k.toLowerCase() === 'content-type');

            // Add Content-Type header if body exists and no Content-Type is set
            if (body && bodyType !== 'none' && !hasContentType) {
                if (bodyType === 'form') {
                    curl += ` -H 'Content-Type: application/x-www-form-urlencoded'`;
                } else if (bodyType === 'json') {
                    curl += ` -H 'Content-Type: application/json'`;
                }
            }

            for (const [key, value] of Object.entries(headers)) {
                curl += ` -H '${key}: ${value}'`;
            }
            if (body && bodyType !== 'none') {
                // Escape single quotes in body
                const escapedBody = body.replace(/'/g, "'\\''");
                curl += ` -d '${escapedBody}'`;
            }
            return curl;
        }

        // Get the current cURL command from the Structured Request Editor
        function getCurrentCurlCommand() {
            const method = document.getElementById('request-method')?.value || 'GET';
            const url = document.getElementById('request-url')?.value?.trim() || '';
            const headers = getHeadersFromTable();
            const bodyType = document.getElementById('body-type')?.value || 'none';

            // Get body from table if form type, otherwise from textarea
            let body = '';
            if (bodyType === 'form') {
                body = getBodyFromTable();
            } else {
                body = document.getElementById('request-body')?.value || '';
            }

            if (!url) return '';
            return buildCurlCommand(method, url, headers, body, bodyType);
        }

        async function executeRequest() {
            const method = document.getElementById('request-method').value;
            const url = document.getElementById('request-url').value.trim();
            const headers = getHeadersFromTable();
            const bodyType = document.getElementById('body-type').value;

            // Get body from table if form type, otherwise from textarea
            let body = '';
            if (bodyType === 'form') {
                body = getBodyFromTable();
            } else {
                body = document.getElementById('request-body').value;
            }

            if (!url) {
                showToast('URL is required', 'error');
                return;
            }

            // Validate variables in all fields
            const allText = url + Object.values(headers).join(' ') + body;
            const validation = validateVariablesInText(allText);

            if (!validation.valid) {
                showToast(`Missing variables: ${validation.missing.map(v => '{{' + v + '}}').join(', ')}`, 'error');
                return;
            }

            // Replace variables
            const processedUrl = replaceVariables(url).text;
            const processedHeaders = {};
            for (const [key, value] of Object.entries(headers)) {
                processedHeaders[replaceVariables(key).text] = replaceVariables(value).text;
            }
            const processedBody = replaceVariables(body).text;

            // Build cURL command
            const curl = buildCurlCommand(method, processedUrl, processedHeaders, processedBody, bodyType);

            const btn = document.getElementById('execute-request-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Executing...';
            }

            try {
                const response = await fetch('/api/execute-curl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    pageLastResponse = data.response;
                    pageAvailableFields = data.fields || [];

                    // Update response meta
                    const statusClass = data.status_code >= 200 && data.status_code < 300 ? 'status-ok' : 'status-error';
                    const responseMeta = document.getElementById('page-response-meta');
                    if (responseMeta) {
                        responseMeta.innerHTML = `
                            <span class="meta-badge ${statusClass}">Status: ${data.status_code}</span>
                            <span class="meta-badge neutral">${data.response_time_ms}ms</span>
                        `;
                    }

                    // Update response JSON with interactive rendering
                    const jsonDiv = document.getElementById('page-response-json');
                    if (jsonDiv) {
                        jsonDiv.classList.remove('empty');
                        if (data.response) {
                            jsonDiv.classList.add('interactive');
                            jsonNodeCounter = 0; // Reset counter for new response
                            jsonDiv.innerHTML = renderInteractiveJson(data.response);
                        } else {
                            jsonDiv.classList.remove('interactive');
                            jsonDiv.textContent = data.response_text || 'No JSON response';
                        }
                    }

                    // Update fields count and list
                    const fieldsCount = document.getElementById('page-fields-count');
                    if (fieldsCount) {
                        fieldsCount.textContent = pageAvailableFields.length;
                    }
                    renderPageFieldsList();

                    pageRulesValidated = false;
                    const saveBtn = document.getElementById('page-save-btn');
                    if (saveBtn) {
                        saveBtn.disabled = true;
                    }

                    updatePageStatus();
                    showToast('Response parsed. Click on values to save as variables.');
                } else {
                    showToast(data.error || 'Failed to execute request', 'error');
                }
            } catch (error) {
                console.error('executeRequest error:', error);
                showToast('Failed to execute request: ' + error.message, 'error');
            }

            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Execute & Parse Response';
            }
        }

        function updateRequestVariableIndicator() {
            const url = document.getElementById('request-url')?.value || '';
            const headers = getHeadersFromTable();
            const body = document.getElementById('request-body')?.value || '';

            const allText = url + Object.values(headers).join(' ') + body;
            const indicator = document.getElementById('request-variable-indicator');

            if (!indicator) return;

            const validation = validateVariablesInText(allText);

            if (validation.found.length === 0 && validation.missing.length === 0) {
                indicator.innerHTML = '';
                indicator.className = 'request-variable-indicator';
                return;
            }

            let html = '';
            if (validation.found.length > 0) {
                html += `<span class="var-found">Variables: ${validation.found.map(v => '{{' + v + '}}').join(', ')}</span>`;
            }
            if (validation.missing.length > 0) {
                html += `<span class="var-missing">Missing: ${validation.missing.map(v => '{{' + v + '}}').join(', ')}</span>`;
            }

            indicator.innerHTML = html;
            indicator.className = 'request-variable-indicator ' + (validation.missing.length > 0 ? 'has-errors' : 'valid');
        }

        // =============================================================================
        // Variable Picker Functions
        // =============================================================================

        function openVarPicker(inputId) {
            varPickerTargetInput = document.getElementById(inputId);
            showVarPicker(event.target);
        }

        function openVarPickerForRow(btn, type) {
            let row;
            if (type === 'body') {
                row = btn.closest('.body-row');
                varPickerTargetInput = row.querySelector('.body-value');
            } else {
                row = btn.closest('.header-row');
                varPickerTargetInput = row.querySelector('.header-value');
            }
            showVarPicker(btn);
        }

        function showVarPicker(triggerElement) {
            const picker = document.getElementById('var-picker-dropdown');
            renderVarPickerList();

            // Position near the button
            const rect = triggerElement.getBoundingClientRect();
            picker.style.top = (rect.bottom + 5) + 'px';
            picker.style.left = rect.left + 'px';
            picker.classList.add('show');

            // Focus search input
            const searchInput = document.getElementById('var-picker-search-input');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
        }

        function closeVarPicker() {
            const picker = document.getElementById('var-picker-dropdown');
            if (picker) picker.classList.remove('show');
            varPickerTargetInput = null;
        }

        function renderVarPickerList(filter = '') {
            const list = document.getElementById('var-picker-list');
            if (!list) return;

            const filtered = savedVariables.filter(v =>
                v.name.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                list.innerHTML = '<div class="var-picker-empty">No variables found</div>';
                return;
            }

            list.innerHTML = filtered.map(v => {
                const preview = truncateValue(v.value, 30);
                const fullValue = typeof v.value === 'object' ? JSON.stringify(v.value) : String(v.value);
                return `
                    <div class="var-picker-item" onclick="insertVariableFromPicker('${escapeHtml(v.name)}')" title="Value: ${escapeHtml(fullValue)}">
                        <span class="var-picker-item-name">{{${escapeHtml(v.name)}}}</span>
                        <span class="var-picker-item-preview">${escapeHtml(preview)}</span>
                    </div>
                `;
            }).join('');
        }

        function filterVarPicker(filter) {
            renderVarPickerList(filter);
        }

        function insertVariableFromPicker(varName) {
            if (varPickerTargetInput) {
                const start = varPickerTargetInput.selectionStart || 0;
                const end = varPickerTargetInput.selectionEnd || 0;
                const text = varPickerTargetInput.value;
                const insertion = `{{${varName}}}`;

                varPickerTargetInput.value = text.slice(0, start) + insertion + text.slice(end);
                varPickerTargetInput.selectionStart = varPickerTargetInput.selectionEnd = start + insertion.length;
                varPickerTargetInput.focus();
            }
            closeVarPicker();
            updateRequestVariableIndicator();
        }

        // Close var picker when clicking outside
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('var-picker-dropdown');
            if (picker && picker.classList.contains('show')) {
                if (!picker.contains(e.target) && !e.target.classList.contains('insert-var-btn')) {
                    closeVarPicker();
                }
            }
        });

        // Variable Helper Functions
        function getValueType(value) {
            if (value === null) return 'null';
            if (value === undefined) return 'undefined';
            if (Array.isArray(value)) return 'array';
            if (typeof value === 'object') return 'object';
            if (typeof value === 'number') return 'number';
            if (typeof value === 'boolean') return 'boolean';
            return 'string';
        }

        function formatValueForDisplay(value, type) {
            if (type === 'null') return 'null';
            if (type === 'undefined') return 'undefined';
            if (type === 'array' || type === 'object') {
                return JSON.stringify(value, null, 2);
            }
            if (type === 'string') {
                const str = String(value);
                return str.length > 50 ? str.substring(0, 50) + '...' : str;
            }
            return String(value);
        }

        function suggestVariableName(fieldPath) {
            // Convert field path to camelCase variable name
            const parts = fieldPath.split('.');
            const lastPart = parts[parts.length - 1];
            // Remove array indices like [0]
            const cleanName = lastPart.replace(/\[\d+\]/g, '');
            return cleanName || 'value';
        }

        function getNestedValue(obj, path) {
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            let current = obj;
            for (const part of parts) {
                if (current === null || current === undefined) return undefined;
                current = current[part];
            }
            return current;
        }

        // Save Variable Modal Functions
        let saveVariableFieldPath = '';
        let saveVariableValue = null;

        function openSaveVariableModal(fieldPath, value) {
            saveVariableFieldPath = fieldPath;
            saveVariableValue = value;

            const modal = document.getElementById('save-variable-modal');
            const pathDisplay = document.getElementById('save-var-field-path');
            const valuePreview = document.getElementById('save-var-value-preview');
            const typeBadge = document.getElementById('save-var-type-badge');
            const nameInput = document.getElementById('save-var-name');

            const valueType = getValueType(value);

            pathDisplay.textContent = fieldPath;
            valuePreview.textContent = formatValueForDisplay(value, valueType);
            typeBadge.textContent = valueType;
            typeBadge.className = 'value-type-badge type-' + valueType;
            nameInput.value = suggestVariableName(fieldPath);

            modal.classList.add('active');
            nameInput.focus();
            nameInput.select();
        }

        function closeSaveVariableModal() {
            document.getElementById('save-variable-modal').classList.remove('active');
            saveVariableFieldPath = '';
            saveVariableValue = null;
        }

        async function saveVariable() {
            const nameInput = document.getElementById('save-var-name');
            const varName = nameInput.value.trim();

            if (!varName) {
                showToast('Variable name is required', 'error');
                return;
            }

            // Validate variable name (alphanumeric and underscore only)
            if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(varName)) {
                showToast('Variable name must start with a letter or underscore and contain only letters, numbers, and underscores', 'error');
                return;
            }

            const apiName = document.getElementById('page-api-name').value || 'Unnamed API';
            const valueType = getValueType(saveVariableValue);

            // Check if variable already exists
            const existingVar = savedVariables.find(v => v.name === varName);

            try {
                let response;
                if (existingVar) {
                    if (!confirm(`Variable "${varName}" already exists. Do you want to overwrite it?`)) {
                        return;
                    }
                    // Update existing variable
                    response = await fetch(`/api/variables/${existingVar.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: varName,
                            value: saveVariableValue,
                            type: valueType,
                            source: {
                                apiName: apiName,
                                fieldPath: saveVariableFieldPath
                            }
                        })
                    });
                } else {
                    // Create new variable
                    response = await fetch('/api/variables', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: varName,
                            value: saveVariableValue,
                            type: valueType,
                            source: {
                                apiName: apiName,
                                fieldPath: saveVariableFieldPath
                            }
                        })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    closeSaveVariableModal();
                    await loadVariables();  // Refresh from backend
                    updateRequestVariableIndicator();
                    showToast(`Variable "{{${varName}}}" saved successfully`);
                } else {
                    showToast(data.error || 'Failed to save variable', 'error');
                }
            } catch (error) {
                showToast('Failed to save variable: ' + error.message, 'error');
            }
        }

        function deleteVariable(name) {
            if (confirm(`Delete variable "{{${name}}}"?`)) {
                delete runtimeVariables[name];
                renderVariablesPanel();
                updateRequestVariableIndicator();
                showToast(`Variable deleted`);
            }
        }

        function clearAllVariables() {
            if (Object.keys(runtimeVariables).length === 0) {
                showToast('No variables to clear', 'error');
                return;
            }
            if (confirm('Clear all runtime variables?')) {
                runtimeVariables = {};
                renderVariablesPanel();
                updateRequestVariableIndicator();
                showToast('All variables cleared');
            }
        }

        // Interactive JSON Rendering - Tree View like JSON Editor Online
        let jsonNodeCounter = 0;

        function renderInteractiveJson(data, parentPath = '', indent = 0) {
            if (data === null) {
                return `<span class="json-value json-null" onclick="openSaveVariableModalByPath('${parentPath}')" title="Click to save as variable">null</span>`;
            }

            if (typeof data === 'undefined') {
                return `<span class="json-value json-undefined">undefined</span>`;
            }

            if (typeof data === 'boolean') {
                return `<span class="json-value json-boolean" onclick="openSaveVariableModalByPath('${parentPath}')" title="Click to save as variable">${data}</span>`;
            }

            if (typeof data === 'number') {
                return `<span class="json-value json-number" onclick="openSaveVariableModalByPath('${parentPath}')" title="Click to save as variable">${data}</span>`;
            }

            if (typeof data === 'string') {
                const escapedValue = data.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                return `<span class="json-value json-string" onclick="openSaveVariableModalByPath('${parentPath}')" title="Click to save as variable">"${escapedValue}"</span>`;
            }

            const indentStr = '  '.repeat(indent);
            const nextIndent = '  '.repeat(indent + 1);
            const nodeId = `json-node-${jsonNodeCounter++}`;

            if (Array.isArray(data)) {
                if (data.length === 0) {
                    return `<span class="json-bracket">[]</span>`;
                }

                let html = `<span class="json-toggle" onclick="toggleJsonNode('${nodeId}')" data-node="${nodeId}">▾</span>`;
                html += `<span class="json-bracket">[</span>`;
                html += `<span class="json-collapsed-placeholder" id="${nodeId}-placeholder" style="display:none" onclick="toggleJsonNode('${nodeId}')">...]</span>`;
                html += `<span class="json-collapsible" id="${nodeId}">\n`;

                data.forEach((item, index) => {
                    const itemPath = parentPath ? `${parentPath}.${index}` : `${index}`;
                    html += nextIndent + renderInteractiveJson(item, itemPath, indent + 1);
                    if (index < data.length - 1) html += '<span class="json-comma">,</span>';
                    html += '\n';
                });

                html += indentStr + `<span class="json-bracket">]</span></span>`;
                return html;
            }

            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) {
                    return `<span class="json-bracket">{}</span>`;
                }

                let html = `<span class="json-toggle" onclick="toggleJsonNode('${nodeId}')" data-node="${nodeId}">▾</span>`;
                html += `<span class="json-bracket">{</span>`;
                html += `<span class="json-collapsed-placeholder" id="${nodeId}-placeholder" style="display:none" onclick="toggleJsonNode('${nodeId}')">...}</span>`;
                html += `<span class="json-collapsible" id="${nodeId}">\n`;

                keys.forEach((key, index) => {
                    const keyPath = parentPath ? `${parentPath}.${key}` : key;
                    html += nextIndent + `<span class="json-key">"${key}"</span><span class="json-colon">: </span>`;
                    html += renderInteractiveJson(data[key], keyPath, indent + 1);
                    if (index < keys.length - 1) html += '<span class="json-comma">,</span>';
                    html += '\n';
                });

                html += indentStr + `<span class="json-bracket">}</span></span>`;
                return html;
            }

            return String(data);
        }

        function toggleJsonNode(nodeId) {
            const content = document.getElementById(nodeId);
            const placeholder = document.getElementById(nodeId + '-placeholder');
            const toggle = document.querySelector(`[data-node="${nodeId}"]`);

            if (!content) return;

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                placeholder.style.display = 'none';
                toggle.textContent = '▾';
            } else {
                content.classList.add('collapsed');
                placeholder.style.display = 'inline';
                toggle.textContent = '▸';
            }
        }

        function toggleAllJsonNodes(expand) {
            const toggles = document.querySelectorAll('.json-toggle');
            toggles.forEach(toggle => {
                const nodeId = toggle.dataset.node;
                const content = document.getElementById(nodeId);
                const placeholder = document.getElementById(nodeId + '-placeholder');

                if (!content) return;

                if (expand) {
                    content.classList.remove('collapsed');
                    placeholder.style.display = 'none';
                    toggle.textContent = '▾';
                } else {
                    content.classList.add('collapsed');
                    placeholder.style.display = 'inline';
                    toggle.textContent = '▸';
                }
            });
        }

        function copyResponseJson() {
            if (!pageLastResponse) {
                showToast('No response to copy', 'error');
                return;
            }

            const jsonStr = JSON.stringify(pageLastResponse, null, 2);
            navigator.clipboard.writeText(jsonStr).then(() => {
                showToast('JSON copied to clipboard');
            }).catch(err => {
                showToast('Failed to copy: ' + err.message, 'error');
            });
        }

        // Open save variable modal using path (retrieves value from pageLastResponse)
        function openSaveVariableModalByPath(fieldPath) {
            if (!pageLastResponse) {
                showToast('No response data available', 'error');
                return;
            }
            const value = getNestedValue(pageLastResponse, fieldPath);
            openSaveVariableModal(fieldPath, value);
        }

        // Variables Panel
        function renderVariablesPanel() {
            const container = document.getElementById('variables-list');
            const badge = document.getElementById('var-count-badge');
            const section = document.getElementById('variables-section');

            if (!container) return;

            const varCount = Object.keys(runtimeVariables).length;
            if (badge) badge.textContent = varCount;

            if (varCount === 0) {
                container.innerHTML = '<div class="no-variables">No variables saved yet. Click on response values to save them.</div>';
                return;
            }

            let html = '';
            for (const [name, data] of Object.entries(runtimeVariables)) {
                const displayValue = formatValueForDisplay(data.value, data.type);
                html += `
                    <div class="variable-item">
                        <div class="variable-header">
                            <span class="variable-name">{{${name}}}</span>
                            <span class="variable-type type-${data.type}">${data.type}</span>
                        </div>
                        <div class="variable-value">${displayValue}</div>
                        <div class="variable-source">From: ${data.source.fieldPath}</div>
                        <div class="variable-actions">
                            <button class="var-action-btn" onclick="copyVariableToClipboard('${name}')" title="Copy {{${name}}}">Copy</button>
                            <button class="var-action-btn" onclick="insertVariableAtCursor('${name}')" title="Insert at cursor">Insert</button>
                            <button class="var-action-btn delete" onclick="deleteVariable('${name}')" title="Delete">Delete</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function copyVariableToClipboard(name) {
            navigator.clipboard.writeText(`{{${name}}}`).then(() => {
                showToast(`Copied {{${name}}} to clipboard`);
            });
        }

        // Variable Injection System
        function replaceVariables(text) {
            const result = { text: text, errors: [], replaced: [] };
            const pattern = /\{\{([a-zA-Z_][a-zA-Z0-9_]*)\}\}/g;
            let match;

            while ((match = pattern.exec(text)) !== null) {
                const varName = match[1];
                if (runtimeVariables[varName]) {
                    const value = runtimeVariables[varName].value;
                    result.replaced.push(varName);
                } else {
                    result.errors.push(varName);
                }
            }

            if (result.errors.length === 0) {
                result.text = text.replace(pattern, (match, varName) => {
                    const value = runtimeVariables[varName].value;
                    return typeof value === 'object' ? JSON.stringify(value) : String(value);
                });
            }

            return result;
        }

        function validateVariablesInText(text) {
            const pattern = /\{\{([a-zA-Z_][a-zA-Z0-9_]*)\}\}/g;
            const found = [];
            const missing = [];
            let match;

            while ((match = pattern.exec(text)) !== null) {
                const varName = match[1];
                if (runtimeVariables[varName]) {
                    if (!found.includes(varName)) found.push(varName);
                } else {
                    if (!missing.includes(varName)) missing.push(varName);
                }
            }

            return { valid: missing.length === 0, found, missing };
        }

        function setupPageFormListeners() {
            // Add event listeners for form validation
            document.getElementById('page-api-name')?.addEventListener('input', updatePageStatus);
            document.getElementById('page-api-section')?.addEventListener('change', updatePageStatus);
            // Request editor fields
            document.getElementById('request-method')?.addEventListener('change', updatePageStatus);
            document.getElementById('request-url')?.addEventListener('input', updatePageStatus);
            document.getElementById('body-type')?.addEventListener('change', updatePageStatus);
            document.getElementById('request-body')?.addEventListener('input', updatePageStatus);
        }

        // Initialize form listeners once
        document.addEventListener('DOMContentLoaded', setupPageFormListeners);

        function openCreateApiPage() {
            // Close any open modals first
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            closeVarPicker();

            pageEditingApiId = null;
            pageCustomRules = [];
            pageExtractionRules = [];
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            // Safe element updates
            const title = document.getElementById('create-api-title');
            const nameInput = document.getElementById('page-api-name');
            const saveBtn = document.getElementById('page-save-btn');
            const responseMeta = document.getElementById('page-response-meta');
            const responseJson = document.getElementById('page-response-json');
            const fieldsCount = document.getElementById('page-fields-count');
            const fieldsListRight = document.getElementById('page-fields-list-right');
            const fieldList = document.getElementById('page-field-list');
            const fieldSearch = document.getElementById('page-field-search');
            const fieldSearchRight = document.getElementById('page-field-search-right');

            if (title) title.textContent = 'Create New API';
            if (nameInput) nameInput.value = '';
            if (saveBtn) saveBtn.disabled = true;

            // Reset Structured Request Editor
            const methodSelect = document.getElementById('request-method');
            const urlInput = document.getElementById('request-url');
            const bodyType = document.getElementById('body-type');
            const bodyTextarea = document.getElementById('request-body');
            const bodySection = document.getElementById('body-section');
            const headersTable = document.getElementById('headers-table');
            const bodyTable = document.getElementById('body-table');
            const addBodyRowBtn = document.getElementById('add-body-row-btn');
            const bodyVarBtn = document.getElementById('body-var-btn');

            if (methodSelect) methodSelect.value = 'GET';
            if (urlInput) urlInput.value = '';
            if (bodyType) bodyType.value = 'none';
            if (bodyTextarea) {
                bodyTextarea.value = '';
                bodyTextarea.style.display = 'none';
            }
            if (bodySection) bodySection.style.display = 'none';
            if (bodyTable) bodyTable.style.display = 'none';
            if (addBodyRowBtn) addBodyRowBtn.style.display = 'none';
            if (bodyVarBtn) bodyVarBtn.style.display = 'none';

            // Reset headers table to single empty row
            if (headersTable) {
                headersTable.innerHTML = `
                    <div class="header-row">
                        <input type="text" placeholder="Key" class="header-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="header-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this)" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeHeaderRow(this)">&times;</button>
                    </div>
                `;
            }

            // Reset body table to single empty row
            if (bodyTable) {
                bodyTable.innerHTML = `
                    <div class="body-row">
                        <input type="text" placeholder="Key" class="body-key" oninput="updateRequestVariableIndicator()">
                        <input type="text" placeholder="Value" class="body-value" oninput="updateRequestVariableIndicator()">
                        <button type="button" class="insert-var-btn small" onclick="openVarPickerForRow(this, 'body')" title="Insert Variable">{{</button>
                        <button type="button" class="remove-row-btn" onclick="removeBodyRow(this)">&times;</button>
                    </div>
                `;
            }

            // Reset response panel
            if (responseMeta) responseMeta.innerHTML = '<span class="meta-badge neutral">No response yet</span>';
            if (responseJson) {
                responseJson.textContent = 'Execute request to see response';
                responseJson.classList.add('empty');
                responseJson.classList.remove('interactive');
            }
            if (fieldsCount) fieldsCount.textContent = '0';
            if (fieldsListRight) fieldsListRight.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields extracted yet</span>';
            if (fieldList) fieldList.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">Execute request to see fields</div>';
            if (fieldSearch) fieldSearch.value = '';
            if (fieldSearchRight) fieldSearchRight.value = '';

            // Reset rules
            renderPageRules();
            renderExtractionRules();
            updatePageStatus();

            // Populate section dropdown
            populatePageSectionDropdown();

            // Initialize new rule builder
            initNewRuleBuilder();

            // Update variables panel and indicator
            renderVariablesPanel();
            updateRequestVariableIndicator();

            // Switch to Create API tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="create-api"]').classList.add('active');
            document.getElementById('create-api').classList.add('active');
        }

        function openEditApiPage(apiId) {
            let api, sectionId;
            for (const section of sections) {
                const found = section.apis.find(a => a.id === apiId);
                if (found) {
                    api = found;
                    sectionId = section.id;
                    break;
                }
            }
            if (!api) return;

            pageEditingApiId = apiId;
            pageCustomRules = api.customRules ? JSON.parse(JSON.stringify(api.customRules)) : [];
            pageExtractionRules = api.extractRules ? JSON.parse(JSON.stringify(api.extractRules)) : [];
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            document.getElementById('create-api-title').textContent = `Edit: ${api.name}`;
            document.getElementById('page-api-name').value = api.name;
            document.getElementById('page-save-btn').disabled = true;

            // Parse saved cURL and populate the Structured Request Editor
            parseCurlToEditor(api.curl);

            // Reset response panel
            const responseJson = document.getElementById('page-response-json');
            document.getElementById('page-response-meta').innerHTML = '<span class="meta-badge neutral">Execute to refresh</span>';
            responseJson.textContent = 'Execute request to see response';
            responseJson.classList.add('empty');
            responseJson.classList.remove('interactive');
            document.getElementById('page-fields-count').textContent = '0';
            document.getElementById('page-fields-list-right').innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">Execute request to refresh fields</span>';
            document.getElementById('page-field-list').innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">Execute request to see fields</div>';

            // Populate section dropdown
            populatePageSectionDropdown();
            document.getElementById('page-api-section').value = sectionId;

            // Render existing rules
            renderPageRules();
            renderExtractionRules();
            updatePageStatus();

            // Initialize new rule builder
            initNewRuleBuilder();

            // Update variables panel and indicator
            renderVariablesPanel();
            updateRequestVariableIndicator();

            // Switch to Create API tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="create-api"]').classList.add('active');
            document.getElementById('create-api').classList.add('active');
        }

        function populatePageSectionDropdown() {
            const select = document.getElementById('page-api-section');
            if (sections.length === 0) {
                select.innerHTML = '<option value="">-- No modules yet --</option>';
            } else {
                select.innerHTML = sections.map(s =>
                    `<option value="${s.id}">${escapeHtml(s.name)}</option>`
                ).join('');
                if (currentSectionId) {
                    select.value = currentSectionId;
                }
            }
        }

        function openAddModuleInline() {
            document.getElementById('inline-add-module').style.display = 'block';
            document.getElementById('inline-module-name').value = '';
            document.getElementById('inline-module-name').focus();
        }

        function cancelInlineModule() {
            document.getElementById('inline-add-module').style.display = 'none';
            document.getElementById('inline-module-name').value = '';
        }

        async function saveInlineModule() {
            const name = document.getElementById('inline-module-name').value.trim();
            if (!name) {
                showToast('Module name is required', 'error');
                return;
            }

            // Check for duplicate
            if (sections.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                showToast('Module name already exists', 'error');
                return;
            }

            try {
                const response = await fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();
                if (data.success) {
                    sections.push(data.section);
                    populatePageSectionDropdown();
                    document.getElementById('page-api-section').value = data.section.id;
                    cancelInlineModule();
                    showToast('Module created successfully');

                    // Also update main sections list
                    renderSections();
                } else {
                    showToast(data.error || 'Failed to create module', 'error');
                }
            } catch (error) {
                showToast('Failed to create module: ' + error.message, 'error');
            }
        }

        function cancelCreateApi() {
            // Switch back to Saved APIs tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="saved-apis"]').classList.add('active');
            document.getElementById('saved-apis').classList.add('active');
        }

        function renderPageFieldsList() {
            // Left panel field list
            const leftList = document.getElementById('page-field-list');
            if (pageAvailableFields.length === 0) {
                leftList.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No fields found</div>';
            } else {
                leftList.innerHTML = pageAvailableFields.map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('');
            }

            // Right panel field list
            const rightList = document.getElementById('page-fields-list-right');
            if (pageAvailableFields.length === 0) {
                rightList.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields found</span>';
            } else {
                rightList.innerHTML = pageAvailableFields.slice(0, 20).map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('') + (pageAvailableFields.length > 20 ? `<div class="field-item" style="color: #7f8c8d;">... and ${pageAvailableFields.length - 20} more</div>` : '');
            }
        }

        function addRuleForField(field) {
            // Pre-select field_exists type in the new rule builder
            const typeSelect = document.getElementById('new-rule-type');
            if (typeSelect) {
                typeSelect.value = 'field_exists';
                onNewRuleTypeChange();
            }

            // Set the field in the field selector
            selectNewRuleField(field);

            // Scroll to the new rule builder
            const builder = document.getElementById('new-rule-builder');
            if (builder) {
                builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
                builder.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.5)';
                setTimeout(() => {
                    builder.style.boxShadow = '';
                }, 1500);
            }

            showToast(`Configure rule for "${field}" and click "Test Rule"`);
        }

        function quickAddRule(ruleType) {
            // Pre-select the rule type in the new rule builder
            const typeSelect = document.getElementById('new-rule-type');
            if (typeSelect) {
                typeSelect.value = ruleType;
                onNewRuleTypeChange();
            }

            // Scroll to the new rule builder
            const builder = document.getElementById('new-rule-builder');
            if (builder) {
                builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
                builder.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.5)';
                setTimeout(() => {
                    builder.style.boxShadow = '';
                }, 1500);
            }

            showToast(`Configure ${ruleTypes[ruleType]?.name || ruleType} and click "Test Rule"`);
        }

        async function autoValidateSingleRule(rule) {
            const curl = getCurrentCurlCommand();
            if (!curl) return;

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: curl,
                        rules: [rule]
                    })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    const result = data.results[0];
                    const card = document.getElementById(`page-rule-${rule.id}`);
                    if (card) {
                        card.classList.remove('valid', 'invalid');
                        card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                        let resultDiv = card.querySelector('.validation-result');
                        if (!resultDiv) {
                            resultDiv = document.createElement('div');
                            resultDiv.className = 'validation-result';
                            card.appendChild(resultDiv);
                        }
                        resultDiv.className = `validation-result ${result.result.toLowerCase()}`;
                        resultDiv.innerHTML = result.result === 'PASS' ?
                            `✓ PASS - Expected: ${result.expected}, Actual: ${result.actual}` :
                            `✗ FAIL - ${result.reason}`;
                    }

                    // Check if all rules are now validated and passing
                    checkAllRulesValidated();
                }
            } catch (error) {
                console.error('Auto-validation failed:', error);
            }
        }

        async function checkAllRulesValidated() {
            // Re-validate all rules to update the overall status
            if (pageCustomRules.length === 0) {
                pageRulesValidated = false;
                updatePageStatus();
                return;
            }

            const curl = getCurrentCurlCommand();
            if (!curl) return;

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: curl,
                        rules: pageCustomRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const allPassed = data.results.every(r => r.result === 'PASS');
                    pageRulesValidated = allPassed;

                    updatePageStatus();
                }
            } catch (error) {
                console.error('Validation check failed:', error);
            }
        }

        async function addPageRule() {
            await quickAddRule('field_exists');
        }

        function removePageRule(ruleId) {
            pageCustomRules = pageCustomRules.filter(r => r.id !== ruleId);
            pageRulesValidated = false;
            renderPageRules();
            updatePageStatus();
        }

        function updatePageRule(ruleId, field, value) {
            const rule = pageCustomRules.find(r => r.id === ruleId);
            if (!rule) return;

            if (field === 'type') {
                rule.type = value;
                rule.config = {};
                const typeConfig = ruleTypes[value];
                if (typeConfig && typeConfig.configFields) {
                    typeConfig.configFields.forEach(cf => {
                        if (cf.default !== undefined) {
                            rule.config[cf.name] = cf.default;
                        }
                    });
                }
                if (typeConfig && !typeConfig.requiresField) {
                    rule.field = '';
                } else if (!rule.field && pageAvailableFields.length > 0) {
                    rule.field = pageAvailableFields[0];
                }
            } else if (field === 'field') {
                rule.field = value;
            } else {
                rule.config[field] = value;
            }

            pageRulesValidated = false;
            renderPageRules();
            updatePageStatus();
        }

        // =============================================================================
        // Extraction Rules Functions (for Flow Context)
        // =============================================================================

        function addExtractionRule() {
            const id = 'extract-' + Date.now();
            pageExtractionRules.push({ id, path: '', variable: '' });
            renderExtractionRules();
        }

        function removeExtractionRule(id) {
            pageExtractionRules = pageExtractionRules.filter(r => r.id !== id);
            renderExtractionRules();
        }

        function updateExtractionRule(id, field, value) {
            const rule = pageExtractionRules.find(r => r.id === id);
            if (rule) {
                rule[field] = value;
            }
        }

        function renderExtractionRules() {
            const container = document.getElementById('extraction-rules-list');
            if (!container) return;

            if (pageExtractionRules.length === 0) {
                container.innerHTML = `
                    <div class="no-extraction-rules" style="text-align: center; padding: 20px; color: #7f8c8d; font-size: 12px; background: #f8f9fa; border-radius: 4px;">
                        No extraction rules. Add rules to capture response values as variables for use in subsequent API calls.
                    </div>
                `;
                return;
            }

            container.innerHTML = pageExtractionRules.map(rule => `
                <div class="extraction-rule-row" data-id="${rule.id}" style="display: flex; gap: 10px; align-items: center; padding: 10px; background: #f8f4fc; border: 1px solid #e1d5e7; border-radius: 6px; margin-bottom: 8px;">
                    <div style="flex: 2;">
                        <label style="display: block; font-size: 10px; color: #7f8c8d; margin-bottom: 3px; text-transform: uppercase;">Response Field</label>
                        <select class="extract-field-select" onchange="updateExtractionRule('${rule.id}', 'path', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="">-- Select field --</option>
                            ${pageAvailableFields.map(f => `<option value="${f}" ${rule.path === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; padding-top: 18px;">
                        <span style="font-size: 18px; color: #9b59b6;">→</span>
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; font-size: 10px; color: #7f8c8d; margin-bottom: 3px; text-transform: uppercase;">Variable Name</label>
                        <input type="text" placeholder="variableName" value="${rule.variable || ''}"
                               onchange="updateExtractionRule('${rule.id}', 'variable', this.value)"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace;">
                    </div>
                    <div style="padding-top: 18px;">
                        <button onclick="removeExtractionRule('${rule.id}')" style="background: #fee; color: #e74c3c; border: 1px solid #fcc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                </div>
            `).join('');
        }

        function renderPageRules() {
            const container = document.getElementById('page-rules-list');
            document.getElementById('page-rules-count').textContent = `(${pageCustomRules.length})`;

            if (pageCustomRules.length === 0) {
                container.innerHTML = `
                    <div class="empty-rules-full">
                        <p>No test rules yet</p>
                        <span>Execute cURL first, then add rules using the quick actions or the "+ Add Rule" button</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = pageCustomRules.map((rule, index) => {
                const typeConfig = ruleTypes[rule.type] || {};
                const requiresField = typeConfig.requiresField !== false;

                return `
                    <div class="rule-card-full" id="page-rule-${rule.id}">
                        <div class="rule-header">
                            <div class="rule-title">
                                <span>Rule ${index + 1}</span>
                                <span style="font-size: 11px; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; color: #666;">${typeConfig.ruleType || 'functional'}</span>
                            </div>
                            <button class="btn-icon" onclick="removePageRule('${rule.id}')" title="Remove">🗑️</button>
                        </div>
                        <div class="rule-fields">
                            <div>
                                <label>Rule Type</label>
                                <select onchange="updatePageRule('${rule.id}', 'type', this.value)">
                                    ${Object.entries(ruleTypes).map(([key, config]) =>
                                        `<option value="${key}" ${rule.type === key ? 'selected' : ''}>${config.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ${requiresField ? `
                            <div>
                                <label>Field</label>
                                <select onchange="updatePageRule('${rule.id}', 'field', this.value)">
                                    ${pageAvailableFields.map(f =>
                                        `<option value="${f}" ${rule.field === f ? 'selected' : ''}>${f}</option>`
                                    ).join('')}
                                    ${rule.field && !pageAvailableFields.includes(rule.field) ?
                                        `<option value="${rule.field}" selected>${rule.field}</option>` : ''}
                                </select>
                            </div>
                            ` : ''}
                            ${renderPageConfigFields(rule)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPageConfigFields(rule) {
            const typeConfig = ruleTypes[rule.type];
            if (!typeConfig || !typeConfig.configFields || typeConfig.configFields.length === 0) {
                return '';
            }

            return typeConfig.configFields.map(cf => {
                const value = rule.config[cf.name] !== undefined ? rule.config[cf.name] : cf.default;

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updatePageRule('${rule.id}', '${cf.name}', this.value)">
                                ${cf.options.map(opt =>
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updatePageRule('${rule.id}', '${cf.name}', this.value === 'true')">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="number" value="${value}" onchange="updatePageRule('${rule.id}', '${cf.name}', parseInt(this.value) || 0)">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="text" value="${escapeHtml(value || '')}" onchange="updatePageRule('${rule.id}', '${cf.name}', this.value)">
                        </div>
                    `;
                }
            }).join('');
        }

        async function validatePageRules() {
            if (pageCustomRules.length === 0) {
                showToast('Add at least one rule first', 'error');
                return;
            }

            const btn = document.getElementById('page-validate-btn');
            btn.disabled = true;
            btn.textContent = 'Validating...';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: getCurrentCurlCommand(),
                        rules: pageCustomRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    data.results.forEach(result => {
                        const card = document.getElementById(`page-rule-${result.rule_id}`);
                        if (card) {
                            card.classList.remove('valid', 'invalid');
                            card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                            // Add validation result
                            let resultDiv = card.querySelector('.validation-result');
                            if (!resultDiv) {
                                resultDiv = document.createElement('div');
                                resultDiv.className = 'validation-result';
                                card.appendChild(resultDiv);
                            }
                            resultDiv.className = `validation-result ${result.result.toLowerCase()}`;
                            resultDiv.innerHTML = result.result === 'PASS' ?
                                `✓ PASS - Expected: ${result.expected}, Actual: ${result.actual}` :
                                `✗ FAIL - ${result.reason}`;
                        }
                    });

                    const allPassed = data.results.every(r => r.result === 'PASS');
                    pageRulesValidated = allPassed;

                    document.getElementById('page-save-btn').disabled = !allPassed;
                    updatePageStatus();

                    showToast(allPassed ? 'All rules validated!' : 'Some rules failed - fix them to save');
                } else {
                    showToast(data.error || 'Validation failed', 'error');
                }
            } catch (error) {
                showToast('Validation failed: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Validate All Rules';
        }

        function updatePageStatus() {
            const rulesStatus = document.getElementById('page-status-rules');
            const validatedStatus = document.getElementById('page-status-validated');
            const message = document.getElementById('page-status-message');
            const saveBtn = document.getElementById('page-save-btn');

            // Check if we're on the Create API page
            if (!rulesStatus || !validatedStatus || !message || !saveBtn) {
                return; // Elements not available, skip update
            }

            const nameInput = document.getElementById('page-api-name');
            const urlInput = document.getElementById('request-url');
            const sectionInput = document.getElementById('page-api-section');

            const name = nameInput ? nameInput.value.trim() : '';
            const url = urlInput ? urlInput.value.trim() : '';
            const sectionId = sectionInput ? sectionInput.value : '';

            rulesStatus.innerHTML = `<span>Rules: ${pageCustomRules.length}</span>`;

            // Check all conditions for enabling save
            const hasName = name.length > 0;
            const hasUrl = url.length > 0;
            const hasSection = sectionId && sectionId.length > 0;
            const hasRules = pageCustomRules.length > 0;

            // Rules are valid if all have been auto-validated and passed
            const allRulesPassed = hasRules && pageRulesValidated;

            const canSave = hasName && hasUrl && hasSection && hasRules && allRulesPassed;
            saveBtn.disabled = !canSave;

            // Update status display
            if (!hasName) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'API name is required';
            } else if (!hasSection) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'Select a module';
            } else if (!hasUrl) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'Enter request URL';
            } else if (!hasRules) {
                validatedStatus.className = 'status-item';
                validatedStatus.innerHTML = '<span>No rules</span>';
                message.textContent = 'Add at least one test rule';
            } else if (!allRulesPassed) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Rules failing</span>';
                message.textContent = 'Fix failing rules to save';
            } else {
                validatedStatus.className = 'status-item pass';
                validatedStatus.innerHTML = '<span>✓ Ready</span>';
                message.textContent = 'All checks passed - ready to save';
            }
        }

        function filterPageFields() {
            const search = document.getElementById('page-field-search').value.toLowerCase();
            const container = document.getElementById('page-field-list');

            if (pageAvailableFields.length === 0) {
                container.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No fields found</div>';
                return;
            }

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                container.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No matching fields</div>';
            } else {
                container.innerHTML = filtered.map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('');
            }
        }

        function filterPageFieldsRight() {
            const search = document.getElementById('page-field-search-right').value.toLowerCase();
            const container = document.getElementById('page-fields-list-right');

            if (pageAvailableFields.length === 0) {
                container.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields found</span>';
                return;
            }

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                container.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No matching fields</span>';
            } else {
                container.innerHTML = filtered.slice(0, 30).map(f =>
                    `<div class="field-item" onclick="selectFieldForNewRule('${f}')">${f}</div>`
                ).join('') + (filtered.length > 30 ? `<div class="field-item" style="color: #7f8c8d;">... ${filtered.length - 30} more</div>` : '');
            }
        }

        // =============================================================================
        // New Rule Builder Functions
        // =============================================================================

        let newRuleTested = false;
        let newRuleTestResult = null;

        async function initNewRuleBuilder() {
            // Wait for rule types to load if not yet available
            if (Object.keys(ruleTypes).length === 0) {
                await loadRuleTypes();
            }

            // Populate rule type dropdown
            const typeSelect = document.getElementById('new-rule-type');
            const ruleTypeEntries = Object.entries(ruleTypes);

            if (ruleTypeEntries.length === 0) {
                typeSelect.innerHTML = '<option value="">No rule types available</option>';
                console.error('No rule types loaded');
                return;
            }

            // Add placeholder option first, then rule types
            typeSelect.innerHTML = '<option value="">-- Select Rule Type --</option>' +
                ruleTypeEntries.map(([key, config]) =>
                    `<option value="${key}">${config.name}</option>`
                ).join('');

            // Keep placeholder selected initially
            typeSelect.selectedIndex = 0;

            // Initialize field container (hide it until rule type selected)
            document.getElementById('new-rule-field-container').style.display = 'none';
            document.getElementById('new-rule-config-container').innerHTML = '';

            // Reset test state
            resetNewRuleTest();
        }

        function onNewRuleTypeChange() {
            const ruleType = document.getElementById('new-rule-type').value;
            const fieldContainer = document.getElementById('new-rule-field-container');
            const configContainer = document.getElementById('new-rule-config-container');

            // If no rule type selected (placeholder), hide everything
            if (!ruleType) {
                fieldContainer.style.display = 'none';
                configContainer.innerHTML = '';
                resetNewRuleTest();
                return;
            }

            const typeConfig = ruleTypes[ruleType] || {};

            // Show/hide field selector based on rule type
            if (typeConfig.requiresField === false) {
                fieldContainer.style.display = 'none';
            } else {
                fieldContainer.style.display = 'block';
                populateNewRuleFieldDropdown();
            }

            // Populate config fields
            renderNewRuleConfigFields(ruleType, typeConfig);

            // Reset test state
            resetNewRuleTest();
        }

        function populateNewRuleFieldDropdown() {
            const dropdown = document.getElementById('new-rule-field-dropdown');
            const search = document.getElementById('new-rule-field-search').value.toLowerCase();

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 8px; color: #7f8c8d; font-size: 12px;">No fields found</div>';
            } else {
                dropdown.innerHTML = filtered.map(f =>
                    `<div class="field-dropdown-item" onclick="selectNewRuleField('${f}')" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;"
                        onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">${f}</div>`
                ).join('');
            }
        }

        function showFieldDropdown() {
            const dropdown = document.getElementById('new-rule-field-dropdown');
            populateNewRuleFieldDropdown();
            dropdown.style.display = 'block';
        }

        function hideFieldDropdown() {
            setTimeout(() => {
                document.getElementById('new-rule-field-dropdown').style.display = 'none';
            }, 200);
        }

        function selectNewRuleField(field) {
            document.getElementById('new-rule-field').value = field;
            document.getElementById('new-rule-field-search').value = field;
            document.getElementById('new-rule-field-dropdown').style.display = 'none';
            resetNewRuleTest();
        }

        function filterNewRuleFields() {
            populateNewRuleFieldDropdown();
            document.getElementById('new-rule-field').value = '';
            resetNewRuleTest();
        }

        function selectFieldForNewRule(field) {
            selectNewRuleField(field);
        }

        function renderNewRuleConfigFields(ruleType, typeConfig) {
            const container = document.getElementById('new-rule-config-container');

            if (!typeConfig.configFields || typeConfig.configFields.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = typeConfig.configFields.map(cf => {
                const value = cf.default !== undefined ? cf.default : '';

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <select id="new-rule-config-${cf.name}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                ${cf.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <select id="new-rule-config-${cf.name}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <input type="number" id="new-rule-config-${cf.name}" value="${value}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <input type="text" id="new-rule-config-${cf.name}" value="${value}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                }
            }).join('');
        }

        function resetNewRuleTest() {
            newRuleTested = false;
            newRuleTestResult = null;
            document.getElementById('add-rule-btn').disabled = true;
            document.getElementById('new-rule-test-result').textContent = '';
            document.getElementById('new-rule-test-result').style.color = '#7f8c8d';
        }

        function buildNewRuleObject() {
            const typeSelect = document.getElementById('new-rule-type');
            let ruleType = typeSelect.value;

            // Fallback if no rule type selected
            if (!ruleType && typeSelect.options.length > 0) {
                ruleType = typeSelect.options[0].value;
                typeSelect.selectedIndex = 0;
            }

            if (!ruleType) {
                console.error('No rule type available');
                return null;
            }

            const typeConfig = ruleTypes[ruleType] || {};
            const field = typeConfig.requiresField !== false ? document.getElementById('new-rule-field').value : '';

            const config = {};
            if (typeConfig.configFields) {
                typeConfig.configFields.forEach(cf => {
                    const el = document.getElementById(`new-rule-config-${cf.name}`);
                    if (el) {
                        let val = el.value;
                        if (cf.type === 'number') val = parseInt(val) || 0;
                        if (cf.type === 'boolean') val = val === 'true';
                        config[cf.name] = val;
                    }
                });
            }

            return {
                id: 'rule-' + Math.random().toString(36).substr(2, 9),
                type: ruleType,
                field: field,
                config: config,
                enabled: true
            };
        }

        async function testNewRule() {
            const curl = getCurrentCurlCommand();
            if (!curl) {
                showToast('Execute request first', 'error');
                return;
            }

            const typeSelect = document.getElementById('new-rule-type');
            const ruleType = typeSelect.value;

            if (!ruleType) {
                showToast('Please select a rule type', 'error');
                return;
            }

            const typeConfig = ruleTypes[ruleType] || {};

            // Validate field is selected if required
            if (typeConfig.requiresField !== false) {
                const field = document.getElementById('new-rule-field').value;
                if (!field) {
                    showToast('Please select a field', 'error');
                    return;
                }
            }

            const rule = buildNewRuleObject();
            const btn = document.getElementById('test-new-rule-btn');
            const resultSpan = document.getElementById('new-rule-test-result');

            btn.disabled = true;
            btn.textContent = 'Testing...';
            resultSpan.textContent = '';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl, rules: [rule] })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    const result = data.results[0];
                    newRuleTested = true;
                    newRuleTestResult = result;

                    if (result.result === 'PASS') {
                        resultSpan.innerHTML = `✓ PASS - Expected: ${result.expected}, Actual: ${result.actual}`;
                        resultSpan.style.color = '#27ae60';
                        document.getElementById('add-rule-btn').disabled = false;
                        showToast('Rule test passed! Click "Add Rule" to save it.');
                    } else {
                        resultSpan.innerHTML = `✗ FAIL - ${result.reason}`;
                        resultSpan.style.color = '#e74c3c';
                        document.getElementById('add-rule-btn').disabled = true;
                        showToast('Rule test failed. Fix the rule and try again.', 'error');
                    }
                } else {
                    resultSpan.textContent = 'Test failed';
                    resultSpan.style.color = '#e74c3c';
                }
            } catch (error) {
                resultSpan.textContent = 'Test error: ' + error.message;
                resultSpan.style.color = '#e74c3c';
            }

            btn.disabled = false;
            btn.textContent = 'Test Rule';
        }

        function addTestedRule() {
            if (!newRuleTested || !newRuleTestResult || newRuleTestResult.result !== 'PASS') {
                showToast('Test the rule first', 'error');
                return;
            }

            const rule = buildNewRuleObject();
            if (!rule) {
                showToast('Failed to create rule - no rule type selected', 'error');
                return;
            }

            rule.testResult = newRuleTestResult; // Store test result with rule

            pageCustomRules.push(rule);
            pageRulesValidated = true; // All added rules are pre-tested

            renderPageRules();
            updatePageStatus();
            resetNewRuleBuilder();

            showToast('Rule added successfully!');
        }

        function resetNewRuleBuilder() {
            // Reset to default state
            document.getElementById('new-rule-type').selectedIndex = 0;
            document.getElementById('new-rule-field-search').value = '';
            onNewRuleTypeChange();
            resetNewRuleTest();
        }

        // Check for duplicate API name in section
        function checkDuplicateName(name, sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return false;

            return section.apis.some(api =>
                api.name.toLowerCase() === name.toLowerCase() &&
                api.id !== pageEditingApiId
            );
        }

        async function saveApiFromPage() {
            const sectionId = document.getElementById('page-api-section').value;
            const name = document.getElementById('page-api-name').value.trim();
            const curl = getCurrentCurlCommand();

            // Validate required fields
            if (!name) {
                showToast('API name is required', 'error');
                return;
            }
            if (!sectionId) {
                showToast('Please select a module', 'error');
                return;
            }
            if (!curl) {
                showToast('Request URL is required', 'error');
                return;
            }
            if (pageCustomRules.length === 0) {
                showToast('Add at least one test rule', 'error');
                return;
            }
            if (!pageRulesValidated) {
                showToast('All rules must pass before saving', 'error');
                return;
            }

            // Check for duplicate API name in section
            if (checkDuplicateName(name, sectionId)) {
                showToast(`API name "${name}" already exists in this module`, 'error');
                return;
            }

            const apiData = {
                name,
                curl,
                customRules: pageCustomRules,
                extractRules: pageExtractionRules
            };

            try {
                let response;
                if (pageEditingApiId) {
                    response = await fetch(`/api/apis/${pageEditingApiId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });

                    // Check if section changed
                    let currentSection;
                    for (const section of sections) {
                        if (section.apis.find(a => a.id === pageEditingApiId)) {
                            currentSection = section.id;
                            break;
                        }
                    }

                    if (currentSection !== sectionId) {
                        await fetch(`/api/apis/${pageEditingApiId}/move`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetSectionId: sectionId })
                        });
                    }
                } else {
                    response = await fetch(`/api/sections/${sectionId}/apis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(pageEditingApiId ?
                        `API updated with ${pageCustomRules.length} rules` :
                        `API created with ${pageCustomRules.length} rules`);

                    // Reload sections and switch to Saved APIs tab
                    await loadSections();
                    cancelCreateApi();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save API', 'error');
            }
        }

        // =============================================================================
        // Reports Functions
        // =============================================================================

        async function loadReports() {
            const container = document.getElementById('reports-list');
            const sectionFilter = document.getElementById('filter-section').value;
            const resultFilter = document.getElementById('filter-result').value;

            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading reports...</span></div>';

            try {
                let url = '/api/reports';
                const params = new URLSearchParams();
                if (sectionFilter) params.append('section', sectionFilter);
                if (resultFilter) params.append('result', resultFilter);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderReports(data.reports);
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>Failed to load reports</p></div>';
            }
        }

        function renderReports(reports) {
            const container = document.getElementById('reports-list');

            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No reports yet</h3>
                        <p>Run some API tests to see reports here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map(report => {
                // Group results by module (section)
                const moduleGroups = {};
                report.results.forEach(result => {
                    const moduleName = result.section || 'Unknown';
                    if (!moduleGroups[moduleName]) {
                        moduleGroups[moduleName] = { passed: 0, failed: 0, apis: [] };
                    }
                    moduleGroups[moduleName].apis.push(result);
                    if (result.result === 'PASS') {
                        moduleGroups[moduleName].passed++;
                    } else {
                        moduleGroups[moduleName].failed++;
                    }
                });

                return `
                <div class="report-card">
                    <div class="report-header" onclick="toggleReportDetails('${report.runId}')">
                        <div class="report-info">
                            <h4>Test Run: ${report.runId}</h4>
                            <span class="report-meta">${formatDate(report.date)} • ${report.totalApis} APIs • ${Object.keys(moduleGroups).length} Modules</span>
                        </div>
                        <div class="report-stats">
                            <div class="stat">
                                <div class="stat-value pass">${report.passed}</div>
                                <div class="stat-label">Passed</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value fail">${report.failed}</div>
                                <div class="stat-label">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="report-details" id="details-${report.runId}">
                        ${Object.entries(moduleGroups).map(([moduleName, moduleData]) => `
                            <div class="module-group">
                                <div class="module-header" onclick="event.stopPropagation(); toggleModule('${report.runId}-${moduleName.replace(/\s+/g, '-')}')">
                                    <h4>${escapeHtml(moduleName)}</h4>
                                    <div class="module-stats">
                                        <span class="module-stat pass">${moduleData.passed} passed</span>
                                        <span class="module-stat fail">${moduleData.failed} failed</span>
                                    </div>
                                </div>
                                <div class="module-apis" id="module-${report.runId}-${moduleName.replace(/\s+/g, '-')}">
                                    ${moduleData.apis.map(api => {
                                        const passedTests = (api.ruleResults || []).filter(r => r.result === 'PASS').length;
                                        const failedTests = (api.ruleResults || []).filter(r => r.result === 'FAIL').length;
                                        const totalTests = (api.ruleResults || []).length;
                                        return `
                                        <div class="api-report-item" data-api-id="${api.apiId}">
                                            <div class="api-report-header" onclick="event.stopPropagation(); toggleApiDetails('${report.runId}-${api.apiId}')">
                                                <div class="api-report-info">
                                                    <h5>${escapeHtml(api.apiName)}</h5>
                                                    <span class="api-report-meta">
                                                        Status: ${api.statusCode || '-'} •
                                                        Time: ${api.executionTime} •
                                                        Tests: <span class="test-count pass">${passedTests} passed</span> / <span class="test-count fail">${failedTests} failed</span>
                                                    </span>
                                                </div>
                                                <div class="api-report-badges">
                                                    <span class="status-badge ${api.result.toLowerCase()}">${api.result}</span>
                                                </div>
                                            </div>
                                            <div class="api-report-details expanded" id="api-details-${report.runId}-${api.apiId}">
                                                <h6 class="test-cases-title">Test Cases (${totalTests})</h6>
                                                <div class="test-cases-list">
                                                    ${(api.ruleResults || []).map(rule => `
                                                        <div class="test-case-item ${rule.result.toLowerCase()}">
                                                            <div class="test-case-header">
                                                                <span class="test-case-icon">${rule.result === 'PASS' ? '✓' : '✗'}</span>
                                                                <span class="test-case-name">${escapeHtml(rule.rule_name)}</span>
                                                                <span class="test-case-type">${rule.rule_type || ''}</span>
                                                            </div>
                                                            <div class="test-case-details">
                                                                <div class="test-case-row">
                                                                    <span class="label">Expected:</span>
                                                                    <span class="value expected">${escapeHtml(rule.expected || '-')}</span>
                                                                </div>
                                                                <div class="test-case-row">
                                                                    <span class="label">Actual:</span>
                                                                    <span class="value actual ${rule.result === 'FAIL' ? 'fail' : ''}">${escapeHtml(rule.actual || '-')}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `).join('')}
                        <div class="report-actions">
                            ${report.failed > 0 ? `<button class="btn btn-secondary btn-sm" onclick="rerunFailed('${report.runId}')">Re-run Failed</button>` : ''}
                            <button class="btn btn-primary btn-sm" onclick="viewReport('${report.runId}')">Web View</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport('${report.runId}')">Delete</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function toggleReportDetails(runId) {
            const details = document.getElementById(`details-${runId}`);
            details.classList.toggle('expanded');
        }

        function toggleModule(moduleId) {
            const moduleApis = document.getElementById(`module-${moduleId}`);
            moduleApis.classList.toggle('expanded');
        }

        function toggleApiDetails(apiId) {
            const apiDetails = document.getElementById(`api-details-${apiId}`);
            apiDetails.classList.toggle('expanded');
        }

        async function rerunFailed(runId) {
            try {
                const response = await fetch(`/api/reports/${runId}`);
                const data = await response.json();

                if (data.success) {
                    const failedIds = data.report.results
                        .filter(r => r.result === 'FAIL')
                        .map(r => r.apiId);

                    selectedApis = new Set(failedIds);
                    await runSelectedApis();
                }
            } catch (error) {
                showToast('Failed to re-run tests', 'error');
            }
        }

        async function viewReport(runId) {
            try {
                const response = await fetch(`/api/reports/${runId}`);
                const data = await response.json();

                if (data.success && data.report) {
                    // Use combined report if available, otherwise fall back to first API's report
                    const htmlPath = data.report.htmlReport || data.report.results[0]?.reportPaths?.html;
                    if (htmlPath) {
                        window.open(`/output/${htmlPath}`, '_blank');
                    } else {
                        showToast('No HTML report available', 'error');
                    }
                }
            } catch (error) {
                showToast('Failed to open report', 'error');
            }
        }

        async function deleteReport(runId) {
            if (!confirm('Delete this report?')) return;

            try {
                const response = await fetch(`/api/reports/${runId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast('Report deleted');
                    loadReports();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete report', 'error');
            }
        }

        // =============================================================================
        // Dashboard Functions
        // =============================================================================
        async function loadDashboard() {
            updateDashboardStats();
            await loadLastExecution();
        }

        async function updateDashboardStats() {
            // Calculate totals from sections data
            const totalModules = sections.length;
            let totalApis = 0;

            sections.forEach(section => {
                totalApis += section.apis ? section.apis.length : 0;
            });

            // Update DOM
            document.getElementById('dash-total-modules').textContent = totalModules;
            document.getElementById('dash-total-apis').textContent = totalApis;

            // Get test cases count from last report (actual executed test cases)
            try {
                const response = await fetch('/api/reports?limit=1');
                const data = await response.json();
                if (data.success && data.reports && data.reports.length > 0) {
                    const lastReport = data.reports[0];
                    let totalTestCases = 0;
                    if (lastReport.results) {
                        lastReport.results.forEach(api => {
                            totalTestCases += (api.ruleResults || []).length;
                        });
                    }
                    document.getElementById('dash-total-rules').textContent = totalTestCases;
                } else {
                    document.getElementById('dash-total-rules').textContent = '0';
                }
            } catch (error) {
                console.error('Failed to get test cases count:', error);
                document.getElementById('dash-total-rules').textContent = '0';
            }
        }

        let latestReportId = null;

        async function loadLastExecution() {
            try {
                const response = await fetch('/api/reports?limit=1');
                const data = await response.json();

                if (data.success && data.reports && data.reports.length > 0) {
                    const lastReport = data.reports[0];
                    latestReportId = lastReport.runId;
                    renderLastExecution(lastReport);
                    updateLastRunStatus(lastReport);
                    // Show the View Full Report button
                    document.getElementById('view-report-btn').style.display = 'inline-flex';
                } else {
                    // No reports yet
                    document.getElementById('dash-last-status').textContent = '--';
                    document.getElementById('dash-last-status').className = 'stat-card-value';
                    document.getElementById('view-report-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load last execution:', error);
            }
        }

        function viewLatestReport() {
            if (latestReportId) {
                viewReport(latestReportId);
            }
        }

        function openReportInNewTab(runId) {
            viewReport(runId);
        }

        async function openReportAndScrollToApi(runId, apiId) {
            try {
                const response = await fetch(`/api/reports/${runId}`);
                const data = await response.json();

                if (data.success && data.report) {
                    const htmlPath = data.report.htmlReport || data.report.results[0]?.reportPaths?.html;
                    if (htmlPath) {
                        // Open with hash anchor to scroll to specific API
                        window.open(`/output/${htmlPath}#${apiId}`, '_blank');
                    } else {
                        showToast('No HTML report available', 'error');
                    }
                }
            } catch (error) {
                showToast('Failed to open report', 'error');
            }
        }

        function updateLastRunStatus(report) {
            const statusEl = document.getElementById('dash-last-status');
            const cardEl = document.getElementById('dash-status-card');
            if (report.passed !== undefined && report.totalApis > 0) {
                const percentage = Math.round((report.passed / report.totalApis) * 100);
                statusEl.textContent = percentage + '% Passed';
                statusEl.className = 'stat-card-value ' + (percentage >= 80 ? 'success' : 'danger');
                // Update card color
                cardEl.className = 'stat-card ' + (percentage >= 80 ? 'green' : 'red');
            } else {
                statusEl.textContent = '--';
                statusEl.className = 'stat-card-value';
                cardEl.className = 'stat-card';
            }
        }

        function renderLastExecution(report) {
            const container = document.getElementById('dash-last-execution');
            const date = new Date(report.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
            const formattedTime = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const runId = report.runId;

            // Calculate total test cases from all API results
            let totalTestCases = 0;
            if (report.results) {
                report.results.forEach(api => {
                    totalTestCases += (api.ruleResults || []).length;
                });
            }

            // Build summary chart HTML
            const totalApis = report.totalApis || 0;
            const passed = report.passed || 0;
            const failed = report.failed || 0;
            const passRate = totalApis > 0 ? Math.round((passed / totalApis) * 100) : 0;
            const passAngle = totalApis > 0 ? (passed / totalApis) * 360 : 0;

            const chartHtml = `
                <div class="run-summary-chart">
                    <div class="chart-container">
                        <div class="donut-chart" style="background: conic-gradient(#27ae60 0deg ${passAngle}deg, #e74c3c ${passAngle}deg 360deg);">
                            <div class="donut-hole">
                                <span class="donut-percent">${passRate}%</span>
                                <span class="donut-label">Pass Rate</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="legend-color passed"></span>
                            <span class="legend-label">Passed</span>
                            <span class="legend-value">${passed}</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color failed"></span>
                            <span class="legend-label">Failed</span>
                            <span class="legend-value">${failed}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = `
                <div class="execution-stats-row">
                    <div class="exec-stat-card">
                        <div class="exec-stat-icon">📅</div>
                        <div class="exec-stat-value">${formattedDate}</div>
                        <div class="exec-stat-label">${formattedTime}</div>
                    </div>
                    <div class="exec-stat-card">
                        <div class="exec-stat-icon">🔢</div>
                        <div class="exec-stat-value">${report.totalApis || 0}</div>
                        <div class="exec-stat-label">APIs Run</div>
                    </div>
                    <div class="exec-stat-card">
                        <div class="exec-stat-icon">📋</div>
                        <div class="exec-stat-value">${totalTestCases}</div>
                        <div class="exec-stat-label">Test Cases</div>
                    </div>
                    <div class="exec-stat-card passed">
                        <div class="exec-stat-icon">✓</div>
                        <div class="exec-stat-value">${report.passed || 0}</div>
                        <div class="exec-stat-label">Passed</div>
                    </div>
                    <div class="exec-stat-card failed">
                        <div class="exec-stat-icon">✗</div>
                        <div class="exec-stat-value">${report.failed || 0}</div>
                        <div class="exec-stat-label">Failed</div>
                    </div>
                </div>
                ${chartHtml}
            `;
        }

        function viewApiInReport(runId, apiId) {
            // Switch to reports tab and view the specific report, then scroll to API
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector('[data-tab="reports"]').classList.add('active');
            document.getElementById('reports').classList.add('active');

            loadReports().then(() => {
                viewReport(runId);
                // Wait for modal to open then scroll to the API
                setTimeout(() => {
                    const apiElement = document.querySelector(`[data-api-id="${apiId}"]`);
                    if (apiElement) {
                        apiElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        apiElement.style.animation = 'highlightPulse 2s ease';
                    }
                }, 500);
            });
        }

        async function rerunSingleApi(apiId) {
            try {
                showToast('Running API...', 'success');
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiIds: [apiId] })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('API executed successfully!', 'success');
                    await loadSections();
                    await loadDashboard();
                } else {
                    showToast('Failed to run API: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error running API:', error);
                showToast('Error running API', 'error');
            }
        }

        function viewDashboardReport(runId) {
            // Switch to reports tab and open the report
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector('[data-tab="reports"]').classList.add('active');
            document.getElementById('reports').classList.add('active');

            loadReports().then(() => {
                viewReport(runId);
            });
        }

        async function runAllApis() {
            // Collect all API IDs
            const allApiIds = [];
            sections.forEach(section => {
                section.apis?.forEach(api => {
                    allApiIds.push(api.id);
                });
            });

            if (allApiIds.length === 0) {
                showToast('No APIs to run', 'error');
                return;
            }

            // Get the button and show loading state
            const btn = document.querySelector('.dashboard-actions .btn-secondary');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span>Running...';

            // Show execution logs modal
            const logsModal = document.getElementById('execution-logs-modal');
            const logsContainer = document.getElementById('execution-logs');
            const summaryContainer = document.getElementById('execution-summary');
            logsContainer.innerHTML = `
                <div class="log-entry running">
                    <span class="log-icon"></span>
                    <span class="log-text">Running ${allApiIds.length} APIs...</span>
                </div>
            `;
            summaryContainer.innerHTML = '';
            logsModal.classList.add('active');

            try {
                // Run all APIs in a single batch request
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiIds: allApiIds })
                });

                const data = await response.json();

                if (data.success) {
                    // Show completion
                    logsContainer.innerHTML = `
                        <div class="log-entry pass">
                            <span class="log-icon"></span>
                            <span class="log-text">Completed running ${allApiIds.length} APIs</span>
                        </div>
                    `;

                    // Reload dashboard data
                    await loadDashboard();
                    await loadSections();

                    // Close modal after short delay
                    setTimeout(() => {
                        closeExecutionLogs();
                    }, 1500);
                } else {
                    showToast('Failed to run APIs: ' + (data.error || 'Unknown error'), 'error');
                    closeExecutionLogs();
                }

            } catch (error) {
                console.error('Error running all APIs:', error);
                showToast('Error running APIs', 'error');
                closeExecutionLogs();
            } finally {
                // Restore button
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function closeExecutionLogs() {
            document.getElementById('execution-logs-modal').classList.remove('active');
        }

        // =============================================================================
        // Utilities
        // =============================================================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }
    </script>
    {% endraw %}
</body>
</html>
