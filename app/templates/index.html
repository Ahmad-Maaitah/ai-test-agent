<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test Agent for API | OpenSooq</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .logo-container {
            background: white;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            height: 45px;
            display: block;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header h1 {
            color: white;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header h1 .highlight {
            color: #00d4ff;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            font-weight: 400;
        }

        .header-badge {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #3498db;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        /* Main Content */
        .main-content {
            padding: 20px 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Saved APIs Tab */
        .saved-apis-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }

        /* Sections Panel */
        .sections-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1rem;
            color: #2c3e50;
        }

        .sections-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .section-item {
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .section-item:hover {
            background: #f8f9fa;
        }

        .section-item.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .section-item.dragging {
            opacity: 0.5;
        }

        .section-name {
            font-weight: 500;
            flex: 1;
        }

        .section-count {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }

        .section-actions {
            display: none;
            gap: 5px;
        }

        .section-item:hover .section-actions {
            display: flex;
        }

        .section-item:hover .section-count {
            display: none;
        }

        /* APIs Panel */
        .apis-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .apis-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .apis-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .apis-header h3 {
            font-size: 1rem;
            color: #2c3e50;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .apis-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .api-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .api-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .api-item.dragging {
            opacity: 0.5;
        }

        .api-checkbox {
            margin-right: 15px;
        }

        .api-info {
            flex: 1;
        }

        .api-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .api-curl {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 500px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .status-code {
            font-size: 12px;
            color: #7f8c8d;
        }

        .api-actions {
            display: flex;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-allure {
            background: linear-gradient(135deg, #f05b5b, #eb3d3d);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-allure:hover {
            background: linear-gradient(135deg, #eb3d3d, #d32f2f);
        }

        .allure-icon {
            background: white;
            color: #eb3d3d;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #d5dbdb;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 5px 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #7f8c8d;
            border-radius: 4px;
        }

        .btn-icon:hover {
            background: #f0f0f0;
            color: #2c3e50;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Run Bar */
        .run-bar {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .selected-count {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.modal-wide {
            max-width: 900px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
        }

        /* Test Result in Modal */
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .test-result h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        /* Reports Tab */
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            color: #7f8c8d;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .report-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .report-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .report-header:hover {
            background: #f8f9fa;
        }

        .report-info h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .report-meta {
            font-size: 13px;
            color: #7f8c8d;
        }

        .report-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.pass {
            color: #27ae60;
        }

        .stat-value.fail {
            color: #e74c3c;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .report-details {
            display: none;
            border-top: 1px solid #eee;
        }

        .report-details.expanded {
            display: block;
        }

        /* Module-based Reports */
        .module-group {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .module-header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .module-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .module-stats {
            display: flex;
            gap: 15px;
        }

        .module-stat {
            font-size: 0.85rem;
        }

        .module-stat.pass { color: #4ade80; }
        .module-stat.fail { color: #f87171; }

        .module-apis {
            display: none;
        }

        .module-apis.expanded {
            display: block;
        }

        .api-report-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .api-report-item:last-child {
            border-bottom: none;
        }

        .api-report-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .api-report-header:hover {
            background: #f8f9fa;
        }

        .api-report-info h5 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .api-report-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .api-report-badges {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-report-details {
            display: none;
            padding: 0 20px 20px;
            background: #f8f9fa;
        }

        .api-report-details.expanded {
            display: block;
        }

        /* Rule Logs */
        .rule-logs {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .rule-log-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 80px;
            gap: 15px;
            align-items: center;
        }

        .rule-log-item:last-child {
            border-bottom: none;
        }

        .rule-log-item.header {
            background: #ecf0f1;
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
        }

        .rule-log-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .rule-log-type {
            font-size: 11px;
            color: #7f8c8d;
        }

        .log-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #333;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-word;
        }

        .log-value.expected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .log-value.actual {
            background: #fff3e0;
            color: #e65100;
        }

        .log-value.actual.fail {
            background: #ffebee;
            color: #c62828;
        }

        .report-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Test Cases */
        .test-count.pass { color: #27ae60; font-weight: 600; }
        .test-count.fail { color: #e74c3c; font-weight: 600; }

        .test-cases-title {
            margin: 0 0 10px 0;
            padding: 10px 15px;
            background: #ecf0f1;
            font-size: 13px;
            color: #2c3e50;
            border-radius: 6px 6px 0 0;
        }

        .test-cases-list {
            background: white;
            border-radius: 0 0 6px 6px;
        }

        .test-case-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            border-left: 4px solid #27ae60;
        }

        .test-case-item:last-child {
            border-bottom: none;
        }

        .test-case-item.fail {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .test-case-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .test-case-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .test-case-item.pass .test-case-icon { color: #27ae60; }
        .test-case-item.fail .test-case-icon { color: #e74c3c; }

        .test-case-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .test-case-type {
            font-size: 11px;
            color: white;
            background: #7f8c8d;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .test-case-details {
            margin-left: 26px;
        }

        .test-case-row {
            display: flex;
            gap: 10px;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .test-case-row .label {
            color: #7f8c8d;
            min-width: 70px;
        }

        .test-case-row .value {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #2c3e50;
        }

        .test-case-row .value.expected {
            color: #27ae60;
        }

        .test-case-row .value.actual.fail {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Rules Builder */
        .rules-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .rules-section.hidden {
            display: none;
        }

        .response-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .response-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .response-meta span {
            padding: 4px 10px;
            background: #ecf0f1;
            border-radius: 4px;
        }

        .response-meta .status-ok { background: #d4edda; color: #155724; }
        .response-meta .status-error { background: #f8d7da; color: #721c24; }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rules-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rule-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .rule-card.invalid {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .rule-card.valid {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .rule-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rule-card-header .rule-number {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
        }

        .rule-card-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .rule-card-row.single {
            grid-template-columns: 1fr;
        }

        .rule-card-row label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .rule-card-row select,
        .rule-card-row input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .rule-validation-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .rule-validation-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .rule-validation-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .rules-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .empty-rules {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Create API Full Page Layout */
        .create-api-layout {
            display: grid;
            grid-template-columns: 250px 1fr 350px;
            gap: 0;
            height: calc(100vh - 180px);
            background: #f5f5f5;
        }

        .create-api-header {
            background: white;
            padding: 15px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -20px -30px 20px -30px;
        }

        .create-api-header h2 {
            font-size: 1.3rem;
            color: #2c3e50;
        }

        .create-api-header .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Left Panel */
        .left-panel {
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .left-panel h4 {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        .left-panel h4:first-child {
            margin-top: 0;
        }

        .left-panel .form-group {
            margin-bottom: 15px;
        }

        .left-panel .form-group label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .left-panel .form-group input,
        .left-panel .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-action-btn {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .quick-action-btn .icon {
            width: 20px;
            text-align: center;
        }

        .field-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }

        .field-item {
            padding: 8px 12px;
            font-size: 12px;
            font-family: monospace;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .field-item:last-child {
            border-bottom: none;
        }

        .field-item:hover {
            background: #e3f2fd;
        }

        /* Center Panel */
        .center-panel {
            padding: 20px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .curl-editor-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .curl-editor-section h4 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1rem;
        }

        .curl-editor {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            resize: vertical;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .curl-editor-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }

        .rules-section-full {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .rules-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rules-section-header h4 {
            color: #2c3e50;
            font-size: 1rem;
        }

        .rules-list-full {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rule-card-full {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            transition: all 0.2s;
        }

        .rule-card-full.valid {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .rule-card-full.invalid {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .rule-card-full .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rule-card-full .rule-header .rule-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rule-card-full .rule-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .rule-card-full .rule-fields label {
            display: block;
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .rule-card-full .rule-fields select,
        .rule-card-full .rule-fields input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .rule-card-full .validation-result {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .rule-card-full .validation-result.pass {
            background: #d4edda;
            color: #155724;
        }

        .rule-card-full .validation-result.fail {
            background: #f8d7da;
            color: #721c24;
        }

        /* Right Panel */
        .right-panel {
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .right-panel-header h4 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .response-meta-full {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .response-meta-full .meta-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .response-meta-full .meta-badge.status-ok {
            background: #d4edda;
            color: #155724;
        }

        .response-meta-full .meta-badge.status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .response-meta-full .meta-badge.neutral {
            background: #e9ecef;
            color: #495057;
        }

        .response-json {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #1e1e1e;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #d4d4d4;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .response-json.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            background: #f5f5f5;
        }

        .fields-section {
            border-top: 1px solid #eee;
            padding: 15px 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .fields-section h5 {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        /* Status Bar */
        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 10px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin: 20px -30px -20px -30px;
        }

        .status-bar .status-left {
            display: flex;
            gap: 20px;
        }

        .status-bar .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-bar .status-item.pass {
            color: #2ecc71;
        }

        .status-bar .status-item.fail {
            color: #e74c3c;
        }

        .empty-rules-full {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #e0e0e0;
        }

        .empty-rules-full p {
            margin-bottom: 15px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #27ae60;
        }

        .toast.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drag handle */
        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: #bdc3c7;
            margin-right: 10px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <img src="https://media.licdn.com/dms/image/v2/D4D3DAQGr3Y_cI3wCZw/image-scale_191_1128/B4DZv.wy5vGgAg-/0/1769505763568/opensooq_cover?e=1771243200&v=beta&t=kdbeMvd0tzTXioTgCxzDTf7PdGyDCwn4M0fYYK8qXFs" alt="OpenSooq Logo" class="logo">
        </div>
        <div class="header-text">
            <h1><span class="highlight">AI Test Agent</span> for API</h1>
            <span class="header-subtitle">Automated API Testing & Validation Platform</span>
        </div>
        <span class="header-badge">OpenSooq</span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="saved-apis">Saved APIs</div>
        <div class="tab" data-tab="create-api">Create API</div>
        <div class="tab" data-tab="reports">Reports</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Saved APIs Tab -->
        <div id="saved-apis" class="tab-content active">
            <div class="saved-apis-layout">
                <!-- Modules Panel -->
                <div class="sections-panel">
                    <div class="panel-header">
                        <h3>Modules</h3>
                        <button class="btn btn-primary btn-sm" onclick="openAddSectionModal()">+ Add</button>
                    </div>
                    <div class="sections-list" id="sections-list">
                        <!-- Modules loaded dynamically -->
                    </div>
                </div>

                <!-- APIs Panel -->
                <div class="apis-panel">
                    <div class="apis-header">
                        <div class="apis-header-left">
                            <h3 id="current-section-name">All APIs</h3>
                            <div class="select-all-container">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                <label for="select-all">Select All</label>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="openCreateApiPage()">+ Add API</button>
                    </div>
                    <div class="apis-list" id="apis-list">
                        <!-- APIs loaded dynamically -->
                    </div>
                    <div class="run-bar">
                        <span class="selected-count"><span id="selected-count">0</span> APIs selected</span>
                        <button class="btn btn-primary" id="run-btn" onclick="runSelectedApis()" disabled>Run Selected</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create API Tab -->
        <div id="create-api" class="tab-content">
            <div class="create-api-header">
                <h2 id="create-api-title">Create New API</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="cancelCreateApi()">Cancel</button>
                    <button class="btn btn-success" id="page-save-btn" onclick="saveApiFromPage()" disabled>Save API</button>
                </div>
            </div>

            <div class="create-api-layout">
                <!-- Left Panel -->
                <div class="left-panel">
                    <h4>API Details</h4>
                    <div class="form-group">
                        <label>Module <span style="color: #e74c3c;">*</span></label>
                        <div style="display: flex; gap: 8px;">
                            <select id="page-api-section" style="flex: 1;">
                                <!-- Populated dynamically -->
                            </select>
                            <button class="btn btn-sm" onclick="openAddModuleInline()" title="Add New Module" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
                        </div>
                        <div id="inline-add-module" style="display: none; margin-top: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="inline-module-name" placeholder="New module name..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="btn btn-sm btn-success" onclick="saveInlineModule()" style="padding: 8px 12px;">Save</button>
                                <button class="btn btn-sm" onclick="cancelInlineModule()" style="padding: 8px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>API Name <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="page-api-name" placeholder="e.g., Get User Profile" required>
                    </div>

                    <h4>Quick Add Rules</h4>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickAddRule('status_code')">
                            <span class="icon">üìä</span> Status Code Check
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('response_time')">
                            <span class="icon">‚è±Ô∏è</span> Response Time Check
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('field_exists')">
                            <span class="icon">üîç</span> Field Exists
                        </button>
                        <button class="quick-action-btn" onclick="quickAddRule('field_type')">
                            <span class="icon">üè∑Ô∏è</span> Field Type Check
                        </button>
                    </div>

                    <h4>Response Fields</h4>
                    <input type="text" id="page-field-search" placeholder="Search fields..." oninput="filterPageFields()" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <div class="field-list" id="page-field-list">
                        <div class="field-item" style="color: #7f8c8d; cursor: default;">Execute cURL to see fields</div>
                    </div>
                </div>

                <!-- Center Panel -->
                <div class="center-panel">
                    <div class="curl-editor-section">
                        <h4>cURL Command <span style="color: #e74c3c; font-size: 12px;">*</span></h4>
                        <textarea class="curl-editor" id="page-curl" placeholder="curl https://api.example.com/endpoint -H 'Content-Type: application/json'" required></textarea>
                        <div class="curl-editor-actions">
                            <button class="btn btn-primary" onclick="executePageCurl()" id="page-execute-btn">Execute & Parse Response</button>
                        </div>
                    </div>

                    <div class="rules-section-full" id="page-rules-section">
                        <!-- New Rule Builder -->
                        <div class="new-rule-builder" id="new-rule-builder" style="background: #e8f4fd; border: 2px dashed #2196f3; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: #1976d2;">Create New Test Rule <span style="color: #e74c3c; font-size: 12px;">*</span></h4>
                            <div class="rule-fields" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                                <div style="min-width: 220px; flex: 1;">
                                    <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">Rule Type</label>
                                    <select id="new-rule-type" onchange="onNewRuleTypeChange()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Select Rule Type --</option>
                                    </select>
                                </div>
                                <div id="new-rule-field-container" style="min-width: 220px; flex: 1; position: relative;">
                                    <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">Field (type to search)</label>
                                    <input type="text" id="new-rule-field-search" placeholder="Search or select field..."
                                        oninput="filterNewRuleFields()"
                                        onfocus="showFieldDropdown()"
                                        onblur="hideFieldDropdown()"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <input type="hidden" id="new-rule-field" value="">
                                    <div id="new-rule-field-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100;">
                                        <!-- Field options populated dynamically -->
                                    </div>
                                </div>
                                <div id="new-rule-config-container" style="display: flex; gap: 15px; flex-wrap: wrap; flex: 1;">
                                    <!-- Config fields populated dynamically -->
                                </div>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="testNewRule()" id="test-new-rule-btn">Test Rule</button>
                                <button class="btn btn-success" onclick="addTestedRule()" id="add-rule-btn" disabled>+ Add Rule</button>
                                <span id="new-rule-test-result" style="font-size: 13px;"></span>
                            </div>
                            <p style="margin-top: 10px; font-size: 11px; color: #7f8c8d;">Rules must be tested and pass before they can be added.</p>
                        </div>

                        <!-- Saved Rules List -->
                        <div class="rules-section-header">
                            <h4>Saved Test Rules <span id="page-rules-count">(0)</span></h4>
                        </div>
                        <div class="rules-list-full" id="page-rules-list">
                            <div class="empty-rules-full">
                                <p>No test rules yet</p>
                                <span>Create a rule above, test it, then add it to your test cases</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="right-panel">
                    <div class="right-panel-header">
                        <h4>Response Preview</h4>
                        <div class="response-meta-full" id="page-response-meta">
                            <span class="meta-badge neutral">No response yet</span>
                        </div>
                    </div>
                    <div class="response-json empty" id="page-response-json">
                        Execute cURL to see response
                    </div>
                    <div class="fields-section">
                        <h5>Available Fields (<span id="page-fields-count">0</span>)</h5>
                        <input type="text" id="page-field-search-right" placeholder="Search..." oninput="filterPageFieldsRight()" style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                        <div id="page-fields-list-right">
                            <span style="color: #7f8c8d; font-size: 12px;">No fields extracted yet</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-bar" id="page-status-bar">
                <div class="status-left">
                    <div class="status-item" id="page-status-rules">
                        <span>Rules: 0</span>
                    </div>
                    <div class="status-item" id="page-status-validated">
                        <span>Not validated</span>
                    </div>
                </div>
                <div class="status-right">
                    <span id="page-status-message">Enter cURL command and execute to start</span>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="reports-header">
                <h2>Test Reports</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label>Module:</label>
                        <select id="filter-section" onchange="loadReports()">
                            <option value="">All Modules</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Result:</label>
                        <select id="filter-result" onchange="loadReports()">
                            <option value="">All Results</option>
                            <option value="PASS">Pass Only</option>
                            <option value="FAIL">Fail Only</option>
                        </select>
                    </div>
                    <button class="btn btn-allure" onclick="openAllureReport()">
                        <span class="allure-icon">A</span> View Allure Report
                    </button>
                </div>
            </div>
            <div class="reports-list" id="reports-list">
                <!-- Reports loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="modal-overlay" id="section-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="section-modal-title">Add Module</h2>
                <button class="modal-close" onclick="closeSectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="section-name">Module Name</label>
                    <input type="text" id="section-name" placeholder="e.g., User APIs, Payment APIs">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSection()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit API Modal -->
    <div class="modal-overlay" id="api-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2 id="api-modal-title">Add API</h2>
                <button class="modal-close" onclick="closeApiModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="api-section">Module</label>
                    <select id="api-section">
                        <!-- Modules loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-name">API Name</label>
                    <input type="text" id="api-name" placeholder="e.g., Get User Profile">
                </div>
                <div class="form-group">
                    <label for="api-curl">cURL Command</label>
                    <textarea id="api-curl" placeholder="curl https://api.example.com/endpoint -H 'Content-Type: application/json'"></textarea>
                </div>
                <button class="btn btn-primary" onclick="executeAndParseCurl()" id="execute-curl-btn">Execute & Parse Response</button>

                <!-- Rules Builder Section -->
                <div class="rules-section hidden" id="rules-section">
                    <div class="response-meta" id="response-meta"></div>
                    <details>
                        <summary style="cursor: pointer; margin-bottom: 10px; color: #7f8c8d;">View Response JSON</summary>
                        <div class="response-preview" id="response-preview"></div>
                    </details>

                    <div class="rules-header">
                        <h4>Test Rules</h4>
                        <button class="btn btn-sm btn-success" onclick="addRule()">+ Add Rule</button>
                    </div>

                    <div class="rules-list" id="rules-list">
                        <div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>
                    </div>

                    <div class="rules-actions">
                        <button class="btn btn-secondary" onclick="validateRules()" id="validate-rules-btn">Validate Rules</button>
                        <span id="validation-status" style="font-size: 13px; color: #7f8c8d;"></span>
                    </div>
                </div>

                <!-- Legacy test result (hidden, for backward compatibility) -->
                <div class="test-result" id="modal-test-result" style="display: none;">
                    <h4>Test Results</h4>
                    <div id="modal-rules-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApiModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveApi()" id="save-api-btn" disabled>Save API</button>
            </div>
        </div>
    </div>

    <!-- Running Modal -->
    <div class="modal-overlay" id="running-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <span id="running-status">Running tests...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let sections = [];
        let currentSectionId = null;
        let selectedApis = new Set();
        let editingApiId = null;
        let editingSectionId = null;

        // Rules Builder State
        let ruleTypes = {};
        let customRules = [];
        let availableFields = [];
        let lastResponse = null;
        let rulesValidated = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSections();
            setupTabs();
            loadRuleTypes();
        });

        // Load rule types from backend
        async function loadRuleTypes() {
            try {
                const response = await fetch('/api/rule-types');
                const data = await response.json();
                if (data.success) {
                    ruleTypes = data.ruleTypes;
                }
            } catch (error) {
                console.error('Failed to load rule types:', error);
            }
        }

        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');

                    if (tab.dataset.tab === 'reports') {
                        loadReports();
                    }
                });
            });
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================================================
        // Sections
        // =============================================================================
        async function loadSections() {
            try {
                const response = await fetch('/api/sections');
                const data = await response.json();

                if (data.success) {
                    sections = data.sections;
                    renderSections();
                    populateSectionDropdowns();

                    if (sections.length > 0 && !currentSectionId) {
                        selectSection(sections[0].id);
                    } else if (currentSectionId) {
                        renderApis();
                    }
                }
            } catch (error) {
                showToast('Failed to load modules', 'error');
            }
        }

        function renderSections() {
            const container = document.getElementById('sections-list');

            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No modules yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sections.map(section => `
                <div class="section-item ${currentSectionId === section.id ? 'active' : ''}"
                     data-id="${section.id}"
                     draggable="true"
                     onclick="selectSection('${section.id}')">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="section-name">${escapeHtml(section.name)}</span>
                    <span class="section-count">${section.apis.length}</span>
                    <div class="section-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); editSection('${section.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteSection('${section.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            setupSectionDragDrop();
        }

        function selectSection(sectionId) {
            currentSectionId = sectionId;
            renderSections();
            renderApis();

            const section = sections.find(s => s.id === sectionId);
            document.getElementById('current-section-name').textContent = section ? section.name : 'All APIs';
        }

        function openAddSectionModal() {
            editingSectionId = null;
            document.getElementById('section-modal-title').textContent = 'Add Module';
            document.getElementById('section-name').value = '';
            document.getElementById('section-modal').classList.add('active');
        }

        function editSection(sectionId) {
            editingSectionId = sectionId;
            const section = sections.find(s => s.id === sectionId);
            document.getElementById('section-modal-title').textContent = 'Edit Module';
            document.getElementById('section-name').value = section.name;
            document.getElementById('section-modal').classList.add('active');
        }

        function closeSectionModal() {
            document.getElementById('section-modal').classList.remove('active');
        }

        async function saveSection() {
            const name = document.getElementById('section-name').value.trim();

            if (!name) {
                showToast('Module name is required', 'error');
                return;
            }

            try {
                let response;
                if (editingSectionId) {
                    response = await fetch(`/api/sections/${editingSectionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                } else {
                    response = await fetch('/api/sections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(editingSectionId ? 'Module updated' : 'Module created');
                    closeSectionModal();
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save module', 'error');
            }
        }

        async function deleteSection(sectionId) {
            if (!confirm('Delete this module and all its APIs?')) return;

            try {
                const response = await fetch(`/api/sections/${sectionId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast('Module deleted');
                    if (currentSectionId === sectionId) {
                        currentSectionId = sections[0]?.id || null;
                    }
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete module', 'error');
            }
        }

        function setupSectionDragDrop() {
            const items = document.querySelectorAll('.section-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.section-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            item.parentNode.insertBefore(dragging, item);
                        } else {
                            item.parentNode.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                item.addEventListener('drop', async () => {
                    const newOrder = Array.from(document.querySelectorAll('.section-item'))
                        .map(el => el.dataset.id);

                    try {
                        await fetch('/api/sections/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sectionIds: newOrder })
                        });
                        loadSections();
                    } catch (error) {
                        showToast('Failed to reorder', 'error');
                    }
                });
            });
        }

        // =============================================================================
        // APIs
        // =============================================================================
        function renderApis() {
            const container = document.getElementById('apis-list');
            const section = sections.find(s => s.id === currentSectionId);
            const apis = section ? section.apis : [];

            if (apis.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No APIs in this section</h3>
                        <p>Click "+ Add API" or use the "Create API" tab</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = apis.map(api => {
                const rulesCount = (api.customRules || []).length;
                const hasRules = rulesCount > 0;
                return `
                <div class="api-item" data-id="${api.id}" draggable="true">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="api-checkbox"
                           ${selectedApis.has(api.id) ? 'checked' : ''}
                           onchange="toggleApiSelection('${api.id}')">
                    <div class="api-info">
                        <div class="api-name">
                            ${escapeHtml(api.name)}
                            ${hasRules ? `<span style="font-size: 11px; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">${rulesCount} rules</span>` : ''}
                        </div>
                        <div class="api-curl">${escapeHtml(api.curl)}</div>
                    </div>
                    <div class="api-actions">
                        <button class="btn-icon" onclick="openEditApiPage('${api.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteApi('${api.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `}).join('');

            setupApiDragDrop();
            updateSelectedCount();
        }

        function toggleApiSelection(apiId) {
            if (selectedApis.has(apiId)) {
                selectedApis.delete(apiId);
            } else {
                selectedApis.add(apiId);
            }
            updateSelectedCount();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const section = sections.find(s => s.id === currentSectionId);
            const apis = section ? section.apis : [];

            if (selectAllCheckbox.checked) {
                apis.forEach(api => selectedApis.add(api.id));
            } else {
                apis.forEach(api => selectedApis.delete(api.id));
            }

            renderApis();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedApis.size;
            document.getElementById('run-btn').disabled = selectedApis.size === 0;
        }

        function populateSectionDropdowns() {
            const apiSectionSelect = document.getElementById('api-section');
            const filterSectionSelect = document.getElementById('filter-section');

            const options = sections.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');

            apiSectionSelect.innerHTML = options;
            filterSectionSelect.innerHTML = '<option value="">All Modules</option>' +
                sections.map(s => `<option value="${s.name}">${escapeHtml(s.name)}</option>`).join('');

            if (currentSectionId) {
                apiSectionSelect.value = currentSectionId;
            }
        }

        function openAddApiModal() {
            editingApiId = null;
            document.getElementById('api-modal-title').textContent = 'Add API';
            document.getElementById('api-section').value = currentSectionId || sections[0]?.id;
            document.getElementById('api-name').value = '';
            document.getElementById('api-curl').value = '';
            document.getElementById('modal-test-result').style.display = 'none';
            document.getElementById('save-api-btn').disabled = true;

            // Reset rules builder state
            customRules = [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;
            document.getElementById('rules-section').classList.add('hidden');
            document.getElementById('rules-list').innerHTML = '<div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>';
            document.getElementById('validation-status').textContent = '';

            document.getElementById('api-modal').classList.add('active');
        }

        function editApi(apiId) {
            editingApiId = apiId;
            let api, sectionId;

            for (const section of sections) {
                const found = section.apis.find(a => a.id === apiId);
                if (found) {
                    api = found;
                    sectionId = section.id;
                    break;
                }
            }

            if (!api) return;

            document.getElementById('api-modal-title').textContent = 'Edit API';
            document.getElementById('api-section').value = sectionId;
            document.getElementById('api-name').value = api.name;
            document.getElementById('api-curl').value = api.curl;
            document.getElementById('modal-test-result').style.display = 'none';
            document.getElementById('save-api-btn').disabled = false;

            // Load existing custom rules if any
            customRules = api.customRules ? JSON.parse(JSON.stringify(api.customRules)) : [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;

            // Hide rules section initially - user needs to execute curl to see it
            document.getElementById('rules-section').classList.add('hidden');
            document.getElementById('validation-status').textContent = '';

            // If there are existing rules, show a hint
            if (customRules.length > 0) {
                document.getElementById('rules-section').classList.remove('hidden');
                document.getElementById('response-meta').innerHTML = '<span>Click "Execute & Parse Response" to refresh fields and validate rules</span>';
                document.getElementById('response-preview').textContent = 'Execute cURL to see response';
                document.getElementById('validation-status').textContent = 'Re-validate rules to enable save';
                document.getElementById('validation-status').style.color = '#7f8c8d';
                document.getElementById('save-api-btn').disabled = true;
                renderRules();
            }

            document.getElementById('api-modal').classList.add('active');
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.remove('active');
            // Reset rules builder state
            customRules = [];
            availableFields = [];
            lastResponse = null;
            rulesValidated = false;
        }

        async function testApiInModal() {
            // Legacy function - kept for backward compatibility
            const curl = document.getElementById('api-curl').value.trim();

            if (!curl) {
                showToast('Please enter a cURL command', 'error');
                return;
            }

            const testBtn = document.getElementById('test-api-btn');
            if (testBtn) {
                testBtn.disabled = true;
                testBtn.textContent = 'Testing...';
            }

            try {
                const response = await fetch('/api/run-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    const resultDiv = document.getElementById('modal-test-result');
                    const rulesList = document.getElementById('modal-rules-list');

                    rulesList.innerHTML = data.result.rule_results.map(rule => `
                        <div class="rule-item">
                            <span>${escapeHtml(rule.rule_name)}</span>
                            <span class="status-badge ${rule.result.toLowerCase()}">${rule.result}</span>
                        </div>
                    `).join('');

                    resultDiv.style.display = 'block';
                    document.getElementById('save-api-btn').disabled = false;
                }
            } catch (error) {
                showToast('Test failed: ' + error.message, 'error');
            }

            if (testBtn) {
                testBtn.disabled = false;
                testBtn.textContent = 'Test API';
            }
        }

        // =============================================================================
        // Rules Builder Functions
        // =============================================================================

        async function executeAndParseCurl() {
            const curl = document.getElementById('api-curl').value.trim();

            if (!curl) {
                showToast('Please enter a cURL command', 'error');
                return;
            }

            const btn = document.getElementById('execute-curl-btn');
            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                const response = await fetch('/api/execute-curl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    lastResponse = data.response;
                    availableFields = data.fields || [];

                    // Show response metadata
                    const metaDiv = document.getElementById('response-meta');
                    const statusClass = data.status_code >= 200 && data.status_code < 300 ? 'status-ok' : 'status-error';
                    metaDiv.innerHTML = `
                        <span class="${statusClass}">Status: ${data.status_code}</span>
                        <span>Response Time: ${data.response_time_ms}ms</span>
                        <span>Fields Found: ${availableFields.length}</span>
                    `;

                    // Show response preview
                    const previewDiv = document.getElementById('response-preview');
                    if (data.response) {
                        previewDiv.textContent = JSON.stringify(data.response, null, 2);
                    } else {
                        previewDiv.textContent = data.response_text || 'No JSON response';
                    }

                    // Show rules section
                    document.getElementById('rules-section').classList.remove('hidden');

                    // If no custom rules exist, add a default status_code rule
                    if (customRules.length === 0) {
                        addRule('status_code');
                    } else {
                        renderRules();
                    }

                    // Save button remains disabled until rules are validated
                    document.getElementById('save-api-btn').disabled = true;
                    rulesValidated = false;
                    document.getElementById('validation-status').textContent = 'Click "Validate Rules" to enable save';
                    document.getElementById('validation-status').style.color = '#7f8c8d';

                    showToast('Response parsed successfully - validate rules to save');
                } else {
                    showToast(data.error || 'Failed to execute cURL', 'error');
                }
            } catch (error) {
                showToast('Failed to execute cURL: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Execute & Parse Response';
        }

        function generateRuleId() {
            return 'rule-' + Math.random().toString(36).substr(2, 9);
        }

        function addRule(defaultType = 'field_exists') {
            const rule = {
                id: generateRuleId(),
                type: defaultType,
                field: availableFields[0] || '',
                config: {},
                enabled: true
            };

            // Set default config values
            const typeConfig = ruleTypes[defaultType];
            if (typeConfig && typeConfig.configFields) {
                typeConfig.configFields.forEach(cf => {
                    if (cf.default !== undefined) {
                        rule.config[cf.name] = cf.default;
                    }
                });
            }

            customRules.push(rule);
            rulesValidated = false;
            renderRules();
        }

        function removeRule(ruleId) {
            customRules = customRules.filter(r => r.id !== ruleId);
            rulesValidated = false;
            renderRules();
        }

        function updateRule(ruleId, field, value) {
            const rule = customRules.find(r => r.id === ruleId);
            if (!rule) return;

            if (field === 'type') {
                rule.type = value;
                // Reset config to defaults for new type
                rule.config = {};
                const typeConfig = ruleTypes[value];
                if (typeConfig && typeConfig.configFields) {
                    typeConfig.configFields.forEach(cf => {
                        if (cf.default !== undefined) {
                            rule.config[cf.name] = cf.default;
                        }
                    });
                }
                // Clear field if not required
                if (typeConfig && !typeConfig.requiresField) {
                    rule.field = '';
                } else if (!rule.field && availableFields.length > 0) {
                    rule.field = availableFields[0];
                }
            } else if (field === 'field') {
                rule.field = value;
            } else {
                // Config field
                rule.config[field] = value;
            }

            rulesValidated = false;
            renderRules();
        }

        function renderRules() {
            const container = document.getElementById('rules-list');

            if (customRules.length === 0) {
                container.innerHTML = '<div class="empty-rules">No rules added yet. Click "+ Add Rule" to create test cases.</div>';
                document.getElementById('validation-status').textContent = '';
                return;
            }

            container.innerHTML = customRules.map((rule, index) => {
                const typeConfig = ruleTypes[rule.type] || {};
                const requiresField = typeConfig.requiresField !== false;

                return `
                    <div class="rule-card" id="rule-card-${rule.id}">
                        <div class="rule-card-header">
                            <span class="rule-number">Rule ${index + 1}</span>
                            <button class="btn-icon" onclick="removeRule('${rule.id}')" title="Remove">üóëÔ∏è</button>
                        </div>
                        <div class="rule-card-row">
                            <div>
                                <label>Rule Type</label>
                                <select onchange="updateRule('${rule.id}', 'type', this.value)">
                                    ${Object.entries(ruleTypes).map(([key, config]) =>
                                        `<option value="${key}" ${rule.type === key ? 'selected' : ''}>${config.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ${requiresField ? `
                            <div>
                                <label>Field</label>
                                <select onchange="updateRule('${rule.id}', 'field', this.value)">
                                    ${availableFields.map(f =>
                                        `<option value="${f}" ${rule.field === f ? 'selected' : ''}>${f}</option>`
                                    ).join('')}
                                    ${rule.field && !availableFields.includes(rule.field) ?
                                        `<option value="${rule.field}" selected>${rule.field}</option>` : ''}
                                </select>
                            </div>
                            ` : '<div></div>'}
                        </div>
                        ${renderConfigFields(rule)}
                    </div>
                `;
            }).join('');

            // Update validation status
            if (!rulesValidated) {
                document.getElementById('validation-status').textContent = 'Rules not validated yet';
            }
        }

        function renderConfigFields(rule) {
            const typeConfig = ruleTypes[rule.type];
            if (!typeConfig || !typeConfig.configFields || typeConfig.configFields.length === 0) {
                return '';
            }

            const fields = typeConfig.configFields.map(cf => {
                const value = rule.config[cf.name] !== undefined ? rule.config[cf.name] : cf.default;

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updateRule('${rule.id}', '${cf.name}', this.value)">
                                ${cf.options.map(opt =>
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updateRule('${rule.id}', '${cf.name}', this.value === 'true')">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="number" value="${value}"
                                   onchange="updateRule('${rule.id}', '${cf.name}', parseInt(this.value) || 0)">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="text" value="${escapeHtml(value || '')}"
                                   onchange="updateRule('${rule.id}', '${cf.name}', this.value)">
                        </div>
                    `;
                }
            });

            return `<div class="rule-card-row ${fields.length === 1 ? 'single' : ''}">${fields.join('')}</div>`;
        }

        async function validateRules() {
            if (customRules.length === 0) {
                showToast('Add at least one rule first', 'error');
                return;
            }

            const btn = document.getElementById('validate-rules-btn');
            btn.disabled = true;
            btn.textContent = 'Validating...';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: document.getElementById('api-curl').value.trim(),
                        rules: customRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update rule cards with validation results
                    data.results.forEach(result => {
                        const card = document.getElementById(`rule-card-${result.rule_id}`);
                        if (card) {
                            card.classList.remove('valid', 'invalid');
                            card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                            // Add or update status badge
                            let statusBadge = card.querySelector('.rule-validation-status');
                            if (!statusBadge) {
                                statusBadge = document.createElement('span');
                                statusBadge.className = 'rule-validation-status';
                                card.querySelector('.rule-card-header').appendChild(statusBadge);
                            }
                            statusBadge.className = `rule-validation-status ${result.result.toLowerCase()}`;
                            statusBadge.textContent = result.result === 'PASS' ?
                                `‚úì ${result.actual || 'PASS'}` :
                                `‚úó ${result.reason || 'FAIL'}`;
                        }
                    });

                    const allPassed = data.results.every(r => r.result === 'PASS');
                    rulesValidated = allPassed;

                    document.getElementById('validation-status').textContent =
                        allPassed ?
                        `‚úì All ${data.results.length} rules passed` :
                        `${data.results.filter(r => r.result === 'PASS').length}/${data.results.length} rules passed`;
                    document.getElementById('validation-status').style.color = allPassed ? '#27ae60' : '#e74c3c';

                    // Only enable save button if all rules pass
                    document.getElementById('save-api-btn').disabled = !allPassed;

                    showToast(allPassed ? 'All rules validated successfully!' : 'Some rules failed - fix them to save');
                } else {
                    showToast(data.error || 'Validation failed', 'error');
                }
            } catch (error) {
                showToast('Validation failed: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Validate Rules';
        }

        async function saveApi() {
            const sectionId = document.getElementById('api-section').value;
            const name = document.getElementById('api-name').value.trim();
            const curl = document.getElementById('api-curl').value.trim();

            if (!name) {
                showToast('API name is required', 'error');
                return;
            }
            if (!curl) {
                showToast('cURL command is required', 'error');
                return;
            }

            // Prepare API data with custom rules
            const apiData = {
                name,
                curl,
                customRules: customRules.length > 0 ? customRules : []
            };

            try {
                let response;
                if (editingApiId) {
                    response = await fetch(`/api/apis/${editingApiId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });

                    // Check if section changed
                    let currentSection;
                    for (const section of sections) {
                        if (section.apis.find(a => a.id === editingApiId)) {
                            currentSection = section.id;
                            break;
                        }
                    }

                    if (currentSection !== sectionId) {
                        await fetch(`/api/apis/${editingApiId}/move`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetSectionId: sectionId })
                        });
                    }
                } else {
                    response = await fetch(`/api/sections/${sectionId}/apis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    const rulesCount = customRules.length;
                    showToast(editingApiId ?
                        `API updated with ${rulesCount} rule(s)` :
                        `API created with ${rulesCount} rule(s)`);
                    closeApiModal();
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save API', 'error');
            }
        }

        async function deleteApi(apiId) {
            if (!confirm('Delete this API?')) return;

            try {
                const response = await fetch(`/api/apis/${apiId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast('API deleted');
                    selectedApis.delete(apiId);
                    loadSections();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete API', 'error');
            }
        }

        function setupApiDragDrop() {
            const items = document.querySelectorAll('.api-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.api-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            item.parentNode.insertBefore(dragging, item);
                        } else {
                            item.parentNode.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                item.addEventListener('drop', async () => {
                    const newOrder = Array.from(document.querySelectorAll('.api-item'))
                        .map(el => el.dataset.id);

                    try {
                        await fetch(`/api/sections/${currentSectionId}/apis/reorder`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ apiIds: newOrder })
                        });
                        loadSections();
                    } catch (error) {
                        showToast('Failed to reorder', 'error');
                    }
                });
            });
        }

        // =============================================================================
        // Run APIs
        // =============================================================================
        async function runSelectedApis() {
            if (selectedApis.size === 0) return;

            document.getElementById('running-modal').classList.add('active');
            document.getElementById('running-status').textContent = `Running ${selectedApis.size} API(s)...`;

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiIds: Array.from(selectedApis) })
                });

                const data = await response.json();

                document.getElementById('running-modal').classList.remove('active');

                if (data.success) {
                    const passed = data.report.passed;
                    const failed = data.report.failed;
                    showToast(`Tests complete: ${passed} passed, ${failed} failed`);

                    selectedApis.clear();
                    loadSections();

                    // Switch to reports tab
                    document.querySelector('.tab[data-tab="reports"]').click();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                document.getElementById('running-modal').classList.remove('active');
                showToast('Failed to run tests: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // Reports
        // =============================================================================

        async function openAllureReport() {
            try {
                // First, try to generate the Allure report
                const response = await fetch('/api/allure/generate', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    // Open the Allure report in a new tab
                    window.open(data.reportUrl, '_blank');
                } else {
                    showToast(data.error || 'Failed to generate Allure report', 'error');
                }
            } catch (error) {
                showToast('Failed to open Allure report: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // Create API Page Functions
        // =============================================================================

        let pageEditingApiId = null;
        let pageCustomRules = [];
        let pageAvailableFields = [];
        let pageLastResponse = null;
        let pageRulesValidated = false;

        function setupPageFormListeners() {
            // Add event listeners for form validation
            document.getElementById('page-api-name').addEventListener('input', updatePageStatus);
            document.getElementById('page-api-section').addEventListener('change', updatePageStatus);
            document.getElementById('page-curl').addEventListener('input', updatePageStatus);
        }

        // Initialize form listeners once
        document.addEventListener('DOMContentLoaded', setupPageFormListeners);

        function openCreateApiPage() {
            // Close any open modals first
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));

            pageEditingApiId = null;
            pageCustomRules = [];
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            // Safe element updates
            const title = document.getElementById('create-api-title');
            const nameInput = document.getElementById('page-api-name');
            const curlInput = document.getElementById('page-curl');
            const saveBtn = document.getElementById('page-save-btn');
            const responseMeta = document.getElementById('page-response-meta');
            const responseJson = document.getElementById('page-response-json');
            const fieldsCount = document.getElementById('page-fields-count');
            const fieldsListRight = document.getElementById('page-fields-list-right');
            const fieldList = document.getElementById('page-field-list');
            const fieldSearch = document.getElementById('page-field-search');
            const fieldSearchRight = document.getElementById('page-field-search-right');

            if (title) title.textContent = 'Create New API';
            if (nameInput) nameInput.value = '';
            if (curlInput) curlInput.value = '';
            if (saveBtn) saveBtn.disabled = true;

            // Reset response panel
            if (responseMeta) responseMeta.innerHTML = '<span class="meta-badge neutral">No response yet</span>';
            if (responseJson) {
                responseJson.textContent = 'Execute cURL to see response';
                responseJson.classList.add('empty');
            }
            if (fieldsCount) fieldsCount.textContent = '0';
            if (fieldsListRight) fieldsListRight.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields extracted yet</span>';
            if (fieldList) fieldList.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">Execute cURL to see fields</div>';
            if (fieldSearch) fieldSearch.value = '';
            if (fieldSearchRight) fieldSearchRight.value = '';

            // Reset rules
            renderPageRules();
            updatePageStatus();

            // Populate section dropdown
            populatePageSectionDropdown();

            // Initialize new rule builder
            initNewRuleBuilder();

            // Switch to Create API tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="create-api"]').classList.add('active');
            document.getElementById('create-api').classList.add('active');
        }

        function openEditApiPage(apiId) {
            let api, sectionId;
            for (const section of sections) {
                const found = section.apis.find(a => a.id === apiId);
                if (found) {
                    api = found;
                    sectionId = section.id;
                    break;
                }
            }
            if (!api) return;

            pageEditingApiId = apiId;
            pageCustomRules = api.customRules ? JSON.parse(JSON.stringify(api.customRules)) : [];
            pageAvailableFields = [];
            pageLastResponse = null;
            pageRulesValidated = false;

            document.getElementById('create-api-title').textContent = `Edit: ${api.name}`;
            document.getElementById('page-api-name').value = api.name;
            document.getElementById('page-curl').value = api.curl;
            document.getElementById('page-save-btn').disabled = true;

            // Reset response panel
            document.getElementById('page-response-meta').innerHTML = '<span class="meta-badge neutral">Execute to refresh</span>';
            document.getElementById('page-response-json').textContent = 'Execute cURL to see response';
            document.getElementById('page-response-json').classList.add('empty');
            document.getElementById('page-fields-count').textContent = '0';
            document.getElementById('page-fields-list-right').innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">Execute cURL to refresh fields</span>';
            document.getElementById('page-field-list').innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">Execute cURL to see fields</div>';

            // Populate section dropdown
            populatePageSectionDropdown();
            document.getElementById('page-api-section').value = sectionId;

            // Render existing rules
            renderPageRules();
            updatePageStatus();

            // Initialize new rule builder
            initNewRuleBuilder();

            // Switch to Create API tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="create-api"]').classList.add('active');
            document.getElementById('create-api').classList.add('active');
        }

        function populatePageSectionDropdown() {
            const select = document.getElementById('page-api-section');
            if (sections.length === 0) {
                select.innerHTML = '<option value="">-- No modules yet --</option>';
            } else {
                select.innerHTML = sections.map(s =>
                    `<option value="${s.id}">${escapeHtml(s.name)}</option>`
                ).join('');
                if (currentSectionId) {
                    select.value = currentSectionId;
                }
            }
        }

        function openAddModuleInline() {
            document.getElementById('inline-add-module').style.display = 'block';
            document.getElementById('inline-module-name').value = '';
            document.getElementById('inline-module-name').focus();
        }

        function cancelInlineModule() {
            document.getElementById('inline-add-module').style.display = 'none';
            document.getElementById('inline-module-name').value = '';
        }

        async function saveInlineModule() {
            const name = document.getElementById('inline-module-name').value.trim();
            if (!name) {
                showToast('Module name is required', 'error');
                return;
            }

            // Check for duplicate
            if (sections.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                showToast('Module name already exists', 'error');
                return;
            }

            try {
                const response = await fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();
                if (data.success) {
                    sections.push(data.section);
                    populatePageSectionDropdown();
                    document.getElementById('page-api-section').value = data.section.id;
                    cancelInlineModule();
                    showToast('Module created successfully');

                    // Also update main sections list
                    renderSections();
                } else {
                    showToast(data.error || 'Failed to create module', 'error');
                }
            } catch (error) {
                showToast('Failed to create module: ' + error.message, 'error');
            }
        }

        function cancelCreateApi() {
            // Switch back to Saved APIs tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="saved-apis"]').classList.add('active');
            document.getElementById('saved-apis').classList.add('active');
        }

        async function executePageCurl() {
            const curlInput = document.getElementById('page-curl');
            if (!curlInput) {
                showToast('Page not initialized properly', 'error');
                return;
            }

            const curl = curlInput.value.trim();
            if (!curl) {
                showToast('Please enter a cURL command', 'error');
                return;
            }

            const btn = document.getElementById('page-execute-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Executing...';
            }

            try {
                const response = await fetch('/api/execute-curl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl })
                });

                const data = await response.json();

                if (data.success) {
                    pageLastResponse = data.response;
                    pageAvailableFields = data.fields || [];

                    // Update response meta
                    const statusClass = data.status_code >= 200 && data.status_code < 300 ? 'status-ok' : 'status-error';
                    const responseMeta = document.getElementById('page-response-meta');
                    if (responseMeta) {
                        responseMeta.innerHTML = `
                            <span class="meta-badge ${statusClass}">Status: ${data.status_code}</span>
                            <span class="meta-badge neutral">${data.response_time_ms}ms</span>
                        `;
                    }

                    // Update response JSON
                    const jsonDiv = document.getElementById('page-response-json');
                    if (jsonDiv) {
                        jsonDiv.classList.remove('empty');
                        if (data.response) {
                            jsonDiv.textContent = JSON.stringify(data.response, null, 2);
                        } else {
                            jsonDiv.textContent = data.response_text || 'No JSON response';
                        }
                    }

                    // Update fields count and list
                    const fieldsCount = document.getElementById('page-fields-count');
                    if (fieldsCount) {
                        fieldsCount.textContent = pageAvailableFields.length;
                    }
                    renderPageFieldsList();

                    // Add default status_code rule if no rules exist
                    if (pageCustomRules.length === 0) {
                        quickAddRule('status_code');
                    }

                    pageRulesValidated = false;
                    const saveBtn = document.getElementById('page-save-btn');
                    if (saveBtn) {
                        saveBtn.disabled = true;
                    }

                    updatePageStatus();
                    showToast('Response parsed successfully');
                } else {
                    showToast(data.error || 'Failed to execute cURL', 'error');
                }
            } catch (error) {
                console.error('executePageCurl error:', error);
                showToast('Failed to execute cURL: ' + error.message, 'error');
            }

            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Execute & Parse Response';
            }
        }

        function renderPageFieldsList() {
            // Left panel field list
            const leftList = document.getElementById('page-field-list');
            if (pageAvailableFields.length === 0) {
                leftList.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No fields found</div>';
            } else {
                leftList.innerHTML = pageAvailableFields.map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('');
            }

            // Right panel field list
            const rightList = document.getElementById('page-fields-list-right');
            if (pageAvailableFields.length === 0) {
                rightList.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields found</span>';
            } else {
                rightList.innerHTML = pageAvailableFields.slice(0, 20).map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('') + (pageAvailableFields.length > 20 ? `<div class="field-item" style="color: #7f8c8d;">... and ${pageAvailableFields.length - 20} more</div>` : '');
            }
        }

        function addRuleForField(field) {
            // Pre-select field_exists type in the new rule builder
            const typeSelect = document.getElementById('new-rule-type');
            if (typeSelect) {
                typeSelect.value = 'field_exists';
                onNewRuleTypeChange();
            }

            // Set the field in the field selector
            selectNewRuleField(field);

            // Scroll to the new rule builder
            const builder = document.getElementById('new-rule-builder');
            if (builder) {
                builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
                builder.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.5)';
                setTimeout(() => {
                    builder.style.boxShadow = '';
                }, 1500);
            }

            showToast(`Configure rule for "${field}" and click "Test Rule"`);
        }

        function quickAddRule(ruleType) {
            // Pre-select the rule type in the new rule builder
            const typeSelect = document.getElementById('new-rule-type');
            if (typeSelect) {
                typeSelect.value = ruleType;
                onNewRuleTypeChange();
            }

            // Scroll to the new rule builder
            const builder = document.getElementById('new-rule-builder');
            if (builder) {
                builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
                builder.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.5)';
                setTimeout(() => {
                    builder.style.boxShadow = '';
                }, 1500);
            }

            showToast(`Configure ${ruleTypes[ruleType]?.name || ruleType} and click "Test Rule"`);
        }

        async function autoValidateSingleRule(rule) {
            const curl = document.getElementById('page-curl').value.trim();
            if (!curl) return;

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: curl,
                        rules: [rule]
                    })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    const result = data.results[0];
                    const card = document.getElementById(`page-rule-${rule.id}`);
                    if (card) {
                        card.classList.remove('valid', 'invalid');
                        card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                        let resultDiv = card.querySelector('.validation-result');
                        if (!resultDiv) {
                            resultDiv = document.createElement('div');
                            resultDiv.className = 'validation-result';
                            card.appendChild(resultDiv);
                        }
                        resultDiv.className = `validation-result ${result.result.toLowerCase()}`;
                        resultDiv.innerHTML = result.result === 'PASS' ?
                            `‚úì PASS - Expected: ${result.expected}, Actual: ${result.actual}` :
                            `‚úó FAIL - ${result.reason}`;
                    }

                    // Check if all rules are now validated and passing
                    checkAllRulesValidated();
                }
            } catch (error) {
                console.error('Auto-validation failed:', error);
            }
        }

        async function checkAllRulesValidated() {
            // Re-validate all rules to update the overall status
            if (pageCustomRules.length === 0) {
                pageRulesValidated = false;
                updatePageStatus();
                return;
            }

            const curl = document.getElementById('page-curl').value.trim();
            if (!curl) return;

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: curl,
                        rules: pageCustomRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const allPassed = data.results.every(r => r.result === 'PASS');
                    pageRulesValidated = allPassed;

                    updatePageStatus();
                }
            } catch (error) {
                console.error('Validation check failed:', error);
            }
        }

        async function addPageRule() {
            await quickAddRule('field_exists');
        }

        function removePageRule(ruleId) {
            pageCustomRules = pageCustomRules.filter(r => r.id !== ruleId);
            pageRulesValidated = false;
            renderPageRules();
            updatePageStatus();
        }

        function updatePageRule(ruleId, field, value) {
            const rule = pageCustomRules.find(r => r.id === ruleId);
            if (!rule) return;

            if (field === 'type') {
                rule.type = value;
                rule.config = {};
                const typeConfig = ruleTypes[value];
                if (typeConfig && typeConfig.configFields) {
                    typeConfig.configFields.forEach(cf => {
                        if (cf.default !== undefined) {
                            rule.config[cf.name] = cf.default;
                        }
                    });
                }
                if (typeConfig && !typeConfig.requiresField) {
                    rule.field = '';
                } else if (!rule.field && pageAvailableFields.length > 0) {
                    rule.field = pageAvailableFields[0];
                }
            } else if (field === 'field') {
                rule.field = value;
            } else {
                rule.config[field] = value;
            }

            pageRulesValidated = false;
            renderPageRules();
            updatePageStatus();
        }

        function renderPageRules() {
            const container = document.getElementById('page-rules-list');
            document.getElementById('page-rules-count').textContent = `(${pageCustomRules.length})`;

            if (pageCustomRules.length === 0) {
                container.innerHTML = `
                    <div class="empty-rules-full">
                        <p>No test rules yet</p>
                        <span>Execute cURL first, then add rules using the quick actions or the "+ Add Rule" button</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = pageCustomRules.map((rule, index) => {
                const typeConfig = ruleTypes[rule.type] || {};
                const requiresField = typeConfig.requiresField !== false;

                return `
                    <div class="rule-card-full" id="page-rule-${rule.id}">
                        <div class="rule-header">
                            <div class="rule-title">
                                <span>Rule ${index + 1}</span>
                                <span style="font-size: 11px; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; color: #666;">${typeConfig.ruleType || 'functional'}</span>
                            </div>
                            <button class="btn-icon" onclick="removePageRule('${rule.id}')" title="Remove">üóëÔ∏è</button>
                        </div>
                        <div class="rule-fields">
                            <div>
                                <label>Rule Type</label>
                                <select onchange="updatePageRule('${rule.id}', 'type', this.value)">
                                    ${Object.entries(ruleTypes).map(([key, config]) =>
                                        `<option value="${key}" ${rule.type === key ? 'selected' : ''}>${config.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ${requiresField ? `
                            <div>
                                <label>Field</label>
                                <select onchange="updatePageRule('${rule.id}', 'field', this.value)">
                                    ${pageAvailableFields.map(f =>
                                        `<option value="${f}" ${rule.field === f ? 'selected' : ''}>${f}</option>`
                                    ).join('')}
                                    ${rule.field && !pageAvailableFields.includes(rule.field) ?
                                        `<option value="${rule.field}" selected>${rule.field}</option>` : ''}
                                </select>
                            </div>
                            ` : ''}
                            ${renderPageConfigFields(rule)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPageConfigFields(rule) {
            const typeConfig = ruleTypes[rule.type];
            if (!typeConfig || !typeConfig.configFields || typeConfig.configFields.length === 0) {
                return '';
            }

            return typeConfig.configFields.map(cf => {
                const value = rule.config[cf.name] !== undefined ? rule.config[cf.name] : cf.default;

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updatePageRule('${rule.id}', '${cf.name}', this.value)">
                                ${cf.options.map(opt =>
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <select onchange="updatePageRule('${rule.id}', '${cf.name}', this.value === 'true')">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="number" value="${value}" onchange="updatePageRule('${rule.id}', '${cf.name}', parseInt(this.value) || 0)">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label>${cf.label}</label>
                            <input type="text" value="${escapeHtml(value || '')}" onchange="updatePageRule('${rule.id}', '${cf.name}', this.value)">
                        </div>
                    `;
                }
            }).join('');
        }

        async function validatePageRules() {
            if (pageCustomRules.length === 0) {
                showToast('Add at least one rule first', 'error');
                return;
            }

            const btn = document.getElementById('page-validate-btn');
            btn.disabled = true;
            btn.textContent = 'Validating...';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        curl: document.getElementById('page-curl').value.trim(),
                        rules: pageCustomRules
                    })
                });

                const data = await response.json();

                if (data.success) {
                    data.results.forEach(result => {
                        const card = document.getElementById(`page-rule-${result.rule_id}`);
                        if (card) {
                            card.classList.remove('valid', 'invalid');
                            card.classList.add(result.result === 'PASS' ? 'valid' : 'invalid');

                            // Add validation result
                            let resultDiv = card.querySelector('.validation-result');
                            if (!resultDiv) {
                                resultDiv = document.createElement('div');
                                resultDiv.className = 'validation-result';
                                card.appendChild(resultDiv);
                            }
                            resultDiv.className = `validation-result ${result.result.toLowerCase()}`;
                            resultDiv.innerHTML = result.result === 'PASS' ?
                                `‚úì PASS - Expected: ${result.expected}, Actual: ${result.actual}` :
                                `‚úó FAIL - ${result.reason}`;
                        }
                    });

                    const allPassed = data.results.every(r => r.result === 'PASS');
                    pageRulesValidated = allPassed;

                    document.getElementById('page-save-btn').disabled = !allPassed;
                    updatePageStatus();

                    showToast(allPassed ? 'All rules validated!' : 'Some rules failed - fix them to save');
                } else {
                    showToast(data.error || 'Validation failed', 'error');
                }
            } catch (error) {
                showToast('Validation failed: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Validate All Rules';
        }

        function updatePageStatus() {
            const rulesStatus = document.getElementById('page-status-rules');
            const validatedStatus = document.getElementById('page-status-validated');
            const message = document.getElementById('page-status-message');
            const saveBtn = document.getElementById('page-save-btn');

            // Check if we're on the Create API page
            if (!rulesStatus || !validatedStatus || !message || !saveBtn) {
                return; // Elements not available, skip update
            }

            const nameInput = document.getElementById('page-api-name');
            const curlInput = document.getElementById('page-curl');
            const sectionInput = document.getElementById('page-api-section');

            const name = nameInput ? nameInput.value.trim() : '';
            const curl = curlInput ? curlInput.value.trim() : '';
            const sectionId = sectionInput ? sectionInput.value : '';

            rulesStatus.innerHTML = `<span>Rules: ${pageCustomRules.length}</span>`;

            // Check all conditions for enabling save
            const hasName = name.length > 0;
            const hasCurl = curl.length > 0;
            const hasSection = sectionId && sectionId.length > 0;
            const hasRules = pageCustomRules.length > 0;

            // Rules are valid if all have been auto-validated and passed
            const allRulesPassed = hasRules && pageRulesValidated;

            const canSave = hasName && hasCurl && hasSection && hasRules && allRulesPassed;
            saveBtn.disabled = !canSave;

            // Update status display
            if (!hasName) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'API name is required';
            } else if (!hasSection) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'Select a module';
            } else if (!hasCurl) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Missing info</span>';
                message.textContent = 'Enter cURL command';
            } else if (!hasRules) {
                validatedStatus.className = 'status-item';
                validatedStatus.innerHTML = '<span>No rules</span>';
                message.textContent = 'Add at least one test rule';
            } else if (!allRulesPassed) {
                validatedStatus.className = 'status-item fail';
                validatedStatus.innerHTML = '<span>Rules failing</span>';
                message.textContent = 'Fix failing rules to save';
            } else {
                validatedStatus.className = 'status-item pass';
                validatedStatus.innerHTML = '<span>‚úì Ready</span>';
                message.textContent = 'All checks passed - ready to save';
            }
        }

        function filterPageFields() {
            const search = document.getElementById('page-field-search').value.toLowerCase();
            const container = document.getElementById('page-field-list');

            if (pageAvailableFields.length === 0) {
                container.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No fields found</div>';
                return;
            }

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                container.innerHTML = '<div class="field-item" style="color: #7f8c8d; cursor: default;">No matching fields</div>';
            } else {
                container.innerHTML = filtered.map(f =>
                    `<div class="field-item" onclick="addRuleForField('${f}')">${f}</div>`
                ).join('');
            }
        }

        function filterPageFieldsRight() {
            const search = document.getElementById('page-field-search-right').value.toLowerCase();
            const container = document.getElementById('page-fields-list-right');

            if (pageAvailableFields.length === 0) {
                container.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No fields found</span>';
                return;
            }

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                container.innerHTML = '<span style="color: #7f8c8d; font-size: 12px;">No matching fields</span>';
            } else {
                container.innerHTML = filtered.slice(0, 30).map(f =>
                    `<div class="field-item" onclick="selectFieldForNewRule('${f}')">${f}</div>`
                ).join('') + (filtered.length > 30 ? `<div class="field-item" style="color: #7f8c8d;">... ${filtered.length - 30} more</div>` : '');
            }
        }

        // =============================================================================
        // New Rule Builder Functions
        // =============================================================================

        let newRuleTested = false;
        let newRuleTestResult = null;

        async function initNewRuleBuilder() {
            // Wait for rule types to load if not yet available
            if (Object.keys(ruleTypes).length === 0) {
                await loadRuleTypes();
            }

            // Populate rule type dropdown
            const typeSelect = document.getElementById('new-rule-type');
            const ruleTypeEntries = Object.entries(ruleTypes);

            if (ruleTypeEntries.length === 0) {
                typeSelect.innerHTML = '<option value="">No rule types available</option>';
                console.error('No rule types loaded');
                return;
            }

            // Add placeholder option first, then rule types
            typeSelect.innerHTML = '<option value="">-- Select Rule Type --</option>' +
                ruleTypeEntries.map(([key, config]) =>
                    `<option value="${key}">${config.name}</option>`
                ).join('');

            // Keep placeholder selected initially
            typeSelect.selectedIndex = 0;

            // Initialize field container (hide it until rule type selected)
            document.getElementById('new-rule-field-container').style.display = 'none';
            document.getElementById('new-rule-config-container').innerHTML = '';

            // Reset test state
            resetNewRuleTest();
        }

        function onNewRuleTypeChange() {
            const ruleType = document.getElementById('new-rule-type').value;
            const fieldContainer = document.getElementById('new-rule-field-container');
            const configContainer = document.getElementById('new-rule-config-container');

            // If no rule type selected (placeholder), hide everything
            if (!ruleType) {
                fieldContainer.style.display = 'none';
                configContainer.innerHTML = '';
                resetNewRuleTest();
                return;
            }

            const typeConfig = ruleTypes[ruleType] || {};

            // Show/hide field selector based on rule type
            if (typeConfig.requiresField === false) {
                fieldContainer.style.display = 'none';
            } else {
                fieldContainer.style.display = 'block';
                populateNewRuleFieldDropdown();
            }

            // Populate config fields
            renderNewRuleConfigFields(ruleType, typeConfig);

            // Reset test state
            resetNewRuleTest();
        }

        function populateNewRuleFieldDropdown() {
            const dropdown = document.getElementById('new-rule-field-dropdown');
            const search = document.getElementById('new-rule-field-search').value.toLowerCase();

            const filtered = pageAvailableFields.filter(f => f.toLowerCase().includes(search));

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 8px; color: #7f8c8d; font-size: 12px;">No fields found</div>';
            } else {
                dropdown.innerHTML = filtered.map(f =>
                    `<div class="field-dropdown-item" onclick="selectNewRuleField('${f}')" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;"
                        onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">${f}</div>`
                ).join('');
            }
        }

        function showFieldDropdown() {
            const dropdown = document.getElementById('new-rule-field-dropdown');
            populateNewRuleFieldDropdown();
            dropdown.style.display = 'block';
        }

        function hideFieldDropdown() {
            setTimeout(() => {
                document.getElementById('new-rule-field-dropdown').style.display = 'none';
            }, 200);
        }

        function selectNewRuleField(field) {
            document.getElementById('new-rule-field').value = field;
            document.getElementById('new-rule-field-search').value = field;
            document.getElementById('new-rule-field-dropdown').style.display = 'none';
            resetNewRuleTest();
        }

        function filterNewRuleFields() {
            populateNewRuleFieldDropdown();
            document.getElementById('new-rule-field').value = '';
            resetNewRuleTest();
        }

        function selectFieldForNewRule(field) {
            selectNewRuleField(field);
        }

        function renderNewRuleConfigFields(ruleType, typeConfig) {
            const container = document.getElementById('new-rule-config-container');

            if (!typeConfig.configFields || typeConfig.configFields.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = typeConfig.configFields.map(cf => {
                const value = cf.default !== undefined ? cf.default : '';

                if (cf.type === 'select') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <select id="new-rule-config-${cf.name}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                ${cf.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'boolean') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <select id="new-rule-config-${cf.name}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                <option value="false" ${value === false ? 'selected' : ''}>false</option>
                            </select>
                        </div>
                    `;
                } else if (cf.type === 'number') {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <input type="number" id="new-rule-config-${cf.name}" value="${value}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase;">${cf.label}</label>
                            <input type="text" id="new-rule-config-${cf.name}" value="${value}" onchange="resetNewRuleTest()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                }
            }).join('');
        }

        function resetNewRuleTest() {
            newRuleTested = false;
            newRuleTestResult = null;
            document.getElementById('add-rule-btn').disabled = true;
            document.getElementById('new-rule-test-result').textContent = '';
            document.getElementById('new-rule-test-result').style.color = '#7f8c8d';
        }

        function buildNewRuleObject() {
            const typeSelect = document.getElementById('new-rule-type');
            let ruleType = typeSelect.value;

            // Fallback if no rule type selected
            if (!ruleType && typeSelect.options.length > 0) {
                ruleType = typeSelect.options[0].value;
                typeSelect.selectedIndex = 0;
            }

            if (!ruleType) {
                console.error('No rule type available');
                return null;
            }

            const typeConfig = ruleTypes[ruleType] || {};
            const field = typeConfig.requiresField !== false ? document.getElementById('new-rule-field').value : '';

            const config = {};
            if (typeConfig.configFields) {
                typeConfig.configFields.forEach(cf => {
                    const el = document.getElementById(`new-rule-config-${cf.name}`);
                    if (el) {
                        let val = el.value;
                        if (cf.type === 'number') val = parseInt(val) || 0;
                        if (cf.type === 'boolean') val = val === 'true';
                        config[cf.name] = val;
                    }
                });
            }

            return {
                id: 'rule-' + Math.random().toString(36).substr(2, 9),
                type: ruleType,
                field: field,
                config: config,
                enabled: true
            };
        }

        async function testNewRule() {
            const curl = document.getElementById('page-curl').value.trim();
            if (!curl) {
                showToast('Execute cURL first', 'error');
                return;
            }

            const typeSelect = document.getElementById('new-rule-type');
            const ruleType = typeSelect.value;

            if (!ruleType) {
                showToast('Please select a rule type', 'error');
                return;
            }

            const typeConfig = ruleTypes[ruleType] || {};

            // Validate field is selected if required
            if (typeConfig.requiresField !== false) {
                const field = document.getElementById('new-rule-field').value;
                if (!field) {
                    showToast('Please select a field', 'error');
                    return;
                }
            }

            const rule = buildNewRuleObject();
            const btn = document.getElementById('test-new-rule-btn');
            const resultSpan = document.getElementById('new-rule-test-result');

            btn.disabled = true;
            btn.textContent = 'Testing...';
            resultSpan.textContent = '';

            try {
                const response = await fetch('/api/test-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curl, rules: [rule] })
                });

                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    const result = data.results[0];
                    newRuleTested = true;
                    newRuleTestResult = result;

                    if (result.result === 'PASS') {
                        resultSpan.innerHTML = `‚úì PASS - Expected: ${result.expected}, Actual: ${result.actual}`;
                        resultSpan.style.color = '#27ae60';
                        document.getElementById('add-rule-btn').disabled = false;
                        showToast('Rule test passed! Click "Add Rule" to save it.');
                    } else {
                        resultSpan.innerHTML = `‚úó FAIL - ${result.reason}`;
                        resultSpan.style.color = '#e74c3c';
                        document.getElementById('add-rule-btn').disabled = true;
                        showToast('Rule test failed. Fix the rule and try again.', 'error');
                    }
                } else {
                    resultSpan.textContent = 'Test failed';
                    resultSpan.style.color = '#e74c3c';
                }
            } catch (error) {
                resultSpan.textContent = 'Test error: ' + error.message;
                resultSpan.style.color = '#e74c3c';
            }

            btn.disabled = false;
            btn.textContent = 'Test Rule';
        }

        function addTestedRule() {
            if (!newRuleTested || !newRuleTestResult || newRuleTestResult.result !== 'PASS') {
                showToast('Test the rule first', 'error');
                return;
            }

            const rule = buildNewRuleObject();
            if (!rule) {
                showToast('Failed to create rule - no rule type selected', 'error');
                return;
            }

            rule.testResult = newRuleTestResult; // Store test result with rule

            pageCustomRules.push(rule);
            pageRulesValidated = true; // All added rules are pre-tested

            renderPageRules();
            updatePageStatus();
            resetNewRuleBuilder();

            showToast('Rule added successfully!');
        }

        function resetNewRuleBuilder() {
            // Reset to default state
            document.getElementById('new-rule-type').selectedIndex = 0;
            document.getElementById('new-rule-field-search').value = '';
            onNewRuleTypeChange();
            resetNewRuleTest();
        }

        // Check for duplicate API name in section
        function checkDuplicateName(name, sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return false;

            return section.apis.some(api =>
                api.name.toLowerCase() === name.toLowerCase() &&
                api.id !== pageEditingApiId
            );
        }

        // Check for duplicate cURL command
        function checkDuplicateCurl(curl) {
            for (const section of sections) {
                for (const api of section.apis) {
                    if (api.curl === curl && api.id !== pageEditingApiId) {
                        return { exists: true, apiName: api.name, sectionName: section.name };
                    }
                }
            }
            return { exists: false };
        }

        async function saveApiFromPage() {
            const sectionId = document.getElementById('page-api-section').value;
            const name = document.getElementById('page-api-name').value.trim();
            const curl = document.getElementById('page-curl').value.trim();

            // Validate required fields
            if (!name) {
                showToast('API name is required', 'error');
                return;
            }
            if (!sectionId) {
                showToast('Please select a module', 'error');
                return;
            }
            if (!curl) {
                showToast('cURL command is required', 'error');
                return;
            }
            if (pageCustomRules.length === 0) {
                showToast('Add at least one test rule', 'error');
                return;
            }
            if (!pageRulesValidated) {
                showToast('All rules must pass before saving', 'error');
                return;
            }

            // Check for duplicate API name in section
            if (checkDuplicateName(name, sectionId)) {
                showToast(`API name "${name}" already exists in this module`, 'error');
                return;
            }

            // Check for duplicate cURL
            const curlCheck = checkDuplicateCurl(curl);
            if (curlCheck.exists) {
                showToast(`This cURL is already used by "${curlCheck.apiName}" in ${curlCheck.sectionName}`, 'error');
                return;
            }

            const apiData = {
                name,
                curl,
                customRules: pageCustomRules
            };

            try {
                let response;
                if (pageEditingApiId) {
                    response = await fetch(`/api/apis/${pageEditingApiId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });

                    // Check if section changed
                    let currentSection;
                    for (const section of sections) {
                        if (section.apis.find(a => a.id === pageEditingApiId)) {
                            currentSection = section.id;
                            break;
                        }
                    }

                    if (currentSection !== sectionId) {
                        await fetch(`/api/apis/${pageEditingApiId}/move`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetSectionId: sectionId })
                        });
                    }
                } else {
                    response = await fetch(`/api/sections/${sectionId}/apis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(pageEditingApiId ?
                        `API updated with ${pageCustomRules.length} rules` :
                        `API created with ${pageCustomRules.length} rules`);

                    // Reload sections and switch to Saved APIs tab
                    await loadSections();
                    cancelCreateApi();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to save API', 'error');
            }
        }

        // =============================================================================
        // Reports Functions
        // =============================================================================

        async function loadReports() {
            const container = document.getElementById('reports-list');
            const sectionFilter = document.getElementById('filter-section').value;
            const resultFilter = document.getElementById('filter-result').value;

            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading reports...</span></div>';

            try {
                let url = '/api/reports';
                const params = new URLSearchParams();
                if (sectionFilter) params.append('section', sectionFilter);
                if (resultFilter) params.append('result', resultFilter);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderReports(data.reports);
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>Failed to load reports</p></div>';
            }
        }

        function renderReports(reports) {
            const container = document.getElementById('reports-list');

            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No reports yet</h3>
                        <p>Run some API tests to see reports here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map(report => {
                // Group results by module (section)
                const moduleGroups = {};
                report.results.forEach(result => {
                    const moduleName = result.section || 'Unknown';
                    if (!moduleGroups[moduleName]) {
                        moduleGroups[moduleName] = { passed: 0, failed: 0, apis: [] };
                    }
                    moduleGroups[moduleName].apis.push(result);
                    if (result.result === 'PASS') {
                        moduleGroups[moduleName].passed++;
                    } else {
                        moduleGroups[moduleName].failed++;
                    }
                });

                return `
                <div class="report-card">
                    <div class="report-header" onclick="toggleReportDetails('${report.runId}')">
                        <div class="report-info">
                            <h4>Test Run: ${report.runId}</h4>
                            <span class="report-meta">${formatDate(report.date)} ‚Ä¢ ${report.totalApis} APIs ‚Ä¢ ${Object.keys(moduleGroups).length} Modules</span>
                        </div>
                        <div class="report-stats">
                            <div class="stat">
                                <div class="stat-value pass">${report.passed}</div>
                                <div class="stat-label">Passed</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value fail">${report.failed}</div>
                                <div class="stat-label">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="report-details" id="details-${report.runId}">
                        ${Object.entries(moduleGroups).map(([moduleName, moduleData]) => `
                            <div class="module-group">
                                <div class="module-header" onclick="event.stopPropagation(); toggleModule('${report.runId}-${moduleName.replace(/\s+/g, '-')}')">
                                    <h4>${escapeHtml(moduleName)}</h4>
                                    <div class="module-stats">
                                        <span class="module-stat pass">${moduleData.passed} passed</span>
                                        <span class="module-stat fail">${moduleData.failed} failed</span>
                                    </div>
                                </div>
                                <div class="module-apis" id="module-${report.runId}-${moduleName.replace(/\s+/g, '-')}">
                                    ${moduleData.apis.map(api => {
                                        const passedTests = (api.ruleResults || []).filter(r => r.result === 'PASS').length;
                                        const failedTests = (api.ruleResults || []).filter(r => r.result === 'FAIL').length;
                                        const totalTests = (api.ruleResults || []).length;
                                        return `
                                        <div class="api-report-item">
                                            <div class="api-report-header" onclick="event.stopPropagation(); toggleApiDetails('${report.runId}-${api.apiId}')">
                                                <div class="api-report-info">
                                                    <h5>${escapeHtml(api.apiName)}</h5>
                                                    <span class="api-report-meta">
                                                        Status: ${api.statusCode || '-'} ‚Ä¢
                                                        Time: ${api.executionTime} ‚Ä¢
                                                        Tests: <span class="test-count pass">${passedTests} passed</span> / <span class="test-count fail">${failedTests} failed</span>
                                                    </span>
                                                </div>
                                                <div class="api-report-badges">
                                                    <span class="status-badge ${api.result.toLowerCase()}">${api.result}</span>
                                                </div>
                                            </div>
                                            <div class="api-report-details expanded" id="api-details-${report.runId}-${api.apiId}">
                                                <h6 class="test-cases-title">Test Cases (${totalTests})</h6>
                                                <div class="test-cases-list">
                                                    ${(api.ruleResults || []).map(rule => `
                                                        <div class="test-case-item ${rule.result.toLowerCase()}">
                                                            <div class="test-case-header">
                                                                <span class="test-case-icon">${rule.result === 'PASS' ? '‚úì' : '‚úó'}</span>
                                                                <span class="test-case-name">${escapeHtml(rule.rule_name)}</span>
                                                                <span class="test-case-type">${rule.rule_type || ''}</span>
                                                            </div>
                                                            <div class="test-case-details">
                                                                <div class="test-case-row">
                                                                    <span class="label">Expected:</span>
                                                                    <span class="value expected">${escapeHtml(rule.expected || '-')}</span>
                                                                </div>
                                                                <div class="test-case-row">
                                                                    <span class="label">Actual:</span>
                                                                    <span class="value actual ${rule.result === 'FAIL' ? 'fail' : ''}">${escapeHtml(rule.actual || '-')}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `).join('')}
                        <div class="report-actions">
                            ${report.failed > 0 ? `<button class="btn btn-secondary btn-sm" onclick="rerunFailed('${report.runId}')">Re-run Failed</button>` : ''}
                            <button class="btn btn-primary btn-sm" onclick="viewReport('${report.runId}')">Web View</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport('${report.runId}')">Delete</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function toggleReportDetails(runId) {
            const details = document.getElementById(`details-${runId}`);
            details.classList.toggle('expanded');
        }

        function toggleModule(moduleId) {
            const moduleApis = document.getElementById(`module-${moduleId}`);
            moduleApis.classList.toggle('expanded');
        }

        function toggleApiDetails(apiId) {
            const apiDetails = document.getElementById(`api-details-${apiId}`);
            apiDetails.classList.toggle('expanded');
        }

        async function rerunFailed(runId) {
            try {
                const response = await fetch(`/api/reports/${runId}`);
                const data = await response.json();

                if (data.success) {
                    const failedIds = data.report.results
                        .filter(r => r.result === 'FAIL')
                        .map(r => r.apiId);

                    selectedApis = new Set(failedIds);
                    await runSelectedApis();
                }
            } catch (error) {
                showToast('Failed to re-run tests', 'error');
            }
        }

        async function viewReport(runId) {
            try {
                const response = await fetch(`/api/reports/${runId}`);
                const data = await response.json();

                if (data.success && data.report) {
                    // Use combined report if available, otherwise fall back to first API's report
                    const htmlPath = data.report.htmlReport || data.report.results[0]?.reportPaths?.html;
                    if (htmlPath) {
                        window.open(`/output/${htmlPath}`, '_blank');
                    } else {
                        showToast('No HTML report available', 'error');
                    }
                }
            } catch (error) {
                showToast('Failed to open report', 'error');
            }
        }

        async function deleteReport(runId) {
            if (!confirm('Delete this report?')) return;

            try {
                const response = await fetch(`/api/reports/${runId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showToast('Report deleted');
                    loadReports();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to delete report', 'error');
            }
        }

        // =============================================================================
        // Utilities
        // =============================================================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }
    </script>
</body>
</html>
